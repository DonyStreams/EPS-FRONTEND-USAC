<div class="grid">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <!-- Título y descripción -->
    <div class="col-12">
        <div class="card">
            <h5>Ejecuciones de Mantenimiento</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Gestione y dé seguimiento a las ejecuciones de mantenimientos 
                programados, en proceso y completados.</p>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="col-12 md:col-3">
        <div class="card bg-orange-100 border-left-3 border-orange-500 cursor-pointer" (click)="setFiltroEstado('PROGRAMADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-orange-600 font-medium">Programados</span>
                    <div class="text-2xl font-bold text-orange-900">{{countProgramados}}</div>
                    <small *ngIf="countVencidas > 0" class="text-red-600 font-medium">
                        <i class="pi pi-exclamation-triangle mr-1"></i>{{countVencidas}} vencidas
                    </small>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-calendar text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-blue-100 border-left-3 border-blue-500 cursor-pointer" (click)="setFiltroEstado('EN_PROCESO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-blue-600 font-medium">En Proceso</span>
                    <div class="text-2xl font-bold text-blue-900">{{countEnProceso}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-spinner text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-green-100 border-left-3 border-green-500 cursor-pointer" (click)="setFiltroEstado('COMPLETADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-green-600 font-medium">Completados</span>
                    <div class="text-2xl font-bold text-green-900">{{countCompletados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-green-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-check-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-red-100 border-left-3 border-red-500 cursor-pointer" (click)="setFiltroEstado('CANCELADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-red-600 font-medium">Cancelados</span>
                    <div class="text-2xl font-bold text-red-900">{{countCancelados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-red-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-times-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de ejecuciones -->
    <div class="col-12">
        <div class="card">
            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <p-dropdown [options]="estadosFiltro" 
                                [(ngModel)]="filtroEstado"
                                (onChange)="onFiltroEstadoChange()"
                                placeholder="Filtrar por estado"
                                styleClass="mr-2">
                    </p-dropdown>
                    <button pButton pRipple label="Limpiar filtro" icon="pi pi-filter-slash" 
                        class="p-button-outlined p-button-secondary mr-2"
                        (click)="setFiltroEstado('')"
                        *ngIf="filtroEstado"></button>
                </ng-template>
                <ng-template pTemplate="right">
                    <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" class="p-button-outlined"
                        routerLink="/administracion/mantenimientos"
                        pTooltip="Ver programaciones en calendario"></button>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="ejecuciones" [loading]="loading" [paginator]="true" [rows]="10"
                [rowsPerPageOptions]="[10,20,50]" [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ejecuciones"
                [globalFilterFields]="['equipoNombre','proveedorNombre','contratoDescripcion','bitacora','estado']"
                [rowHover]="true" dataKey="idEjecucion">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Registro de Ejecuciones</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                                placeholder="Buscar..." class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="fechaEjecucion">Fecha Programada <p-sortIcon field="fechaEjecucion"></p-sortIcon></th>
                        <th pSortableColumn="equipoNombre">Equipo <p-sortIcon field="equipoNombre"></p-sortIcon></th>
                        <th pSortableColumn="contratoDescripcion">Contrato <p-sortIcon field="contratoDescripcion"></p-sortIcon></th>
                        <th pSortableColumn="proveedorNombre">Proveedor <p-sortIcon field="proveedorNombre"></p-sortIcon></th>
                        <th>Fechas de Trabajo</th>
                        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                        <th style="width: 180px"></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-ejecucion>
                    <tr [class.bg-green-50]="ejecucion.estado === 'COMPLETADO'"
                        [class.bg-red-50]="ejecucion.estado === 'CANCELADO'"
                        [class.bg-orange-50]="isVencida(ejecucion)">
                        <!-- Fecha Programada -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <div>
                                    <div class="flex align-items-center gap-1">
                                        <i class="pi pi-calendar text-primary"></i>
                                        <span class="font-medium" [class.text-red-600]="isVencida(ejecucion)">
                                            {{formatDate(ejecucion.fechaEjecucion)}}
                                        </span>
                                    </div>
                                    <div class="flex align-items-center gap-1 mt-1">
                                        <p-tag *ngIf="isVencida(ejecucion)" 
                                               value="VENCIDA" severity="danger" 
                                               styleClass="text-xs"></p-tag>
                                        <span *ngIf="tieneProgramacion(ejecucion)" 
                                              class="text-xs text-blue-500"
                                              pTooltip="Creada desde programación automática">
                                            <i class="pi pi-sync"></i> Programado
                                        </span>
                                        <span *ngIf="!tieneProgramacion(ejecucion)" 
                                              class="text-xs text-gray-400"
                                              pTooltip="Creada manualmente">
                                            <i class="pi pi-user"></i> Manual
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Equipo -->
                        <td>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{ejecucion.equipoNombre || 'N/A'}}</div>
                                    <div class="text-sm text-gray-500">{{ejecucion.equipoCodigo}}</div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Contrato -->
                        <td>
                            <div>
                                <div class="font-medium">{{ejecucion.contratoDescripcion || 'N/A'}}</div>
                                <div class="text-sm text-gray-500" *ngIf="ejecucion.tipoMantenimiento">
                                    <p-tag [value]="ejecucion.tipoMantenimiento" 
                                           [severity]="getTipoSeverity(ejecucion.tipoMantenimiento)"
                                           [rounded]="true" styleClass="text-xs"></p-tag>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Proveedor -->
                        <td>
                            <span class="text-700">{{ejecucion.proveedorNombre || 'N/A'}}</span>
                        </td>
                        
                        <!-- Fechas de Trabajo -->
                        <td>
                            <div *ngIf="ejecucion.estado === 'PROGRAMADO'" class="text-orange-600">
                                <i class="pi pi-clock mr-1"></i>Pendiente de iniciar
                            </div>
                            <div *ngIf="ejecucion.estado === 'EN_PROCESO'">
                                <div class="text-blue-600 font-medium">
                                    <i class="pi pi-play mr-1"></i>Inicio: {{formatDate(ejecucion.fechaInicioTrabajo)}}
                                </div>
                                <div class="text-sm text-blue-400 mt-1">
                                    <i class="pi pi-spin pi-spinner mr-1"></i>En trabajo...
                                </div>
                            </div>
                            <div *ngIf="ejecucion.estado === 'COMPLETADO'">
                                <div class="text-green-600">
                                    <i class="pi pi-play mr-1"></i>{{formatDate(ejecucion.fechaInicioTrabajo)}}
                                </div>
                                <div class="text-green-700 font-medium">
                                    <i class="pi pi-check mr-1"></i>{{formatDate(ejecucion.fechaCierre)}}
                                </div>
                            </div>
                            <div *ngIf="ejecucion.estado === 'CANCELADO'" class="text-red-600">
                                <i class="pi pi-ban mr-1"></i>Cancelado
                            </div>
                        </td>
                        
                        <!-- Estado -->
                        <td>
                            <p-tag [value]="getEstadoLabel(ejecucion.estado)"
                                   [severity]="getEstadoSeverity(ejecucion.estado)"
                                   [rounded]="true"></p-tag>
                        </td>
                        
                        <!-- Acciones -->
                        <td>
                            <div class="flex flex-nowrap align-items-center gap-1">
                                <!-- Ver detalle -->
                                <button pButton pRipple icon="pi pi-eye"
                                    class="p-button-rounded p-button-text p-button-info p-button-sm"
                                    (click)="verDetalle(ejecucion)" pTooltip="Ver detalle"></button>
                                
                                <!-- Acción principal según estado -->
                                <button pButton pRipple icon="pi pi-play"
                                    class="p-button-rounded p-button-text p-button-success p-button-sm"
                                    (click)="abrirIniciarDialog(ejecucion)" 
                                    pTooltip="Iniciar trabajo"
                                    [loading]="accionLoadingId === ejecucion.idEjecucion"
                                    *ngIf="puedeIniciar(ejecucion)"></button>
                                
                                <button pButton pRipple icon="pi pi-check"
                                    class="p-button-rounded p-button-text p-button-success p-button-sm"
                                    (click)="abrirCompletarDialog(ejecucion)" 
                                    pTooltip="Completar mantenimiento"
                                    [loading]="accionLoadingId === ejecucion.idEjecucion"
                                    *ngIf="puedeCompletar(ejecucion)"></button>
                                
                                <!-- Menú de más opciones -->
                                <button pButton pRipple icon="pi pi-ellipsis-v"
                                    class="p-button-rounded p-button-text p-button-secondary p-button-sm"
                                    (click)="openAccionesMenu($event, ejecucion)"
                                    pTooltip="Más opciones"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center p-5">
                            <div class="flex flex-column align-items-center">
                                <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
                                <span class="text-900 font-semibold text-xl mb-2">No hay ejecuciones registradas</span>
                                <span class="text-600 text-base mb-1">Las ejecuciones se crean desde el módulo de Programaciones.</span>
                                <span class="text-500 text-sm mb-3">O puede crearlas directamente desde el Calendario.</span>
                                <button pButton pRipple label="Ir al Calendario" icon="pi pi-calendar" 
                                        class="p-button-success p-button-sm mt-2"
                                        routerLink="/administracion/mantenimientos"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            
            <!-- Menú popup de acciones (fuera de la tabla) -->
            <p-menu #menuAcciones [popup]="true" [model]="accionesMenuItems" appendTo="body"></p-menu>
        </div>
    </div>
</div>


<!-- ==================== DIALOG DETALLE ==================== -->
<p-dialog [(visible)]="showDetalleDialog" [style]="{width: '650px'}" 
    header="Detalle de Ejecución" [modal]="true">
    
    <ng-template pTemplate="content">
        <div *ngIf="ejecucionDetalle" class="flex flex-column gap-4">
            <!-- Estado destacado -->
            <div class="text-center p-3 surface-100 border-round">
                <p-tag [value]="getEstadoLabel(ejecucionDetalle.estado)"
                       [severity]="getEstadoSeverity(ejecucionDetalle.estado)"
                       styleClass="text-lg px-3 py-2"></p-tag>
            </div>
            
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-50 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-3xl text-primary"></i>
                <div>
                    <div class="font-bold text-lg">{{ ejecucionDetalle.equipoNombre }}</div>
                    <div class="text-500">{{ ejecucionDetalle.equipoCodigo }}</div>
                </div>
            </div>
            
            <!-- Datos principales -->
            <div class="grid">
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-calendar mr-1"></i>Fecha Programada
                        </label>
                        <div class="font-medium text-lg">{{ formatDate(ejecucionDetalle.fechaEjecucion) || 'No definida' }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-building mr-1"></i>Proveedor
                        </label>
                        <div class="font-medium text-lg">{{ ejecucionDetalle.proveedorNombre || 'N/A' }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-file mr-1"></i>Contrato
                        </label>
                        <div class="font-medium">{{ ejecucionDetalle.contratoDescripcion || 'N/A' }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-map-marker mr-1"></i>Ubicación
                        </label>
                        <div class="font-medium">{{ ejecucionDetalle.equipoUbicacion || 'N/A' }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Fechas de ejecución -->
            <div class="grid" *ngIf="ejecucionDetalle.fechaInicioTrabajo || ejecucionDetalle.fechaCierre">
                <div class="col-6" *ngIf="ejecucionDetalle.fechaInicioTrabajo">
                    <div class="p-3 bg-blue-50 border-round border-left-3 border-blue-500">
                        <label class="text-blue-600 text-sm block mb-1">
                            <i class="pi pi-play mr-1"></i>Inicio de Trabajo
                        </label>
                        <div class="font-bold text-blue-900">{{ formatDate(ejecucionDetalle.fechaInicioTrabajo) }}</div>
                    </div>
                </div>
                <div class="col-6" *ngIf="ejecucionDetalle.fechaCierre">
                    <div class="p-3 bg-green-50 border-round border-left-3 border-green-500">
                        <label class="text-green-600 text-sm block mb-1">
                            <i class="pi pi-check mr-1"></i>Fecha de Cierre
                        </label>
                        <div class="font-bold text-green-900">{{ formatDate(ejecucionDetalle.fechaCierre) }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Bitácora -->
            <div *ngIf="ejecucionDetalle.bitacora">
                <label class="text-500 text-sm block mb-2">
                    <i class="pi pi-book mr-1"></i>Bitácora / Observaciones
                </label>
                <div class="p-3 surface-100 border-round white-space-pre-wrap border-left-3 border-300">
                    {{ ejecucionDetalle.bitacora }}
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDetalleDialog()"></button>
        <button pButton pRipple label="Ver Evidencias" icon="pi pi-paperclip" 
            class="p-button-outlined p-button-help" (click)="verEvidenciasDesdeDetalle()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG INICIAR ==================== -->
<p-dialog [(visible)]="showIniciarDialog" [style]="{width: '500px'}" 
    header="Iniciar Trabajo de Mantenimiento" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <div class="p-3 bg-blue-50 border-round border-left-3 border-blue-500">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="font-medium text-blue-700">Información</span>
                </div>
                <p class="m-0 text-sm text-blue-600">
                    Al iniciar el trabajo, se registrará la fecha y hora actual como inicio del mantenimiento.
                </p>
            </div>
            
            <div class="field">
                <label for="iniciarBitacora" class="font-medium">Notas iniciales (opcional)</label>
                <textarea id="iniciarBitacora" 
                    pInputTextarea 
                    [(ngModel)]="iniciarBitacora"
                    rows="3" 
                    placeholder="Observaciones al iniciar el trabajo..."
                    class="w-full">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideIniciarDialog()"></button>
        <button pButton pRipple label="Iniciar Trabajo" icon="pi pi-play" 
            class="p-button-info" 
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarIniciar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG COMPLETAR ==================== -->
<p-dialog [(visible)]="showCompletarDialog" [style]="{width: '550px'}" 
    header="Completar Mantenimiento" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <!-- Tiempo de trabajo -->
            <div *ngIf="selectedEjecucion.fechaInicioTrabajo" class="p-3 bg-green-50 border-round border-left-3 border-green-500">
                <div class="flex align-items-center gap-2 mb-1">
                    <i class="pi pi-clock text-green-500"></i>
                    <span class="font-medium text-green-700">Tiempo de trabajo</span>
                </div>
                <p class="m-0 text-sm text-green-600">
                    Iniciado: {{ formatDate(selectedEjecucion.fechaInicioTrabajo) }}
                </p>
            </div>
            
            <div class="field">
                <label for="completarObservaciones" class="font-medium">
                    Observaciones de cierre <span class="text-red-500">*</span>
                </label>
                <textarea id="completarObservaciones" 
                    pInputTextarea 
                    [(ngModel)]="completarObservaciones"
                    rows="4" 
                    placeholder="Describa el trabajo realizado, hallazgos, recomendaciones..."
                    class="w-full">
                </textarea>
                <small class="text-500">Estas observaciones se agregarán a la bitácora</small>
            </div>
            
            <div class="p-3 bg-orange-50 border-round border-left-3 border-orange-500">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-orange-500"></i>
                    <span class="text-sm text-orange-700">
                        No olvide adjuntar evidencias antes de completar el mantenimiento.
                    </span>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideCompletarDialog()"></button>
        <button pButton pRipple label="Adjuntar Evidencias" icon="pi pi-paperclip" 
            class="p-button-outlined p-button-help" 
            (click)="hideCompletarDialog(); openEvidencias(selectedEjecucion)"></button>
        <button pButton pRipple label="Completar" icon="pi pi-check" 
            class="p-button-success" 
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarCompletar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG CANCELAR ==================== -->
<p-dialog [(visible)]="showCancelarDialog" [style]="{width: '500px'}" 
    header="Cancelar Ejecución" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <div class="p-3 bg-red-50 border-round border-left-3 border-red-500">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-exclamation-triangle text-red-500"></i>
                    <span class="font-medium text-red-700">Atención</span>
                </div>
                <p class="m-0 text-sm text-red-600">
                    Esta acción cancelará la ejecución del mantenimiento. 
                    Deberá indicar el motivo de la cancelación.
                </p>
            </div>
            
            <div class="field">
                <label for="cancelarMotivo" class="font-medium">
                    Motivo de cancelación <span class="text-red-500">*</span>
                </label>
                <textarea id="cancelarMotivo" 
                    pInputTextarea 
                    [(ngModel)]="cancelarMotivo"
                    rows="3" 
                    placeholder="Indique por qué se cancela este mantenimiento..."
                    class="w-full">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Volver" icon="pi pi-arrow-left" 
            class="p-button-text" (click)="hideCancelarDialog()"></button>
        <button pButton pRipple label="Confirmar Cancelación" icon="pi pi-times" 
            class="p-button-danger" 
            [disabled]="!cancelarMotivo.trim()"
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarCancelar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG EDITAR ==================== -->
<p-dialog [(visible)]="showDialog" [style]="{width: '700px'}" 
    [header]="isEditMode ? 'Editar Ejecución' : 'Nueva Ejecución'" 
    [modal]="true" [maximizable]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Sección: Datos Generales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-file-edit mr-2"></i>Datos de la Ejecución
        </div>
        
        <div class="formgrid grid">
            <!-- Info del contrato y equipo (solo lectura en edición) -->
            <div *ngIf="isEditMode" class="field col-12">
                <div class="surface-100 border-round p-3">
                    <div class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-file-edit text-primary"></i>
                        <span class="font-semibold">{{ selectedEjecucion.contratoDescripcion }}</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-cog text-500"></i>
                        <span>{{ selectedEjecucion.equipoNombre }}</span>
                        <span class="text-500">|</span>
                        <span class="text-500">{{ selectedEjecucion.proveedorNombre }}</span>
                    </div>
                </div>
            </div>

            <!-- Selección de contrato (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="contrato" class="font-medium">Contrato <span class="text-red-500">*</span></label>
                <p-dropdown id="contrato" 
                    [(ngModel)]="selectedEjecucion.idContrato"
                    [options]="contratos" 
                    optionLabel="descripcion" 
                    optionValue="idContrato"
                    placeholder="Seleccione un contrato"
                    [filter]="true"
                    filterBy="descripcion,proveedor.nombre"
                    [showClear]="true"
                    (onChange)="onContratoChange()"
                    styleClass="w-full">
                    <ng-template pTemplate="selectedItem">
                        <div *ngIf="selectedEjecucion.idContrato">
                            {{ getContratoDescripcion(selectedEjecucion.idContrato) }}
                        </div>
                    </ng-template>
                    <ng-template let-contrato pTemplate="item">
                        <div>
                            <div class="font-bold">{{ contrato.descripcion }}</div>
                            <small class="text-gray-500">{{ contrato.proveedor?.nombre }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Selección de equipo (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="equipo" class="font-medium">Equipo <span class="text-red-500">*</span></label>
                <p-dropdown id="equipo" 
                    [(ngModel)]="selectedEjecucion.idEquipo"
                    [options]="equiposContrato" 
                    optionLabel="nombre" 
                    optionValue="idEquipo"
                    placeholder="Seleccione un equipo"
                    [disabled]="!selectedEjecucion.idContrato"
                    [filter]="true"
                    filterBy="nombre,codigoInacif"
                    styleClass="w-full">
                    <ng-template let-equipo pTemplate="item">
                        <div>
                            <div class="font-bold">{{ equipo.nombre }}</div>
                            <small class="text-gray-500">{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small *ngIf="!selectedEjecucion.idContrato" class="text-orange-500">
                    Primero seleccione un contrato
                </small>
            </div>
            
            <!-- Fecha de ejecución -->
            <div class="field col-12 md:col-6">
                <label for="fechaEjecucion" class="font-medium">Fecha Programada <span class="text-red-500">*</span></label>
                <p-calendar id="fechaEjecucion" 
                    [(ngModel)]="selectedEjecucion.fechaEjecucion"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    styleClass="w-full">
                </p-calendar>
            </div>
            
            <!-- Estado -->
            <div class="field col-12 md:col-6">
                <label for="estado" class="font-medium">Estado</label>
                <p-dropdown id="estado"
                    [(ngModel)]="selectedEjecucion.estado"
                    [options]="estadoOptions"
                    placeholder="Seleccione estado"
                    styleClass="w-full">
                </p-dropdown>
            </div>
            
            <!-- Bitácora -->
            <div class="field col-12">
                <label for="bitacora" class="font-medium">Bitácora / Observaciones</label>
                <textarea id="bitacora" 
                    pInputTextarea 
                    [(ngModel)]="selectedEjecucion.bitacora"
                    rows="4" 
                    placeholder="Descripción del mantenimiento, observaciones, hallazgos...">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
            class="p-button-success"
            (click)="saveEjecucion()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG EVIDENCIAS ==================== -->
<p-dialog [(visible)]="showEvidenciasDialog" [style]="{width: '850px'}" 
    header="Evidencias del Mantenimiento" [modal]="true" [maximizable]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Info de la ejecución -->
        <div class="surface-100 p-3 border-round mb-4 border-left-3 border-primary">
            <div class="flex align-items-center gap-2 mb-2">
                <i class="pi pi-wrench text-primary"></i>
                <span class="font-semibold">{{ selectedEjecucion.equipoNombre || 'Equipo' }}</span>
                <p-tag [value]="getEstadoLabel(selectedEjecucion.estado)"
                       [severity]="getEstadoSeverity(selectedEjecucion.estado)" 
                       [rounded]="true" styleClass="ml-2"></p-tag>
            </div>
            <small class="text-500">
                {{ selectedEjecucion.contratoDescripcion }} | {{ formatDate(selectedEjecucion.fechaEjecucion) }}
            </small>
        </div>

        <!-- Subir nueva evidencia -->
        <div class="surface-50 p-4 border-round mb-4 border-left-3 border-help">
            <h6 class="mt-0 mb-3 flex align-items-center gap-2 text-purple-700">
                <i class="pi pi-upload"></i>
                Subir Nueva Evidencia
            </h6>
            
            <div class="field mb-3">
                <label for="descripcionEvidencia" class="font-medium">Descripción (opcional)</label>
                <input pInputText id="descripcionEvidencia" [(ngModel)]="nuevaDescripcion" 
                       placeholder="Ej: Foto del equipo después del mantenimiento" class="w-full"/>
            </div>
            
            <!-- Input file nativo más confiable -->
            <div class="flex align-items-center gap-2">
                <input type="file" 
                       #fileInput
                       (change)="onNativeFileSelect($event)"
                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                       multiple
                       [disabled]="uploading"
                       class="hidden"/>
                <button pButton pRipple 
                        type="button"
                        icon="pi pi-upload" 
                        label="Seleccionar archivos"
                        class="p-button-outlined p-button-help"
                        [disabled]="uploading"
                        (click)="fileInput.click()"></button>
                <span *ngIf="archivosSeleccionados.length > 0" class="text-500">
                    {{ archivosSeleccionados.length }} archivo(s) seleccionado(s)
                </span>
            </div>
            
            <div *ngIf="archivosSeleccionados.length > 0 && !uploading" class="mt-3">
                <button pButton pRipple 
                        type="button"
                        icon="pi pi-cloud-upload" 
                        label="Subir archivos"
                        class="p-button-success"
                        (click)="subirArchivosSeleccionados()"></button>
            </div>
            
            <div *ngIf="uploading" class="mt-3">
                <p-progressBar [value]="uploadProgress" [showValue]="true"></p-progressBar>
                <small class="text-500">Subiendo archivo...</small>
            </div>
            
            <small class="text-500 block mt-2">
                Formatos permitidos: Imágenes (jpg, png, gif), PDF, Word, Excel. Máximo 10MB.
            </small>
        </div>

        <!-- Lista de evidencias -->
        <h6 class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-folder-open text-primary"></i>
            Evidencias Adjuntas ({{ evidencias.length }})
        </h6>

        <div *ngIf="loadingEvidencias" class="text-center p-4">
            <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            <p class="mt-2 text-500">Cargando evidencias...</p>
        </div>

        <div *ngIf="!loadingEvidencias && evidencias.length === 0" class="text-center p-4 surface-100 border-round">
            <i class="pi pi-inbox text-4xl text-400"></i>
            <p class="mt-2 text-500">No hay evidencias adjuntas a esta ejecución</p>
        </div>

        <div *ngIf="!loadingEvidencias && evidencias.length > 0" class="grid">
            <div *ngFor="let evidencia of evidencias" class="col-12 md:col-6">
                <div class="surface-card p-3 border-1 surface-border border-round shadow-1">
                    <div class="flex align-items-start gap-3">
                        <!-- Icono del archivo -->
                        <div class="flex-shrink-0">
                            <div class="w-4rem h-4rem border-round surface-100 flex align-items-center justify-content-center cursor-pointer"
                                 (click)="downloadEvidencia(evidencia)">
                                <i [class]="getFileIcon(evidencia) + ' text-3xl'"></i>
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-grow-1 min-w-0">
                            <div class="font-medium text-overflow-ellipsis overflow-hidden white-space-nowrap" 
                                 [pTooltip]="evidencia.nombreOriginal">
                                {{ evidencia.nombreOriginal }}
                            </div>
                            <small class="text-500 block">{{ formatFileSize(evidencia.tamanio) }}</small>
                            <small *ngIf="evidencia.descripcion" class="text-600 block mt-1">
                                {{ evidencia.descripcion }}
                            </small>
                            <small class="text-400 block mt-1">
                                {{ formatDate(evidencia.fechaCreacion) }}
                                <span *ngIf="evidencia.usuarioCreacionNombre"> por {{ evidencia.usuarioCreacionNombre }}</span>
                            </small>
                        </div>
                        
                        <!-- Acciones -->
                        <div class="flex-shrink-0 flex gap-1">
                            <button pButton pRipple icon="pi pi-download" 
                                    class="p-button-rounded p-button-text p-button-sm"
                                    (click)="downloadEvidencia(evidencia)"
                                    pTooltip="Descargar"></button>
                            <button pButton pRipple icon="pi pi-trash" 
                                    class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                    (click)="deleteEvidencia(evidencia)"
                                    pTooltip="Eliminar"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideEvidenciasDialog()"></button>
    </ng-template>
</p-dialog>
