<div class="card">
    <h5>Ejecuciones de Mantenimiento</h5>
    
    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
            <div class="flex align-items-center gap-2">
                <h5 class="m-0">Ejecuciones de Mantenimiento</h5>
                <p-tag value="Gestión" severity="info"></p-tag>
            </div>
        </ng-template>
        <ng-template pTemplate="right">
            <div class="flex gap-2">
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" placeholder="Buscar equipo, proveedor, estado..." 
                        (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                        class="w-full" />
                </span>
                <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" 
                    class="p-button-outlined"
                    routerLink="/administracion/mantenimientos"
                    pTooltip="Ver ejecuciones en calendario"></button>
            </div>
        </ng-template>
    </p-toolbar>

    <p-table #dt [value]="ejecuciones" 
        [loading]="loading" [rows]="10" [paginator]="true" [rowsPerPageOptions]="[10, 25, 50]"
        [showCurrentPageReport]="true" currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} registros"
        [rowHover]="true" [globalFilterFields]="['equipoNombre', 'proveedorNombre', 'contratoDescripcion', 'estado']"
        styleClass="p-datatable-sm">
        
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="fechaEjecucion" style="width: 200px">
                    Fecha Programada <p-sortIcon field="fechaEjecucion"></p-sortIcon>
                </th>
                <th pSortableColumn="equipoNombre">
                    Equipo <p-sortIcon field="equipoNombre"></p-sortIcon>
                </th>
                <th pSortableColumn="proveedorNombre">
                    Proveedor <p-sortIcon field="proveedorNombre"></p-sortIcon>
                </th>
                <th pSortableColumn="estado" style="width: 150px">
                    Estado <p-sortIcon field="estado"></p-sortIcon>
                </th>
                <th style="width: 200px">Acciones</th>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-ejecucion>
            <tr>
                <td>{{ formatDate(ejecucion.fechaEjecucion) || 'Sin fecha' }}</td>
                <td>
                    <div class="font-medium">{{ ejecucion.equipoNombre || 'N/A' }}</div>
                    <small class="text-500">{{ ejecucion.contratoDescripcion }}</small>
                </td>
                <td>{{ ejecucion.proveedorNombre || 'N/A' }}</td>
                <td>
                    <p-tag [value]="getEstadoLabel(ejecucion.estado)"
                           [severity]="getEstadoSeverity(ejecucion.estado)"></p-tag>
                </td>
                <td>
                    <div class="flex flex-nowrap gap-0">
                        <button pButton pRipple icon="pi pi-pencil" 
                            class="p-button-text p-button-success p-button-sm" 
                            (click)="editEjecucion(ejecucion)"
                            pTooltip="Editar"></button>
                        <button pButton pRipple icon="pi pi-paperclip" 
                            class="p-button-text p-button-help p-button-sm" 
                            (click)="openEvidencias(ejecucion)"
                            pTooltip="Evidencias"></button>
                        <button *ngIf="puedeIniciar(ejecucion)"
                            pButton pRipple icon="pi pi-play"
                            class="p-button-text p-button-info p-button-sm"
                            [loading]="accionLoadingId === ejecucion.idEjecucion"
                            (click)="cambiarEstadoRapido(ejecucion, 'EN_PROCESO')"
                            pTooltip="Iniciar"></button>
                        <button *ngIf="puedeCompletar(ejecucion)"
                            pButton pRipple icon="pi pi-check"
                            class="p-button-text p-button-primary p-button-sm"
                            [loading]="accionLoadingId === ejecucion.idEjecucion"
                            (click)="cambiarEstadoRapido(ejecucion, 'COMPLETADO')"
                            pTooltip="Completar"></button>
                        <button *ngIf="!estaCompletadoOCancelado(ejecucion)" 
                            pButton pRipple icon="pi pi-trash" 
                            class="p-button-text p-button-danger p-button-sm" 
                            (click)="deleteEjecucion(ejecucion)"
                            pTooltip="Eliminar"></button>
                        <button *ngIf="estaCompletadoOCancelado(ejecucion)" 
                            pButton pRipple icon="pi pi-trash" 
                            class="p-button-text p-button-danger p-button-sm" 
                            (click)="deleteEjecucion(ejecucion)"
                            pTooltip="Eliminar (finalizada)"></button>
                    </div>
                </td>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="5" class="text-center p-5">
                    <i class="pi pi-calendar-times text-5xl text-400 mb-3"></i>
                    <p class="text-xl font-medium mt-0 mb-2">No hay ejecuciones registradas</p>
                    <p class="text-600 mt-0 mb-3">Las ejecuciones se crean desde:</p>
                    <div class="flex gap-2 justify-content-center">
                        <button pButton pRipple label="Ir al Calendario" icon="pi pi-calendar" 
                                class="p-button-sm"
                                routerLink="/administracion/mantenimientos"></button>
                        <button pButton pRipple label="Ver Programaciones" icon="pi pi-calendar-plus" 
                                class="p-button-sm p-button-outlined"
                                routerLink="/administracion/programaciones"></button>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Nota informativa -->
    <div class="mt-3 p-3 surface-50 border-round">
        <div class="flex align-items-start gap-2">
            <i class="pi pi-info-circle text-primary mt-1"></i>
            <div>
                <p class="font-semibold m-0 mb-2">¿Cómo crear ejecuciones?</p>
                <ul class="m-0 pl-3 text-sm text-600">
                    <li>Desde el <strong>Calendario</strong>: Click en una programación (evento morado) o en un día vacío</li>
                    <li>Las ejecuciones se vinculan automáticamente con las <strong>Programaciones</strong> activas</li>
                    <li>Puedes cambiar el estado rápidamente con los botones de acción</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Dialog para crear/editar ejecuciones -->
<p-dialog [(visible)]="showDialog" [style]="{width: '700px'}" 
    [header]="isEditMode ? 'Editar Ejecución' : 'Nueva Ejecución'" 
    [modal]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <div class="grid">
            <!-- Info del contrato y equipo (solo lectura en edición) -->
            <div *ngIf="isEditMode" class="col-12 surface-100 border-round p-3 mb-3">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-file-edit text-primary"></i>
                    <span class="font-semibold">{{ selectedEjecucion.contratoDescripcion }}</span>
                </div>
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-cog text-500"></i>
                    <span>{{ selectedEjecucion.equipoNombre }}</span>
                    <span class="text-500">|</span>
                    <span class="text-500">{{ selectedEjecucion.proveedorNombre }}</span>
                </div>
            </div>

            <!-- Selección de contrato (solo al crear) -->
            <div *ngIf="!isEditMode" class="col-12 md:col-6">
                <div class="field">
                    <label for="contrato">Contrato *</label>
                    <p-dropdown id="contrato" 
                        [(ngModel)]="selectedEjecucion.idContrato"
                        [options]="contratos" 
                        optionLabel="descripcion" 
                        optionValue="idContrato"
                        placeholder="Seleccione un contrato"
                        [filter]="true"
                        filterBy="descripcion,proveedor.nombre"
                        (onChange)="onContratoChange()">
                        <ng-template pTemplate="selectedItem">
                            <div *ngIf="selectedEjecucion.idContrato">
                                {{ getContratoDescripcion(selectedEjecucion.idContrato) }}
                            </div>
                        </ng-template>
                        <ng-template let-contrato pTemplate="item">
                            <div>
                                <div>{{ contrato.descripcion }}</div>
                                <small>{{ contrato.proveedor?.nombre }}</small>
                            </div>
                        </ng-template>
                    </p-dropdown>
                </div>
            </div>

            <!-- Selección de equipo (solo al crear) -->
            <div *ngIf="!isEditMode" class="col-12 md:col-6">
                <div class="field">
                    <label for="equipo">Equipo *</label>
                    <p-dropdown id="equipo" 
                        [(ngModel)]="selectedEjecucion.idEquipo"
                        [options]="getEquiposDelContrato()" 
                        optionLabel="nombre" 
                        optionValue="idEquipo"
                        placeholder="Seleccione un equipo"
                        [disabled]="!selectedEjecucion.idContrato"
                        [filter]="true"
                        filterBy="nombre,codigoInacif">
                        <ng-template let-equipo pTemplate="item">
                            <div>
                                <div>{{ equipo.nombre }}</div>
                                <small>{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small *ngIf="!selectedEjecucion.idContrato" class="p-error">
                        Primero seleccione un contrato
                    </small>
                </div>
            </div>
            
            <!-- Fecha de ejecución -->
            <div class="col-12 md:col-6">
                <div class="field">
                    <label for="fechaEjecucion">Fecha Programada *</label>
                    <p-calendar id="fechaEjecucion" 
                        [(ngModel)]="selectedEjecucion.fechaEjecucion"
                        dateFormat="dd/mm/yy"
                        [showIcon]="true">
                    </p-calendar>
                    <small class="text-500">Cuándo se debe realizar el mantenimiento</small>
                </div>
            </div>
            
            <!-- Estado -->
            <div class="col-12 md:col-6">
                <div class="field">
                    <label for="estado">Estado</label>
                    <p-dropdown id="estado"
                        [(ngModel)]="selectedEjecucion.estado"
                        [options]="estadoOptions"
                        placeholder="Seleccione estado">
                    </p-dropdown>
                    <small class="text-500">Use los botones de acción para cambiar estado</small>
                </div>
            </div>

            <!-- Fechas automáticas (solo lectura en edición) -->
            <div *ngIf="isEditMode && selectedEjecucion.fechaInicioTrabajo" class="col-12 md:col-6">
                <div class="field">
                    <label>Inicio Real</label>
                    <div class="p-inputtext p-component p-disabled surface-100">
                        {{ formatDate(selectedEjecucion.fechaInicioTrabajo) || 'Pendiente' }}
                    </div>
                    <small class="text-500">Asignado automáticamente al iniciar</small>
                </div>
            </div>

            <div *ngIf="isEditMode && selectedEjecucion.fechaCierre" class="col-12 md:col-6">
                <div class="field">
                    <label>Fecha de Cierre</label>
                    <div class="p-inputtext p-component p-disabled surface-100">
                        {{ formatDate(selectedEjecucion.fechaCierre) || 'Pendiente' }}
                    </div>
                    <small class="text-500">Asignado automáticamente al completar</small>
                </div>
            </div>
            
            <!-- Bitácora -->
            <div class="col-12">
                <div class="field">
                    <label for="bitacora">Bitácora / Observaciones</label>
                    <textarea id="bitacora" 
                        pInputTextarea 
                        [(ngModel)]="selectedEjecucion.bitacora"
                        rows="4" 
                        placeholder="Descripción del mantenimiento, observaciones, hallazgos...">
                    </textarea>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
            class="p-button-text" (click)="saveEjecucion()"></button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>

<!-- Dialog para evidencias -->
<p-dialog [(visible)]="showEvidenciasDialog" [style]="{width: '800px'}" 
    header="Evidencias del Mantenimiento" [modal]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Info de la ejecución -->
        <div class="surface-100 p-3 border-round mb-4">
            <div class="flex align-items-center gap-2 mb-2">
                <i class="pi pi-wrench text-primary"></i>
                <span class="font-semibold">{{ selectedEjecucion.equipoNombre || 'Equipo' }}</span>
                <p-tag [value]="getEstadoLabel(selectedEjecucion.estado)"
                       [severity]="getEstadoSeverity(selectedEjecucion.estado)" 
                       styleClass="ml-2"></p-tag>
            </div>
            <small class="text-500">
                {{ selectedEjecucion.contratoDescripcion }} | {{ formatDate(selectedEjecucion.fechaEjecucion) }}
            </small>
        </div>

        <!-- Subir nueva evidencia -->
        <div class="surface-50 p-4 border-round mb-4">
            <h6 class="mt-0 mb-3 flex align-items-center gap-2">
                <i class="pi pi-upload text-primary"></i>
                Subir Nueva Evidencia
            </h6>
            
            <div class="field mb-3">
                <label for="descripcionEvidencia">Descripción (opcional)</label>
                <input pInputText id="descripcionEvidencia" [(ngModel)]="nuevaDescripcion" 
                       placeholder="Ej: Foto del equipo después del mantenimiento" class="w-full"/>
            </div>
            
            <!-- Input file nativo más confiable -->
            <div class="flex align-items-center gap-2">
                <input type="file" 
                       #fileInput
                       (change)="onNativeFileSelect($event)"
                       accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                       multiple
                       [disabled]="uploading"
                       class="hidden"/>
                <button pButton pRipple 
                        type="button"
                        icon="pi pi-upload" 
                        label="Seleccionar archivos"
                        class="p-button-outlined"
                        [disabled]="uploading"
                        (click)="fileInput.click()"></button>
                <span *ngIf="archivosSeleccionados.length > 0" class="text-500">
                    {{ archivosSeleccionados.length }} archivo(s) seleccionado(s)
                </span>
            </div>
            
            <div *ngIf="archivosSeleccionados.length > 0 && !uploading" class="mt-3">
                <button pButton pRipple 
                        type="button"
                        icon="pi pi-cloud-upload" 
                        label="Subir archivos"
                        class="p-button-success"
                        (click)="subirArchivosSeleccionados()"></button>
            </div>
            
            <div *ngIf="uploading" class="mt-3">
                <p-progressBar [value]="uploadProgress" [showValue]="true"></p-progressBar>
                <small class="text-500">Subiendo archivo...</small>
            </div>
            
            <small class="text-500 block mt-2">
                Formatos permitidos: Imágenes (jpg, png, gif), PDF, Word, Excel. Máximo 10MB.
            </small>
        </div>

        <!-- Lista de evidencias -->
        <h6 class="flex align-items-center gap-2 mb-3">
            <i class="pi pi-folder-open text-primary"></i>
            Evidencias Adjuntas ({{ evidencias.length }})
        </h6>

        <div *ngIf="loadingEvidencias" class="text-center p-4">
            <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
            <p class="mt-2 text-500">Cargando evidencias...</p>
        </div>

        <div *ngIf="!loadingEvidencias && evidencias.length === 0" class="text-center p-4 surface-100 border-round">
            <i class="pi pi-inbox text-4xl text-400"></i>
            <p class="mt-2 text-500">No hay evidencias adjuntas a esta ejecución</p>
        </div>

        <div *ngIf="!loadingEvidencias && evidencias.length > 0" class="grid">
            <div *ngFor="let evidencia of evidencias" class="col-12 md:col-6">
                <div class="surface-card p-3 border-1 surface-border border-round shadow-1">
                    <div class="flex align-items-start gap-3">
                        <!-- Icono del archivo -->
                        <div class="flex-shrink-0">
                            <div class="w-4rem h-4rem border-round surface-100 flex align-items-center justify-content-center cursor-pointer"
                                 (click)="downloadEvidencia(evidencia)">
                                <i [class]="getFileIcon(evidencia) + ' text-3xl'"></i>
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="flex-grow-1 min-w-0">
                            <div class="font-medium text-overflow-ellipsis overflow-hidden white-space-nowrap" 
                                 [pTooltip]="evidencia.nombreOriginal">
                                {{ evidencia.nombreOriginal }}
                            </div>
                            <small class="text-500 block">{{ formatFileSize(evidencia.tamanio) }}</small>
                            <small *ngIf="evidencia.descripcion" class="text-600 block mt-1">
                                {{ evidencia.descripcion }}
                            </small>
                            <small class="text-400 block mt-1">
                                {{ formatDate(evidencia.fechaCreacion) }}
                                <span *ngIf="evidencia.usuarioCreacionNombre"> por {{ evidencia.usuarioCreacionNombre }}</span>
                            </small>
                        </div>
                        
                        <!-- Acciones -->
                        <div class="flex-shrink-0 flex gap-1">
                            <button pButton pRipple icon="pi pi-download" 
                                    class="p-button-rounded p-button-text p-button-sm"
                                    (click)="downloadEvidencia(evidencia)"
                                    pTooltip="Descargar"></button>
                            <button pButton pRipple icon="pi pi-trash" 
                                    class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                    (click)="deleteEvidencia(evidencia)"
                                    pTooltip="Eliminar"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideEvidenciasDialog()"></button>
    </ng-template>
</p-dialog>
