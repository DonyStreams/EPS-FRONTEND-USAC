<div class="grid">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <!-- T铆tulo y descripci贸n -->
    <div class="col-12">
        <div class="card">
            <h5>Ejecuciones de Mantenimiento</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Gestione y d茅 seguimiento a las ejecuciones de mantenimientos 
                programados, en proceso y completados.</p>
        </div>
    </div>

    <!-- Estad铆sticas -->
    <div class="col-12 md:col-3">
        <div class="card bg-orange-100 border-left-3 border-orange-500 cursor-pointer" (click)="setFiltroEstado('PROGRAMADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-orange-600 font-medium">Programados</span>
                    <div class="text-2xl font-bold text-orange-900">{{countProgramados}}</div>
                    <small *ngIf="countVencidas > 0" class="text-red-600 font-medium">
                        <i class="pi pi-exclamation-triangle mr-1"></i>{{countVencidas}} vencidas
                    </small>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-calendar text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-blue-100 border-left-3 border-blue-500 cursor-pointer" (click)="setFiltroEstado('EN_PROCESO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-blue-600 font-medium">En Proceso</span>
                    <div class="text-2xl font-bold text-blue-900">{{countEnProceso}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-spinner text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-green-100 border-left-3 border-green-500 cursor-pointer" (click)="setFiltroEstado('COMPLETADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-green-600 font-medium">Completados</span>
                    <div class="text-2xl font-bold text-green-900">{{countCompletados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-green-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-check-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-red-100 border-left-3 border-red-500 cursor-pointer" (click)="setFiltroEstado('CANCELADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-red-600 font-medium">Cancelados</span>
                    <div class="text-2xl font-bold text-red-900">{{countCancelados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-red-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-times-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de ejecuciones -->
    <div class="col-12">
        <div class="card">
            <!-- Banner de filtro activo -->
            <div *ngIf="filtroIdEjecucion" class="mb-3 p-3 border-round surface-ground flex align-items-center justify-content-between">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-filter text-primary"></i>
                    <span class="font-medium">Mostrando ejecuci贸n espec铆fica ID: {{filtroIdEjecucion}}</span>
                </div>
                <button pButton pRipple label="Ver Todo" icon="pi pi-times" 
                    class="p-button-text p-button-sm"
                    (click)="limpiarFiltroId()"></button>
            </div>
            
            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <p-dropdown [options]="estadosFiltro" 
                                [(ngModel)]="filtroEstado"
                                (onChange)="onFiltroEstadoChange()"
                                placeholder="Filtrar por estado"
                                styleClass="mr-2">
                    </p-dropdown>
                    <button pButton pRipple label="Limpiar filtro" icon="pi pi-filter-slash" 
                        class="p-button-outlined p-button-secondary mr-2"
                        (click)="setFiltroEstado('')"
                        *ngIf="filtroEstado"></button>
                </ng-template>
                <ng-template pTemplate="right">
                    <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" class="p-button-outlined"
                        routerLink="/administracion/mantenimientos"
                        pTooltip="Ver programaciones en calendario"></button>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="ejecucionesFiltradas" [loading]="loading" [paginator]="true" [rows]="10"
                [rowsPerPageOptions]="[10,20,50]" [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ejecuciones"
                [globalFilterFields]="['equipoNombre','contratoDescripcion','tipoMantenimiento','estado']"
                [rowHover]="true" dataKey="idEjecucion">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Registro de Ejecuciones</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                                placeholder="Buscar..." class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="equipoNombre">Equipo <p-sortIcon field="equipoNombre"></p-sortIcon></th>
                        <th pSortableColumn="tipoMantenimiento">Tipo <p-sortIcon field="tipoMantenimiento"></p-sortIcon></th>
                        <th pSortableColumn="fechaEjecucion">Fecha Programada <p-sortIcon field="fechaEjecucion"></p-sortIcon></th>
                        <th pSortableColumn="fechaCreacion">Fecha Creaci贸n <p-sortIcon field="fechaCreacion"></p-sortIcon></th>
                        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                        <th style="width: 100px"></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-ejecucion>
                    <tr>
                        <!-- Equipo -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-desktop text-primary"></i>
                                <div>
                                    <div class="font-semibold text-900">{{ejecucion.equipoNombre || 'N/A'}}</div>
                                    <div class="text-xs text-500">{{ejecucion.equipoCodigo}}</div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Tipo de Mantenimiento -->
                        <td>
                            <p-tag [value]="ejecucion.tipoMantenimiento || 'N/A'"
                                [severity]="getTipoSeverity(ejecucion.tipoMantenimiento)"
                                [rounded]="true"></p-tag>
                        </td>
                        
                        <!-- Fecha Programada -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <span class="font-semibold" [class.text-red-600]="isVencida(ejecucion)">
                                    {{formatDate(ejecucion.fechaEjecucion)}}
                                </span>
                                <p-tag *ngIf="isVencida(ejecucion)" value="VENCIDA"
                                    severity="danger" [style]="{fontSize: '0.7rem'}"></p-tag>
                            </div>
                        </td>
                        
                        <!-- Fecha Creaci贸n -->
                        <td>
                            <div class="text-sm">
                                <div class="text-600">{{formatDateTime(ejecucion.fechaCreacion)}}</div>
                            </div>
                        </td>
                        
                        <!-- Estado -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <i *ngIf="ejecucion.estado === 'EN_PROCESO'" class="pi pi-spin pi-spinner text-blue-500"></i>
                                <p-tag [value]="getEstadoLabel(ejecucion.estado)"
                                       [severity]="getEstadoSeverity(ejecucion.estado)"
                                       [rounded]="true"></p-tag>
                            </div>
                        </td>
                        
                        <!-- Acciones -->
                        <td>
                            <div class="flex flex-nowrap align-items-center justify-content-center">
                                <button pButton pRipple icon="pi pi-ellipsis-v"
                                    class="p-button-rounded p-button-text p-button-secondary"
                                    (click)="openAccionesMenu($event, ejecucion)"
                                    pTooltip="Acciones"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center p-5">
                            <div class="flex flex-column align-items-center">
                                <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
                                <span class="text-900 font-semibold text-xl mb-2">No hay ejecuciones registradas</span>
                                <span class="text-600 text-base mb-1">Las ejecuciones se crean desde el m贸dulo de Programaciones.</span>
                                <span class="text-500 text-sm mb-3">O puede crearlas directamente desde el Calendario.</span>
                                <button pButton pRipple label="Ir al Calendario" icon="pi pi-calendar" 
                                        class="p-button-success p-button-sm mt-2"
                                        routerLink="/administracion/mantenimientos"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            
            <!-- Men煤 popup de acciones (fuera de la tabla) -->
            <p-menu #menuAcciones [popup]="true" [model]="accionesMenuItems" appendTo="body"></p-menu>
        </div>
    </div>
</div>




<!-- ==================== DIALOG INICIAR (ELIMINADO - USO CONFIRMACIN DIRECTA) ==================== -->


<!-- ==================== DIALOG COMPLETAR (ELIMINADO - USO CONFIRMACIN DIRECTA) ==================== -->


<!-- ==================== DIALOG CANCELAR (ELIMINADO - USO CONFIRMACIN DIRECTA) ==================== -->


<!-- ==================== DIALOG EDITAR ==================== -->
<p-dialog [(visible)]="showDialog" [style]="{width: '700px'}" 
    [header]="isEditMode ? 'Editar Ejecuci贸n' : 'Nueva Ejecuci贸n'" 
    [modal]="true" [maximizable]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Secci贸n: Datos Generales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-file-edit mr-2"></i>Datos de la Ejecuci贸n
        </div>
        
        <div class="formgrid grid">
            <!-- Info del contrato y equipo (solo lectura en edici贸n) -->
            <div *ngIf="isEditMode" class="field col-12">
                <div class="surface-100 border-round-lg p-3 mb-3">
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <div class="flex align-items-start gap-2 mb-3">
                                <i class="pi pi-file-edit text-primary mt-1"></i>
                                <div>
                                    <small class="text-500 block mb-1">Contrato</small>
                                    <span class="font-semibold text-900">{{ selectedEjecucion.contratoDescripcion }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 md:col-6">
                            <div class="flex align-items-start gap-2 mb-3">
                                <i class="pi pi-building text-primary mt-1"></i>
                                <div>
                                    <small class="text-500 block mb-1">Proveedor</small>
                                    <span class="font-semibold text-900">{{ selectedEjecucion.proveedorNombre }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="flex align-items-start gap-2">
                                <i class="pi pi-cog text-primary mt-1"></i>
                                <div>
                                    <small class="text-500 block mb-1">Equipo</small>
                                    <span class="font-semibold text-900">{{ selectedEjecucion.equipoNombre }}</span>
                                    <small class="text-500 block mt-1">{{ selectedEjecucion.equipoCodigo }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 bg-blue-50 border-round border-left-3 border-blue-500 mb-3">
                    <div class="flex align-items-start gap-2">
                        <i class="pi pi-info-circle text-blue-500 mt-1"></i>
                        <div>
                            <p class="m-0 text-sm text-blue-700">
                                <strong>Nota:</strong> El contrato y equipo no pueden modificarse. 
                                Para cambiar el estado use los botones espec铆ficos (Iniciar, Completar, Cancelar) 
                                o el modal de Gesti贸n.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selecci贸n de contrato (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="contrato" class="font-medium">Contrato <span class="text-red-500">*</span></label>
                <p-dropdown id="contrato" 
                    [(ngModel)]="selectedEjecucion.idContrato"
                    [options]="contratos" 
                    optionLabel="descripcion" 
                    optionValue="idContrato"
                    placeholder="Seleccione un contrato"
                    [filter]="true"
                    filterBy="descripcion,proveedor.nombre"
                    [showClear]="true"
                    (onChange)="onContratoChange()"
                    styleClass="w-full">
                    <ng-template pTemplate="selectedItem">
                        <div *ngIf="selectedEjecucion.idContrato">
                            {{ getContratoDescripcion(selectedEjecucion.idContrato) }}
                        </div>
                    </ng-template>
                    <ng-template let-contrato pTemplate="item">
                        <div>
                            <div class="font-bold">{{ contrato.descripcion }}</div>
                            <small class="text-gray-500">{{ contrato.proveedor?.nombre }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Selecci贸n de equipo (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="equipo" class="font-medium">Equipo <span class="text-red-500">*</span></label>
                <p-dropdown id="equipo" 
                    [(ngModel)]="selectedEjecucion.idEquipo"
                    [options]="equiposContrato" 
                    optionLabel="nombre" 
                    optionValue="idEquipo"
                    placeholder="Seleccione un equipo"
                    [disabled]="!selectedEjecucion.idContrato"
                    [filter]="true"
                    filterBy="nombre,codigoInacif"
                    styleClass="w-full">
                    <ng-template let-equipo pTemplate="item">
                        <div>
                            <div class="font-bold">{{ equipo.nombre }}</div>
                            <small class="text-gray-500">{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small *ngIf="!selectedEjecucion.idContrato" class="text-orange-500">
                    Primero seleccione un contrato
                </small>
            </div>
            
            <!-- Fecha de ejecuci贸n -->
            <div class="field col-12">
                <label for="fechaEjecucion" class="font-medium">
                    <i class="pi pi-calendar mr-1"></i>
                    Fecha Programada <span class="text-red-500">*</span>
                </label>
                <p-calendar id="fechaEjecucion" 
                    [(ngModel)]="selectedEjecucion.fechaEjecucion"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    [showTime]="false"
                    styleClass="w-full"
                    appendTo="body">
                </p-calendar>
                <small *ngIf="isEditMode" class="text-500">
                    <i class="pi pi-info-circle mr-1"></i>
                    Modifique si necesita reprogramar la fecha del mantenimiento. Use el modal de Gesti贸n para agregar observaciones.
                </small>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
            class="p-button-success"
            (click)="saveEjecucion()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG DE GESTIN (COMENTARIOS + EVIDENCIAS + ESTADOS) ==================== -->
<p-dialog [(visible)]="showGestionDialog" [style]="{width: '90vw', height: '95vh'}" 
    header=" Gesti贸n de Ejecuci贸n" [modal]="true" [maximizable]="true" [draggable]="true" [resizable]="true"
    [contentStyle]="{'overflow': 'auto', 'padding': '1rem'}">
    
    <ng-template pTemplate="content">
        <div class="gestion-container" *ngIf="ejecucionGestion">
            <!-- HEADER DE LA EJECUCIN -->
            <div class="ejecucion-header mb-3">
                <div class="surface-card border-round-lg p-3 shadow-2">
                    <!-- Primera fila: Equipo y Estados -->
                    <div class="flex flex-wrap justify-content-between align-items-start gap-3 mb-3">
                        <div class="flex align-items-start gap-3 flex-grow-1">
                            <div class="bg-primary border-circle w-3rem h-3rem flex align-items-center justify-content-center flex-shrink-0">
                                <i class="pi pi-wrench text-white text-xl"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="flex align-items-center gap-2 mb-1">
                                    <h5 class="m-0 text-primary">{{ ejecucionGestion.equipoNombre }}</h5>
                                    <p-tag [value]="getEstadoLabel(ejecucionGestion.estado)" 
                                           [severity]="getEstadoSeverity(ejecucionGestion.estado)" 
                                           [rounded]="true" class="text-xs"></p-tag>
                                    <p-tag *ngIf="ejecucionGestion.tipoMantenimiento"
                                           [value]="ejecucionGestion.tipoMantenimiento" 
                                           [severity]="getTipoSeverity(ejecucionGestion.tipoMantenimiento)" 
                                           [rounded]="true" class="text-xs"></p-tag>
                                </div>
                                
                                <div class="grid mt-2">
                                    <div class="col-12 md:col-6 lg:col-3">
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-tag text-500"></i>
                                            <div>
                                                <small class="text-500 block">C贸digo</small>
                                                <span class="text-900 font-medium text-sm">{{ ejecucionGestion.equipoCodigo }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6 lg:col-3">
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-calendar text-500"></i>
                                            <div>
                                                <small class="text-500 block">Fecha Programada</small>
                                                <span class="text-900 font-medium text-sm">{{ formatDate(ejecucionGestion.fechaEjecucion) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6 lg:col-3" *ngIf="ejecucionGestion.fechaEjecucionReal">
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-check-circle text-500"></i>
                                            <div>
                                                <small class="text-500 block">Fecha Ejecutada</small>
                                                <span class="text-900 font-medium text-sm">{{ formatDate(ejecucionGestion.fechaEjecucionReal) }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12 md:col-6 lg:col-3" *ngIf="ejecucionGestion.tecnicoResponsable">
                                        <div class="flex align-items-center gap-2">
                                            <i class="pi pi-user text-500"></i>
                                            <div>
                                                <small class="text-500 block">T茅cnico</small>
                                                <span class="text-900 font-medium text-sm">{{ ejecucionGestion.tecnicoResponsable }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Segunda fila: Mensaje informativo -->
                    <div class="surface-50 border-round p-2">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-info-circle text-blue-500"></i>
                            <p class="m-0 text-sm text-700">
                                <strong>Importante:</strong> Puede agregar comentarios de seguimiento, cambiar el estado del mantenimiento y 
                                <strong class="text-primary">subir evidencias fotogr谩ficas o documentos</strong> que respalden la ejecuci贸n 
                                (formatos: PDF, Word, Excel, im谩genes).
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- OBSERVACIONES EDITABLES -->
            <div class="mb-3">
                <div class="surface-card border-round-lg shadow-1">
                    <div class="surface-50 border-round-top-lg p-2 border-bottom-1 surface-border">
                        <div class="flex align-items-center justify-content-between">
                            <div class="flex align-items-center">
                                <i class="pi pi-book text-purple-500 mr-2"></i>
                                <h6 class="m-0 text-sm">Observaciones / Bit谩cora</h6>
                            </div>
                            <button pButton icon="pi pi-save" label="Guardar" class="p-button-sm p-button-success"
                                    (click)="guardarObservaciones()"
                                    pTooltip="Guardar cambios en observaciones"></button>
                        </div>
                    </div>
                    <div class="p-3">
                        <textarea pInputTextarea [(ngModel)]="ejecucionGestion.bitacora" rows="3" 
                                  placeholder="Agregue observaciones, hallazgos, recomendaciones sobre la ejecuci贸n..." 
                                  class="w-full"></textarea>
                        <small class="text-500">
                            <i class="pi pi-info-circle mr-1"></i>
                            Las observaciones se almacenan en la bit谩cora general de la ejecuci贸n.
                        </small>
                    </div>
                </div>
            </div>

            <!-- DOS COLUMNAS -->
            <div class="grid">
                <!-- PANEL DE COMENTARIOS -->
                <div class="col-12 lg:col-7">
                    <div class="surface-card border-round-lg shadow-1 h-full">
                        <div class="surface-50 border-round-top-lg p-2 border-bottom-1 surface-border">
                            <div class="flex align-items-center">
                                <i class="pi pi-comments text-primary mr-2"></i>
                                <h6 class="m-0 text-sm">Historial de Seguimiento</h6>
                                <p-badge [value]="comentarios.length.toString()" severity="info" class="ml-2"></p-badge>
                            </div>
                        </div>
                        
                        <!-- rea de scroll de comentarios -->
                        <div class="p-3" style="max-height: 350px; overflow-y: auto;">
                            <!-- ESTADO VACO -->
                            <div *ngIf="comentarios.length === 0 && !loadingComentarios" class="text-center py-4">
                                <div class="surface-100 border-circle w-4rem h-4rem flex align-items-center justify-content-center mx-auto mb-2">
                                    <i class="pi pi-comment text-3xl text-400"></i>
                                </div>
                                <h6 class="text-600 m-0">No hay comentarios</h6>
                                <p class="text-500 text-sm m-0">Agregue el primer comentario</p>
                            </div>

                            <!-- LOADING -->
                            <div *ngIf="loadingComentarios" class="text-center py-4">
                                <i class="pi pi-spin pi-spinner text-3xl text-primary"></i>
                                <p class="text-500 mt-2 m-0">Cargando...</p>
                            </div>

                            <!-- COMENTARIOS -->
                            <div *ngFor="let comentario of comentarios; let i = index" class="comentario-card mb-3">
                                <div class="surface-50 border-round-lg p-3 border-left-3 border-primary shadow-1">
                                    <div class="flex justify-content-between align-items-start mb-2">
                                        <div class="flex align-items-center">
                                            <div class="bg-primary-reverse border-circle w-2rem h-2rem flex align-items-center justify-content-center mr-2">
                                                <i class="pi pi-user text-primary text-sm"></i>
                                            </div>
                                            <div>
                                                <div class="font-bold text-primary text-sm">{{ comentario.usuario || 'Sistema' }}</div>
                                                <small class="text-500">
                                                    <i class="pi pi-clock mr-1"></i>
                                                    {{ getFechaComentario(comentario.fechaCreacion) }}
                                                </small>
                                            </div>
                                        </div>
                                        <p-tag [value]="comentario.tipoComentario" 
                                               [severity]="getTipoComentarioSeverity(comentario.tipoComentario)"
                                               [rounded]="true" class="text-xs"></p-tag>
                                    </div>
                                    <div class="comment-content">
                                        <div class="line-height-3 text-700 m-0" [innerHTML]="renderComentarioConEnlaces(comentario.comentario)"></div>
                                        <div *ngIf="comentario.estadoAnterior && comentario.estadoNuevo" class="mt-2 p-2 surface-200 border-round">
                                            <div class="flex align-items-center text-sm flex-wrap gap-2">
                                                <i class="pi pi-arrow-right text-orange-500"></i>
                                                <span class="text-600">Estado:</span>
                                                <p-tag [value]="getEstadoLabel(comentario.estadoAnterior)" 
                                                       [severity]="getEstadoSeverity(comentario.estadoAnterior)" 
                                                       [rounded]="true" class="text-xs"></p-tag>
                                                <i class="pi pi-arrow-right"></i>
                                                <p-tag [value]="getEstadoLabel(comentario.estadoNuevo)" 
                                                       [severity]="getEstadoSeverity(comentario.estadoNuevo)" 
                                                       [rounded]="true" class="text-xs"></p-tag>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PANEL DERECHO: NUEVO COMENTARIO, ESTADO Y EVIDENCIAS -->
                <div class="col-12 lg:col-5">
                    <!-- NUEVO COMENTARIO -->
                    <div class="surface-card border-round-lg shadow-1 mb-3">
                        <div class="surface-50 border-round-top-lg p-2 border-bottom-1 surface-border">
                            <div class="flex align-items-center">
                                <i class="pi pi-plus-circle text-green-500 mr-2"></i>
                                <h6 class="m-0 text-sm">Nuevo Comentario</h6>
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="field mb-2">
                                <label class="block text-900 font-medium mb-1 text-sm"><i class="pi pi-tag mr-1"></i>Tipo</label>
                                <p-dropdown [(ngModel)]="tipoComentarioSeleccionado" 
                                            [options]="tiposComentario" 
                                            optionLabel="label" optionValue="value"
                                            placeholder="Seleccionar tipo" styleClass="w-full">
                                    <ng-template pTemplate="selectedItem" let-option>
                                        <p-tag *ngIf="option" [value]="option.label || option" 
                                               [severity]="getTipoComentarioSeverity(option.value || option)" [rounded]="true"></p-tag>
                                    </ng-template>
                                    <ng-template pTemplate="item" let-option>
                                        <p-tag [value]="option.label" [severity]="getTipoComentarioSeverity(option.value)" [rounded]="true"></p-tag>
                                    </ng-template>
                                </p-dropdown>
                            </div>
                            <div class="field mb-2">
                                <label class="block text-900 font-medium mb-1 text-sm"><i class="pi pi-pencil mr-1"></i>Comentario *</label>
                                <textarea pInputTextarea [(ngModel)]="nuevoComentario" rows="2" 
                                          placeholder="Escribe tu comentario..." class="w-full"></textarea>
                            </div>
                            <div class="flex justify-content-end">
                                <button pButton label="Agregar" icon="pi pi-send" class="p-button-primary p-button-sm"
                                        (click)="agregarComentario()"
                                        [disabled]="!(nuevoComentario && nuevoComentario.trim().length > 0)"></button>
                            </div>
                        </div>
                    </div>

                    <!-- CAMBIO DE ESTADO -->
                    <div class="surface-card border-round-lg shadow-1 mb-3">
                        <div class="surface-50 border-round-top-lg p-2 border-bottom-1 surface-border">
                            <div class="flex align-items-center">
                                <i class="pi pi-refresh text-orange-500 mr-2"></i>
                                <h6 class="m-0 text-sm">Cambiar Estado</h6>
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="flex gap-2 align-items-center">
                                <p-dropdown [(ngModel)]="nuevoEstadoSeleccionado" 
                                            [options]="estadosEdicion" 
                                            placeholder="Seleccionar estado" [showClear]="true" styleClass="flex-grow-1">
                                    <ng-template pTemplate="selectedItem" let-option>
                                        <p-tag *ngIf="option" [value]="getEstadoLabel(option)" 
                                               [severity]="getEstadoSeverity(option)" [rounded]="true"></p-tag>
                                    </ng-template>
                                    <ng-template pTemplate="item" let-option>
                                        <p-tag [value]="getEstadoLabel(option)" [severity]="getEstadoSeverity(option)" [rounded]="true"></p-tag>
                                    </ng-template>
                                </p-dropdown>
                                <button pButton icon="pi pi-refresh" class="p-button-warning p-button-sm"
                                        (click)="cambiarEstadoGestion()"
                                        [disabled]="!nuevoEstadoSeleccionado || nuevoEstadoSeleccionado === ejecucionGestion?.estado"
                                        pTooltip="Cambiar"></button>
                            </div>
                            <small class="text-500 mt-2 block">
                                <i class="pi pi-info-circle mr-1"></i>
                                Estado actual: <p-tag [value]="getEstadoLabel(ejecucionGestion?.estado || '')" [severity]="getEstadoSeverity(ejecucionGestion?.estado || '')" [rounded]="true" class="text-xs"></p-tag>
                            </small>
                        </div>
                    </div>

                    <!-- EVIDENCIAS -->
                    <div class="surface-card border-round-lg shadow-1">
                        <div class="surface-50 border-round-top-lg p-2 border-bottom-1 surface-border">
                            <div class="flex align-items-center justify-content-between">
                                <div class="flex align-items-center">
                                    <i class="pi pi-paperclip text-blue-500 mr-2"></i>
                                    <h6 class="m-0 text-sm">Evidencias</h6>
                                    <p-badge [value]="evidencias.length.toString()" severity="warning" class="ml-2"></p-badge>
                                </div>
                                <p-fileUpload #fileUploadGestion
                                              mode="basic" 
                                              [multiple]="true" 
                                              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                                              [maxFileSize]="10000000"
                                              chooseLabel="Subir"
                                              chooseIcon="pi pi-upload"
                                              (uploadHandler)="subirEvidenciaGestion($event)"
                                              [auto]="true"
                                              [customUpload]="true"
                                              class="p-button-sm">
                                </p-fileUpload>
                            </div>
                        </div>
                        <div class="p-3">
                            <p-progressBar *ngIf="uploading" [value]="uploadProgress" [showValue]="true" class="mb-2"></p-progressBar>
                            
                            <!-- Lista de evidencias -->
                            <div *ngIf="evidencias.length > 0" class="evidencias-list" style="max-height: 150px; overflow-y: auto;">
                                <div *ngFor="let evidencia of evidencias" 
                                     class="flex align-items-center justify-content-between p-2 surface-50 border-round mb-2">
                                    <div class="flex align-items-center min-w-0 flex-grow-1">
                                        <i [class]="getFileIcon(evidencia) + ' mr-2 text-xl'"></i>
                                        <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap text-sm" 
                                              [pTooltip]="evidencia.nombreOriginal">
                                            {{ evidencia.nombreOriginal }}
                                        </span>
                                    </div>
                                    <div class="flex-shrink-0 flex gap-1">
                                        <button pButton pRipple icon="pi pi-download" 
                                                class="p-button-rounded p-button-text p-button-sm p-button-info"
                                                (click)="downloadEvidencia(evidencia)" pTooltip="Descargar"></button>
                                        <button pButton pRipple icon="pi pi-trash" 
                                                class="p-button-rounded p-button-text p-button-sm p-button-danger"
                                                (click)="deleteEvidencia(evidencia)" pTooltip="Eliminar"></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div *ngIf="evidencias.length === 0" class="text-center py-2">
                                <i class="pi pi-folder-open text-2xl text-400"></i>
                                <p class="text-500 text-sm m-0 mt-1">Sin evidencias</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideGestionDialog()"></button>
    </ng-template>
</p-dialog>
