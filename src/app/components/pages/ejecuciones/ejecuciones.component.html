<div class="grid">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>
    
    <!-- T铆tulo y descripci贸n -->
    <div class="col-12">
        <div class="card">
            <h5>Ejecuciones de Mantenimiento</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Gestione y d茅 seguimiento a las ejecuciones de mantenimientos 
                programados, en proceso y completados.</p>
        </div>
    </div>

    <!-- Estad铆sticas -->
    <div class="col-12 md:col-3">
        <div class="card bg-orange-100 border-left-3 border-orange-500 cursor-pointer" (click)="setFiltroEstado('PROGRAMADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-orange-600 font-medium">Programados</span>
                    <div class="text-2xl font-bold text-orange-900">{{countProgramados}}</div>
                    <small *ngIf="countVencidas > 0" class="text-red-600 font-medium">
                        <i class="pi pi-exclamation-triangle mr-1"></i>{{countVencidas}} vencidas
                    </small>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-calendar text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-blue-100 border-left-3 border-blue-500 cursor-pointer" (click)="setFiltroEstado('EN_PROCESO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-blue-600 font-medium">En Proceso</span>
                    <div class="text-2xl font-bold text-blue-900">{{countEnProceso}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-spinner text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-green-100 border-left-3 border-green-500 cursor-pointer" (click)="setFiltroEstado('COMPLETADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-green-600 font-medium">Completados</span>
                    <div class="text-2xl font-bold text-green-900">{{countCompletados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-green-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-check-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-red-100 border-left-3 border-red-500 cursor-pointer" (click)="setFiltroEstado('CANCELADO')">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-red-600 font-medium">Cancelados</span>
                    <div class="text-2xl font-bold text-red-900">{{countCancelados}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-red-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-times-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de ejecuciones -->
    <div class="col-12">
        <div class="card">
            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <p-dropdown [options]="estadosFiltro" 
                                [(ngModel)]="filtroEstado"
                                (onChange)="onFiltroEstadoChange()"
                                placeholder="Filtrar por estado"
                                styleClass="mr-2">
                    </p-dropdown>
                    <button pButton pRipple label="Limpiar filtro" icon="pi pi-filter-slash" 
                        class="p-button-outlined p-button-secondary mr-2"
                        (click)="setFiltroEstado('')"
                        *ngIf="filtroEstado"></button>
                </ng-template>
                <ng-template pTemplate="right">
                    <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" class="p-button-outlined"
                        routerLink="/administracion/mantenimientos"
                        pTooltip="Ver programaciones en calendario"></button>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="ejecuciones" [loading]="loading" [paginator]="true" [rows]="10"
                [rowsPerPageOptions]="[10,20,50]" [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ejecuciones"
                [globalFilterFields]="['equipoNombre','contratoDescripcion','tipoMantenimiento','estado']"
                [rowHover]="true" dataKey="idEjecucion">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Registro de Ejecuciones</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                                placeholder="Buscar..." class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="equipoNombre">Equipo <p-sortIcon field="equipoNombre"></p-sortIcon></th>
                        <th pSortableColumn="tipoMantenimiento">Tipo <p-sortIcon field="tipoMantenimiento"></p-sortIcon></th>
                        <th pSortableColumn="fechaEjecucion">Fecha Programada <p-sortIcon field="fechaEjecucion"></p-sortIcon></th>
                        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                        <th style="width: 100px"></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-ejecucion>
                    <tr>
                        <!-- Equipo -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-desktop text-primary"></i>
                                <div>
                                    <div class="font-semibold text-900">{{ejecucion.equipoNombre || 'N/A'}}</div>
                                    <div class="text-xs text-500">{{ejecucion.equipoCodigo}}</div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Tipo de Mantenimiento -->
                        <td>
                            <p-tag [value]="ejecucion.tipoMantenimiento || 'N/A'"
                                [severity]="getTipoSeverity(ejecucion.tipoMantenimiento)"
                                [rounded]="true"></p-tag>
                        </td>
                        
                        <!-- Fecha Programada -->
                        <td>
                            <div class="flex align-items-center gap-2">
                                <span class="font-semibold" [class.text-red-600]="isVencida(ejecucion)">
                                    {{formatDate(ejecucion.fechaEjecucion)}}
                                </span>
                                <p-tag *ngIf="isVencida(ejecucion)" value="VENCIDA"
                                    severity="danger" [style]="{fontSize: '0.7rem'}"></p-tag>
                            </div>
                        </td>
                        
                        <!-- Estado -->
                        <td>
                            <p-tag [value]="getEstadoLabel(ejecucion.estado)"
                                   [severity]="getEstadoSeverity(ejecucion.estado)"
                                   [rounded]="true"></p-tag>
                        </td>
                        
                        <!-- Acciones -->
                        <td>
                            <div class="flex flex-nowrap align-items-center justify-content-center">
                                <button pButton pRipple icon="pi pi-eye"
                                    class="p-button-rounded p-button-text p-button-info"
                                    (click)="verDetalle(ejecucion)" pTooltip="Ver detalle"></button>
                                
                                <button pButton pRipple icon="pi pi-ellipsis-v"
                                    class="p-button-rounded p-button-text p-button-secondary"
                                    (click)="openAccionesMenu($event, ejecucion)"
                                    pTooltip="Acciones"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="5" class="text-center p-5">
                            <div class="flex flex-column align-items-center">
                                <i class="pi pi-inbox text-5xl text-400 mb-3"></i>
                                <span class="text-900 font-semibold text-xl mb-2">No hay ejecuciones registradas</span>
                                <span class="text-600 text-base mb-1">Las ejecuciones se crean desde el m贸dulo de Programaciones.</span>
                                <span class="text-500 text-sm mb-3">O puede crearlas directamente desde el Calendario.</span>
                                <button pButton pRipple label="Ir al Calendario" icon="pi pi-calendar" 
                                        class="p-button-success p-button-sm mt-2"
                                        routerLink="/administracion/mantenimientos"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
            
            <!-- Men煤 popup de acciones (fuera de la tabla) -->
            <p-menu #menuAcciones [popup]="true" [model]="accionesMenuItems" appendTo="body"></p-menu>
        </div>
    </div>
</div>


<!-- ==================== DIALOG DETALLE ==================== -->
<p-dialog [(visible)]="showDetalleDialog" [style]="{width: '650px'}" 
    header="Detalle de Ejecuci贸n" [modal]="true">
    
    <ng-template pTemplate="content">
        <div *ngIf="ejecucionDetalle" class="flex flex-column gap-4">
            <!-- Estado destacado -->
            <div class="text-center p-3 surface-100 border-round">
                <p-tag [value]="getEstadoLabel(ejecucionDetalle.estado)"
                       [severity]="getEstadoSeverity(ejecucionDetalle.estado)"
                       styleClass="text-lg px-3 py-2"></p-tag>
            </div>
            
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-50 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-3xl text-primary"></i>
                <div>
                    <div class="font-bold text-lg">{{ ejecucionDetalle.equipoNombre }}</div>
                    <div class="text-500">{{ ejecucionDetalle.equipoCodigo }}</div>
                </div>
            </div>
            
            <!-- Datos principales -->
            <div class="grid">
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-wrench mr-1"></i>Tipo de Mantenimiento
                        </label>
                        <p-tag [value]="ejecucionDetalle.tipoMantenimiento || 'N/A'"
                               [severity]="getTipoSeverity(ejecucionDetalle.tipoMantenimiento)"
                               [rounded]="true"></p-tag>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-calendar mr-1"></i>Fecha Programada
                        </label>
                        <div class="font-medium text-lg">{{ formatDate(ejecucionDetalle.fechaEjecucion) || 'No definida' }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-file mr-1"></i>Contrato
                        </label>
                        <div class="font-medium">{{ ejecucionDetalle.contratoDescripcion || 'N/A' }}</div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-building mr-1"></i>Proveedor
                        </label>
                        <div class="font-medium">{{ ejecucionDetalle.proveedorNombre || 'N/A' }}</div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="surface-100 p-3 border-round">
                        <label class="text-500 text-sm block mb-1">
                            <i class="pi pi-map-marker mr-1"></i>Ubicaci贸n del Equipo
                        </label>
                        <div class="font-medium">{{ ejecucionDetalle.equipoUbicacion || 'N/A' }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Fechas de ejecuci贸n -->
            <div class="grid" *ngIf="ejecucionDetalle.fechaInicioTrabajo || ejecucionDetalle.fechaCierre">
                <div class="col-6" *ngIf="ejecucionDetalle.fechaInicioTrabajo">
                    <div class="p-3 bg-blue-50 border-round border-left-3 border-blue-500">
                        <label class="text-blue-600 text-sm block mb-1">
                            <i class="pi pi-play mr-1"></i>Inicio de Trabajo
                        </label>
                        <div class="font-bold text-blue-900">{{ formatDate(ejecucionDetalle.fechaInicioTrabajo) }}</div>
                    </div>
                </div>
                <div class="col-6" *ngIf="ejecucionDetalle.fechaCierre">
                    <div class="p-3 bg-green-50 border-round border-left-3 border-green-500">
                        <label class="text-green-600 text-sm block mb-1">
                            <i class="pi pi-check mr-1"></i>Fecha de Cierre
                        </label>
                        <div class="font-bold text-green-900">{{ formatDate(ejecucionDetalle.fechaCierre) }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Bit谩cora -->
            <div *ngIf="ejecucionDetalle.bitacora">
                <label class="text-500 text-sm block mb-2">
                    <i class="pi pi-book mr-1"></i>Bit谩cora / Observaciones
                </label>
                <div class="p-3 surface-100 border-round white-space-pre-wrap border-left-3 border-300">
                    {{ ejecucionDetalle.bitacora }}
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDetalleDialog()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG INICIAR ==================== -->
<p-dialog [(visible)]="showIniciarDialog" [style]="{width: '500px'}" 
    header="Iniciar Trabajo de Mantenimiento" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <div class="p-3 bg-blue-50 border-round border-left-3 border-blue-500">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-blue-500"></i>
                    <span class="font-medium text-blue-700">Informaci贸n</span>
                </div>
                <p class="m-0 text-sm text-blue-600">
                    Al iniciar el trabajo, se registrar谩 la fecha y hora actual como inicio del mantenimiento.
                </p>
            </div>
            
            <div class="field">
                <label for="iniciarBitacora" class="font-medium">Notas iniciales (opcional)</label>
                <textarea id="iniciarBitacora" 
                    pInputTextarea 
                    [(ngModel)]="iniciarBitacora"
                    rows="3" 
                    placeholder="Observaciones al iniciar el trabajo..."
                    class="w-full">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideIniciarDialog()"></button>
        <button pButton pRipple label="Iniciar Trabajo" icon="pi pi-play" 
            class="p-button-info" 
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarIniciar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG COMPLETAR ==================== -->
<p-dialog [(visible)]="showCompletarDialog" [style]="{width: '550px'}" 
    header="Completar Mantenimiento" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <!-- Tiempo de trabajo -->
            <div *ngIf="selectedEjecucion.fechaInicioTrabajo" class="p-3 bg-green-50 border-round border-left-3 border-green-500">
                <div class="flex align-items-center gap-2 mb-1">
                    <i class="pi pi-clock text-green-500"></i>
                    <span class="font-medium text-green-700">Tiempo de trabajo</span>
                </div>
                <p class="m-0 text-sm text-green-600">
                    Iniciado: {{ formatDate(selectedEjecucion.fechaInicioTrabajo) }}
                </p>
            </div>
            
            <div class="field">
                <label for="completarObservaciones" class="font-medium">
                    Observaciones de cierre <span class="text-red-500">*</span>
                </label>
                <textarea id="completarObservaciones" 
                    pInputTextarea 
                    [(ngModel)]="completarObservaciones"
                    rows="4" 
                    placeholder="Describa el trabajo realizado, hallazgos, recomendaciones..."
                    class="w-full">
                </textarea>
                <small class="text-500">Estas observaciones se agregar谩n a la bit谩cora</small>
            </div>
            
            <div class="p-3 bg-orange-50 border-round border-left-3 border-orange-500">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-exclamation-triangle text-orange-500"></i>
                    <span class="text-sm text-orange-700">
                        No olvide adjuntar evidencias antes de completar el mantenimiento.
                    </span>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideCompletarDialog()"></button>
        <button pButton pRipple label="Adjuntar Evidencias" icon="pi pi-paperclip" 
            class="p-button-outlined p-button-help" 
            (click)="hideCompletarDialog(); openEvidencias(selectedEjecucion)"></button>
        <button pButton pRipple label="Completar" icon="pi pi-check" 
            class="p-button-success" 
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarCompletar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG CANCELAR ==================== -->
<p-dialog [(visible)]="showCancelarDialog" [style]="{width: '500px'}" 
    header="Cancelar Ejecuci贸n" [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Info del equipo -->
            <div class="flex align-items-center gap-3 p-3 surface-100 border-round border-left-3 border-primary">
                <i class="pi pi-cog text-2xl text-primary"></i>
                <div>
                    <div class="font-bold">{{ selectedEjecucion.equipoNombre }}</div>
                    <small class="text-500">{{ selectedEjecucion.contratoDescripcion }}</small>
                </div>
            </div>
            
            <div class="p-3 bg-red-50 border-round border-left-3 border-red-500">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-exclamation-triangle text-red-500"></i>
                    <span class="font-medium text-red-700">Atenci贸n</span>
                </div>
                <p class="m-0 text-sm text-red-600">
                    Esta acci贸n cancelar谩 la ejecuci贸n del mantenimiento. 
                    Deber谩 indicar el motivo de la cancelaci贸n.
                </p>
            </div>
            
            <div class="field">
                <label for="cancelarMotivo" class="font-medium">
                    Motivo de cancelaci贸n <span class="text-red-500">*</span>
                </label>
                <textarea id="cancelarMotivo" 
                    pInputTextarea 
                    [(ngModel)]="cancelarMotivo"
                    rows="3" 
                    placeholder="Indique por qu茅 se cancela este mantenimiento..."
                    class="w-full">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Volver" icon="pi pi-arrow-left" 
            class="p-button-text" (click)="hideCancelarDialog()"></button>
        <button pButton pRipple label="Confirmar Cancelaci贸n" icon="pi pi-times" 
            class="p-button-danger" 
            [disabled]="!cancelarMotivo.trim()"
            [loading]="accionLoadingId === selectedEjecucion.idEjecucion"
            (click)="confirmarCancelar()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG EDITAR ==================== -->
<p-dialog [(visible)]="showDialog" [style]="{width: '700px'}" 
    [header]="isEditMode ? 'Editar Ejecuci贸n' : 'Nueva Ejecuci贸n'" 
    [modal]="true" [maximizable]="true" class="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Secci贸n: Datos Generales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-file-edit mr-2"></i>Datos de la Ejecuci贸n
        </div>
        
        <div class="formgrid grid">
            <!-- Info del contrato y equipo (solo lectura en edici贸n) -->
            <div *ngIf="isEditMode" class="field col-12">
                <div class="surface-100 border-round p-3">
                    <div class="flex align-items-center gap-2 mb-2">
                        <i class="pi pi-file-edit text-primary"></i>
                        <span class="font-semibold">{{ selectedEjecucion.contratoDescripcion }}</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-cog text-500"></i>
                        <span>{{ selectedEjecucion.equipoNombre }}</span>
                        <span class="text-500">|</span>
                        <span class="text-500">{{ selectedEjecucion.proveedorNombre }}</span>
                    </div>
                </div>
            </div>

            <!-- Selecci贸n de contrato (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="contrato" class="font-medium">Contrato <span class="text-red-500">*</span></label>
                <p-dropdown id="contrato" 
                    [(ngModel)]="selectedEjecucion.idContrato"
                    [options]="contratos" 
                    optionLabel="descripcion" 
                    optionValue="idContrato"
                    placeholder="Seleccione un contrato"
                    [filter]="true"
                    filterBy="descripcion,proveedor.nombre"
                    [showClear]="true"
                    (onChange)="onContratoChange()"
                    styleClass="w-full">
                    <ng-template pTemplate="selectedItem">
                        <div *ngIf="selectedEjecucion.idContrato">
                            {{ getContratoDescripcion(selectedEjecucion.idContrato) }}
                        </div>
                    </ng-template>
                    <ng-template let-contrato pTemplate="item">
                        <div>
                            <div class="font-bold">{{ contrato.descripcion }}</div>
                            <small class="text-gray-500">{{ contrato.proveedor?.nombre }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Selecci贸n de equipo (solo al crear) -->
            <div *ngIf="!isEditMode" class="field col-12 md:col-6">
                <label for="equipo" class="font-medium">Equipo <span class="text-red-500">*</span></label>
                <p-dropdown id="equipo" 
                    [(ngModel)]="selectedEjecucion.idEquipo"
                    [options]="equiposContrato" 
                    optionLabel="nombre" 
                    optionValue="idEquipo"
                    placeholder="Seleccione un equipo"
                    [disabled]="!selectedEjecucion.idContrato"
                    [filter]="true"
                    filterBy="nombre,codigoInacif"
                    styleClass="w-full">
                    <ng-template let-equipo pTemplate="item">
                        <div>
                            <div class="font-bold">{{ equipo.nombre }}</div>
                            <small class="text-gray-500">{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small *ngIf="!selectedEjecucion.idContrato" class="text-orange-500">
                    Primero seleccione un contrato
                </small>
            </div>
            
            <!-- Fecha de ejecuci贸n -->
            <div class="field col-12 md:col-6">
                <label for="fechaEjecucion" class="font-medium">Fecha Programada <span class="text-red-500">*</span></label>
                <p-calendar id="fechaEjecucion" 
                    [(ngModel)]="selectedEjecucion.fechaEjecucion"
                    dateFormat="dd/mm/yy"
                    [showIcon]="true"
                    styleClass="w-full">
                </p-calendar>
            </div>
            
            <!-- Estado -->
            <div class="field col-12 md:col-6">
                <label for="estado" class="font-medium">Estado</label>
                <p-dropdown id="estado"
                    [(ngModel)]="selectedEjecucion.estado"
                    [options]="estadoOptions"
                    placeholder="Seleccione estado"
                    styleClass="w-full">
                </p-dropdown>
            </div>
            
            <!-- Bit谩cora -->
            <div class="field col-12">
                <label for="bitacora" class="font-medium">Bit谩cora / Observaciones</label>
                <textarea id="bitacora" 
                    pInputTextarea 
                    [(ngModel)]="selectedEjecucion.bitacora"
                    rows="4" 
                    placeholder="Descripci贸n del mantenimiento, observaciones, hallazgos...">
                </textarea>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
            class="p-button-success"
            (click)="saveEjecucion()"></button>
    </ng-template>
</p-dialog>


<!-- ==================== DIALOG DE GESTIN (COMENTARIOS + EVIDENCIAS + ESTADOS) ==================== -->
<p-dialog [(visible)]="showGestionDialog" [style]="{width: '90vw', height: '90vh'}" 
    header=" Gesti贸n de Ejecuci贸n" [modal]="true" [maximizable]="true" [draggable]="true" [resizable]="true">
    
    <ng-template pTemplate="content">
        <div class="gestion-container" *ngIf="ejecucionGestion">
            <!-- HEADER DE LA EJECUCIN -->
            <div class="ejecucion-header mb-4">
                <div class="surface-100 border-round-lg p-4 shadow-1">
                    <div class="flex flex-wrap justify-content-between align-items-center gap-3">
                        <div class="flex align-items-center">
                            <div class="bg-primary border-circle w-3rem h-3rem flex align-items-center justify-content-center mr-3">
                                <i class="pi pi-cog text-white text-xl"></i>
                            </div>
                            <div>
                                <h5 class="m-0 text-primary">{{ ejecucionGestion.equipoNombre }}</h5>
                                <p class="text-600 mt-1 mb-0">{{ ejecucionGestion.equipoCodigo }}</p>
                                <small class="text-500">
                                    <i class="pi pi-calendar mr-1"></i>
                                    Programado: {{ formatDate(ejecucionGestion.fechaEjecucion) }}
                                </small>
                            </div>
                        </div>
                        <div class="flex flex-column align-items-end gap-2">
                            <p-tag [value]="getEstadoLabel(ejecucionGestion.estado)" 
                                   [severity]="getEstadoSeverity(ejecucionGestion.estado)" 
                                   [rounded]="true" class="text-sm"></p-tag>
                            <p-tag *ngIf="ejecucionGestion.tipoMantenimiento"
                                   [value]="ejecucionGestion.tipoMantenimiento" 
                                   [severity]="getTipoSeverity(ejecucionGestion.tipoMantenimiento)" 
                                   [rounded]="true" class="text-sm"></p-tag>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid">
                <!-- PANEL DE COMENTARIOS -->
                <div class="col-12 lg:col-7">
                    <div class="surface-card border-round-lg shadow-1 h-full">
                        <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                            <div class="flex align-items-center">
                                <i class="pi pi-comments text-primary mr-2"></i>
                                <h6 class="m-0">Historial de Seguimiento</h6>
                                <p-badge [value]="comentarios.length.toString()" severity="info" class="ml-2"></p-badge>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            <div class="comentarios-scroll" style="max-height: 400px; overflow-y: auto; padding-right: 8px;">
                                <!-- ESTADO VACO -->
                                <div *ngIf="comentarios.length === 0 && !loadingComentarios" class="text-center py-6">
                                    <div class="surface-100 border-circle w-6rem h-6rem flex align-items-center justify-content-center mx-auto mb-3">
                                        <i class="pi pi-comment text-4xl text-400"></i>
                                    </div>
                                    <h6 class="text-600">No hay comentarios</h6>
                                    <p class="text-500 text-sm m-0">Agregue el primer comentario de seguimiento</p>
                                </div>

                                <!-- LOADING -->
                                <div *ngIf="loadingComentarios" class="text-center py-6">
                                    <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                                    <p class="text-500 mt-2">Cargando comentarios...</p>
                                </div>

                                <!-- COMENTARIOS -->
                                <div *ngFor="let comentario of comentarios; let i = index" class="comentario-card mb-3">
                                    <div class="surface-50 border-round-lg p-3 border-left-3 border-primary shadow-1">
                                        <!-- Header del comentario -->
                                        <div class="flex justify-content-between align-items-start mb-2">
                                            <div class="flex align-items-center">
                                                <div class="bg-primary-reverse border-circle w-2rem h-2rem flex align-items-center justify-content-center mr-2">
                                                    <i class="pi pi-user text-primary text-sm"></i>
                                                </div>
                                                <div>
                                                    <div class="font-bold text-primary text-sm">{{ comentario.usuario || 'Sistema' }}</div>
                                                    <small class="text-500">
                                                        <i class="pi pi-clock mr-1"></i>
                                                        {{ comentario.fechaCreacion | date:'short' }}
                                                    </small>
                                                </div>
                                            </div>
                                            <p-tag [value]="comentario.tipoComentario" 
                                                   [severity]="getTipoComentarioSeverity(comentario.tipoComentario)"
                                                   [rounded]="true" class="text-xs"></p-tag>
                                        </div>
                                        
                                        <!-- Contenido del comentario -->
                                        <div class="comment-content">
                                            <p class="line-height-3 text-700 m-0">{{ comentario.comentario }}</p>
                                            
                                            <!-- MOSTRAR CAMBIO DE ESTADO SI EXISTE -->
                                            <div *ngIf="comentario.estadoAnterior && comentario.estadoNuevo" class="mt-3 p-2 surface-200 border-round">
                                                <div class="flex align-items-center text-sm flex-wrap gap-2">
                                                    <i class="pi pi-arrow-right text-orange-500"></i>
                                                    <span class="text-600">Estado cambi贸 de</span>
                                                    <p-tag [value]="getEstadoLabel(comentario.estadoAnterior)" 
                                                           [severity]="getEstadoSeverity(comentario.estadoAnterior)" 
                                                           [rounded]="true" class="text-xs"></p-tag>
                                                    <span class="text-600">a</span>
                                                    <p-tag [value]="getEstadoLabel(comentario.estadoNuevo)" 
                                                           [severity]="getEstadoSeverity(comentario.estadoNuevo)" 
                                                           [rounded]="true" class="text-xs"></p-tag>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PANEL DE AGREGAR COMENTARIO -->
                <div class="col-12 lg:col-5">
                    <div class="surface-card border-round-lg shadow-1 mb-3">
                        <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                            <div class="flex align-items-center">
                                <i class="pi pi-plus-circle text-green-500 mr-2"></i>
                                <h6 class="m-0">Nuevo Comentario</h6>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <!-- CAMBIO DE ESTADO -->
                            <div class="field mb-3">
                                <label for="nuevoEstado" class="block text-900 font-medium mb-2">
                                    <i class="pi pi-refresh mr-1"></i>
                                    Cambiar Estado (Opcional)
                                </label>
                                <p-dropdown id="nuevoEstado"
                                            [(ngModel)]="nuevoEstadoSeleccionado" 
                                            [options]="estadosEdicion" 
                                            placeholder="Mantener estado actual"
                                            [showClear]="true"
                                            styleClass="w-full">
                                    <ng-template pTemplate="selectedItem" let-option>
                                        <div class="flex align-items-center" *ngIf="option">
                                            <p-tag [value]="getEstadoLabel(option)" 
                                                   [severity]="getEstadoSeverity(option)" 
                                                   [rounded]="true" class="mr-2"></p-tag>
                                        </div>
                                    </ng-template>
                                    <ng-template pTemplate="item" let-option>
                                        <div class="flex align-items-center">
                                            <p-tag [value]="getEstadoLabel(option)" 
                                                   [severity]="getEstadoSeverity(option)" 
                                                   [rounded]="true" class="mr-2"></p-tag>
                                        </div>
                                    </ng-template>
                                </p-dropdown>
                            </div>

                            <!-- TIPO DE COMENTARIO -->
                            <div class="field mb-3">
                                <label for="tipoComentario" class="block text-900 font-medium mb-2">
                                    <i class="pi pi-tag mr-1"></i>
                                    Tipo de Comentario
                                </label>
                                <p-dropdown id="tipoComentario"
                                            [(ngModel)]="tipoComentarioSeleccionado" 
                                            [options]="tiposComentario" 
                                            optionLabel="label"
                                            optionValue="value"
                                            placeholder="Seleccionar tipo"
                                            styleClass="w-full">
                                    <ng-template pTemplate="selectedItem" let-option>
                                        <div class="flex align-items-center" *ngIf="option">
                                            <p-tag [value]="option.label || option" 
                                                   [severity]="getTipoComentarioSeverity(option.value || option)" 
                                                   [rounded]="true" class="mr-2"></p-tag>
                                        </div>
                                    </ng-template>
                                    <ng-template pTemplate="item" let-option>
                                        <div class="flex align-items-center">
                                            <p-tag [value]="option.label" 
                                                   [severity]="getTipoComentarioSeverity(option.value)" 
                                                   [rounded]="true" class="mr-2"></p-tag>
                                        </div>
                                    </ng-template>
                                </p-dropdown>
                            </div>

                            <!-- TEXTO DEL COMENTARIO -->
                            <div class="field mb-3">
                                <label for="comentarioTexto" class="block text-900 font-medium mb-2">
                                    <i class="pi pi-pencil mr-1"></i>
                                    Comentario *
                                </label>
                                <textarea pInputTextarea 
                                          id="comentarioTexto" 
                                          [(ngModel)]="nuevoComentario" 
                                          rows="4" 
                                          placeholder="Escribe tu comentario aqu铆..."
                                          class="w-full"
                                          [autoResize]="true"></textarea>
                                <small class="text-500">{{ (nuevoComentario || '').length }} caracteres</small>
                            </div>

                            <!-- BOTN DE AGREGAR -->
                            <div class="flex justify-content-end">
                                <button pButton pRipple 
                                        label="Agregar Comentario" 
                                        icon="pi pi-send" 
                                        class="p-button-primary"
                                        (click)="agregarComentario()"
                                        [disabled]="!(nuevoComentario && nuevoComentario.trim().length > 0)">
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- SECCIN DE EVIDENCIAS -->
                    <div class="surface-card border-round-lg shadow-1">
                        <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                            <div class="flex align-items-center justify-content-between">
                                <div class="flex align-items-center">
                                    <i class="pi pi-paperclip text-orange-500 mr-2"></i>
                                    <h6 class="m-0">Evidencias</h6>
                                    <p-badge [value]="evidencias.length.toString()" severity="warning" class="ml-2"></p-badge>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-3">
                            <!-- Upload de archivos -->
                            <div class="mb-3">
                                <p-fileUpload mode="basic" 
                                              [multiple]="true" 
                                              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                                              [maxFileSize]="10000000"
                                              chooseLabel="Subir Archivos"
                                              chooseIcon="pi pi-upload"
                                              (uploadHandler)="subirEvidenciaGestion($event)"
                                              [auto]="true"
                                              [customUpload]="true"
                                              styleClass="w-full">
                                </p-fileUpload>
                                <p-progressBar *ngIf="uploading" [value]="uploadProgress" [showValue]="true" class="mt-2"></p-progressBar>
                            </div>

                            <!-- Lista de evidencias -->
                            <div *ngIf="evidencias.length > 0" class="evidencias-list" style="max-height: 200px; overflow-y: auto;">
                                <div *ngFor="let evidencia of evidencias" 
                                     class="flex align-items-center justify-content-between p-2 surface-50 border-round mb-2">
                                    <div class="flex align-items-center min-w-0 flex-grow-1">
                                        <i [class]="getFileIcon(evidencia) + ' mr-2 text-xl'"></i>
                                        <span class="text-overflow-ellipsis overflow-hidden white-space-nowrap text-sm" 
                                              [pTooltip]="evidencia.nombreOriginal">
                                            {{ evidencia.nombreOriginal }}
                                        </span>
                                    </div>
                                    <div class="flex-shrink-0 flex gap-1">
                                        <button pButton pRipple icon="pi pi-download" 
                                                class="p-button-rounded p-button-text p-button-sm"
                                                (click)="downloadEvidencia(evidencia)"
                                                pTooltip="Descargar"></button>
                                        <button pButton pRipple icon="pi pi-trash" 
                                                class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                                (click)="deleteEvidencia(evidencia)"
                                                pTooltip="Eliminar"></button>
                                    </div>
                                </div>
                            </div>
                            
                            <div *ngIf="evidencias.length === 0" class="text-center py-3">
                                <i class="pi pi-folder-open text-3xl text-400"></i>
                                <p class="text-500 text-sm m-0 mt-2">Sin evidencias adjuntas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
            class="p-button-text" (click)="hideGestionDialog()"></button>
    </ng-template>
</p-dialog>
