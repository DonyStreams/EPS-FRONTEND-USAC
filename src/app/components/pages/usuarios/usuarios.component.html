<div class="card">
    <h5>Gestión de Usuarios del Sistema</h5>
    
    <!-- Información importante -->
    <div class="mb-3">
        <p-message severity="info" text="Los usuarios se sincronizan automáticamente desde Keycloak al hacer login. Aquí puede ver la lista de usuarios sincronizados."></p-message>
    </div>
    
    <!-- Estadísticas -->
    <div class="grid mb-3">
        <div class="col-12 md:col-4">
            <div class="card bg-blue-100 border-left-3 border-blue-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-blue-600 font-medium">Total</span>
                        <div class="text-2xl font-bold text-blue-900">{{ stats.total }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-blue-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-users text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-4">
            <div class="card bg-green-100 border-left-3 border-green-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-green-600 font-medium">Activos</span>
                        <div class="text-2xl font-bold text-green-900">{{ stats.activos }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-green-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-check-circle text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-4">
            <div class="card bg-red-100 border-left-3 border-red-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-red-600 font-medium">Inactivos</span>
                        <div class="text-2xl font-bold text-red-900">{{ stats.inactivos }}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-red-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-times-circle text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
            <button pButton pRipple label="Mi Info" icon="pi pi-user" class="p-button-secondary mr-2" (click)="getCurrentUserInfo()"
                    pTooltip="Ver información de tu usuario actual"></button>
            <button pButton pRipple label="Actualizar" icon="pi pi-refresh" class="p-button-help mr-2" 
                    [loading]="loading" (click)="refreshData()"
                    pTooltip="Recargar datos desde el servidor"></button>
        </ng-template>
        <ng-template pTemplate="right">
            <button pButton pRipple label="Gestión Completa en Keycloak" icon="pi pi-external-link" class="p-button-outlined" 
                    (click)="openKeycloakConsole()"></button>
        </ng-template>
    </p-toolbar>

    <p-table [value]="usuarios" [loading]="loading" styleClass="p-datatable-gridlines" [paginator]="true" [rows]="10" 
             responsiveLayout="scroll" [globalFilterFields]="['nombreCompleto','correo','keycloakId']" #dt>
        
        <ng-template pTemplate="caption">
            <div class="flex">
                <span class="p-input-icon-left ml-auto">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (input)="dt.filterGlobal($any($event.target).value, 'contains')" 
                           placeholder="Buscar por nombre, correo o ID..." />
                </span>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="id">ID <p-sortIcon field="id"></p-sortIcon></th>
                <th pSortableColumn="nombreCompleto">Nombre Completo <p-sortIcon field="nombreCompleto"></p-sortIcon></th>
                <th pSortableColumn="correo">Correo <p-sortIcon field="correo"></p-sortIcon></th>
                <th pSortableColumn="keycloakId">Keycloak ID <p-sortIcon field="keycloakId"></p-sortIcon></th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-usuario>
            <tr>
                <td>
                    <span class="p-column-title">ID</span>
                    <span class="font-bold">{{ usuario.id }}</span>
                </td>
                <td>
                    <span class="p-column-title">Nombre</span>
                    {{ usuario.nombreCompleto }}
                </td>
                <td>
                    <span class="p-column-title">Correo</span>
                    <a [href]="'mailto:' + usuario.correo" class="text-blue-600">{{ usuario.correo }}</a>
                </td>
                <td>
                    <span class="p-column-title">Keycloak ID</span>
                    <span class="text-sm text-gray-600 font-mono">{{ usuario.keycloakId }}</span>
                </td>
                <td>
                    <span class="p-column-title">Estado</span>
                    <p-tag [value]="usuario.activo ? 'Activo' : 'Inactivo'" 
                           [severity]="usuario.activo ? 'success' : 'danger'"></p-tag>
                </td>
                <td>
                    <div class="flex justify-content-center">
                        <button pButton pRipple 
                                [icon]="usuario.activo ? 'pi pi-ban' : 'pi pi-check'" 
                                [class]="usuario.activo ? 'p-button-rounded p-button-warning' : 'p-button-rounded p-button-success'" 
                                (click)="toggleEstado(usuario)" 
                                [pTooltip]="usuario.activo ? 'Desactivar acceso al sistema' : 'Activar acceso al sistema'"></button>
                    </div>
                </td>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="6">
                    <div class="text-center p-4">
                        <i class="pi pi-users" style="font-size: 3rem; color: #ccc;"></i>
                        <p class="text-gray-600 mt-2">No hay usuarios sincronizados</p>
                        <p class="text-sm text-gray-500">Los usuarios se sincronizarán automáticamente al hacer login en el sistema</p>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
