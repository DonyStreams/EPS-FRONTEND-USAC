<div class="grid">
    <div class="col-12">
        <div class="card">
            <!-- T칤tulo y descripci칩n -->
            <h5>Gesti칩n de Tickets de Soporte</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Administre tickets de fallas, mantenimientos correctivos y seguimiento de equipos del laboratorio.</p>
            
            <!-- Estad칤sticas principales -->
            <div class="grid mb-3">
                <div class="col-12 md:col-3">
                    <div class="surface-card shadow-1 border-round p-3 flex align-items-center justify-content-between">
                        <div class="bg-blue-100 border-circle p-3 mr-3">
                            <i class="pi pi-ticket text-blue-500 text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="text-600 text-sm">Total Tickets</span>
                            <div class="text-900 font-bold text-2xl">{{statsTickets.total}}</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-3">
                    <div class="surface-card shadow-1 border-round p-3 flex align-items-center justify-content-between">
                        <div class="bg-orange-100 border-circle p-3 mr-3">
                            <i class="pi pi-folder-open text-orange-500 text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="text-600 text-sm">Tickets Abiertos</span>
                            <div class="text-900 font-bold text-2xl">{{statsTickets.abiertos}}</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-3">
                    <div class="surface-card shadow-1 border-round p-3 flex align-items-center justify-content-between">
                        <div class="bg-purple-100 border-circle p-3 mr-3">
                            <i class="pi pi-cog text-purple-500 text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="text-600 text-sm">En Proceso</span>
                            <div class="text-900 font-bold text-2xl">{{statsTickets.enProceso}}</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 md:col-3">
                    <div class="surface-card shadow-1 border-round p-3 flex align-items-center justify-content-between">
                        <div class="bg-green-100 border-circle p-3 mr-3">
                            <i class="pi pi-check-circle text-green-500 text-2xl"></i>
                        </div>
                        <div class="text-right">
                            <span class="text-600 text-sm">Tickets Resueltos</span>
                            <div class="text-900 font-bold text-2xl">{{statsTickets.resueltos}}</div>
                            <small class="text-red-500 font-semibold" *ngIf="statsTickets.prioridadAlta > 0">
                                <i class="pi pi-exclamation-triangle mr-1"></i>{{ statsTickets.prioridadAlta }} alta prioridad
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <button pButton pRipple label="Nuevo Ticket" icon="pi pi-plus" 
                            class="p-button-success mr-2" (click)="abrirNuevoTicket()"></button>
                </ng-template>
            </p-toolbar>

            <p-table
                #dt
                [value]="tickets"
                [columns]="cols"
                responsiveLayout="scroll"
                [rows]="10"
                [globalFilterFields]="['descripcion','estado','prioridad']"
                [paginator]="true"
                [rowsPerPageOptions]="[10,20,30]"
                [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} tickets"
                [(selection)]="selectedTickets"
                selectionMode="multiple"
                [rowHover]="true"
                dataKey="id">
                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Gesti칩n de Tickets</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." class="w-full sm:w-auto"/>
                        </span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr>
                        <th style="width: 3rem">
                            <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                        </th>
                        <th pSortableColumn="descripcion">Descripci칩n <p-sortIcon field="descripcion"></p-sortIcon></th>
                        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
                        <th pSortableColumn="prioridad">Prioridad <p-sortIcon field="prioridad"></p-sortIcon></th>
                        <th pSortableColumn="fechaCreacion">Fecha <p-sortIcon field="fechaCreacion"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-ticket>
                    <tr>
                        <td>
                            <p-tableCheckbox [value]="ticket"></p-tableCheckbox>
                        </td>
                        <td style="width:45%; min-width:15rem;">
                            <span class="p-column-title">Descripci칩n</span>
                            {{ticket.descripcion}}
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Estado</span>
                            <p-tag [value]="ticket.estado" [severity]="getSeverity(ticket.estado)"></p-tag>
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Prioridad</span>
                            <p-tag [value]="ticket.prioridad" [severity]="getPrioridadSeverity(ticket.prioridad)"></p-tag>
                        </td>
                        <td style="width:14%; min-width:10rem;">
                            <span class="p-column-title">Fecha</span>
                            {{ticket.fechaCreacion | date:'short'}}
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button pButton pRipple icon="pi pi-comments" class="p-button-rounded p-button-text p-button-success" (click)="verComentarios(ticket)" pTooltip="Ver comentarios"></button>
                                <button pButton pRipple icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-warning" (click)="editarTicket(ticket)" pTooltip="Editar"></button>
                                <button pButton pRipple icon="pi pi-trash" class="p-button-rounded p-button-text p-button-danger" (click)="confirmarEliminarTicket(ticket)" pTooltip="Eliminar"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center p-5">
                            <div class="flex flex-column align-items-center justify-content-center">
                                <i class="pi pi-ticket text-5xl text-400 mb-3"></i>
                                <p class="text-xl font-medium mt-0 mb-2">No hay tickets registrados</p>
                                <p class="text-600 mt-0">Los tickets de soporte y fallas aparecer치n aqu칤</p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <p-dialog [(visible)]="dialogNuevoTicket" [style]="{width: '450px'}" header="Nuevo Ticket" [modal]="true" class="p-fluid">
            <ng-template pTemplate="content">
                <div class="field">
                    <label for="descripcion">Descripci칩n</label>
                    <textarea pInputTextarea id="descripcion" [(ngModel)]="nuevoTicket.descripcion" required rows="4" autofocus></textarea>
                </div>
                <div class="field">
                    <label for="estado">
                        <i class="pi pi-info-circle mr-1 text-blue-500"></i>
                        Estado Inicial
                    </label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-flag"></i>
                        </span>
                        <input 
                            type="text" 
                            pInputText 
                            value="Abierto" 
                            readonly 
                            class="p-inputtext-sm surface-100 text-900"
                            style="font-weight: 500;">
                    </div>
                    <small class="text-500">Todos los tickets nuevos inician con estado "Abierto"</small>
                </div>
                <div class="field">
                    <label for="prioridad">Prioridad</label>
                    <p-dropdown id="prioridad" [(ngModel)]="nuevoTicket.prioridad" [options]="prioridades" placeholder="Seleccionar prioridad"></p-dropdown>
                </div>
                <div class="field">
                    <label for="equipo">Equipo</label>
                    <p-dropdown 
                        appendTo="body"
                        id="equipo"
                        [(ngModel)]="nuevoTicket.equipoId" 
                        [options]="equipos" 
                        optionLabel="nombre"
                        optionValue="idEquipo"
                        placeholder="Seleccionar equipo"
                        [filter]="true"
                        filterBy="nombre,codigoInacif"
                        [showClear]="true"
                        class="w-full"
                        required>
                        <ng-template pTemplate="selectedItem" let-selectedEquipo>
                            <div class="flex align-items-center" *ngIf="selectedEquipo">
                                <div>{{selectedEquipo.nombre}} - {{selectedEquipo.codigoInacif}}</div>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-equipo>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{equipo.nombre}}</div>
                                    <div class="text-sm text-gray-500">{{equipo.codigoInacif}} - {{equipo.ubicacion}}</div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small class="text-500">Equipo relacionado con el ticket</small>
                </div>
                <div class="field">
                    <label>Usuario Creador</label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-user"></i>
                        </span>
                        <input type="text" pInputText [value]="usuarioActual?.nombreCompleto || 'Usuario actual'" disabled />
                    </div>
                    <small class="text-500">Se asigna autom치ticamente al usuario autenticado.</small>
                </div>
                <div class="field">
                    <label for="usuarioAsignado">Asignar a</label>
                    <p-dropdown 
                        id="usuarioAsignado"
                        [(ngModel)]="nuevoTicket.usuarioAsignadoId" 
                        [options]="usuarios" 
                        optionLabel="nombreCompleto"
                        optionValue="id"
                        placeholder="Seleccionar responsable"
                        [filter]="true"
                        appendTo="body"
                        filterBy="nombreCompleto,correo"
                        [showClear]="true"
                        class="w-full">
                        <ng-template pTemplate="selectedItem" let-selectedUsuario>
                            <div class="flex align-items-center" *ngIf="selectedUsuario">
                                <div>{{selectedUsuario.nombreCompleto}}</div>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-usuario>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{usuario.nombreCompleto}}</div>
                                    <div class="text-sm text-gray-500">{{usuario.correo}}</div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small class="text-500">Seleccione el t칠cnico responsable (opcional)</small>
                </div>
            </ng-template>

            <ng-template pTemplate="footer">
                <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="dialogNuevoTicket = false"></button>
                <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text" (click)="guardarNuevoTicket()"></button>
            </ng-template>
        </p-dialog>

        <!-- Modal Editar Ticket -->
        <p-dialog [(visible)]="dialogEditarTicket" [style]="{width: '450px'}" header="Editar Ticket" [modal]="true" class="p-fluid">
            <ng-template pTemplate="content">
                <div class="field">
                    <label for="editDescripcion">Descripci칩n</label>
                    <textarea pInputTextarea id="editDescripcion" [(ngModel)]="ticketEditando.descripcion" required rows="4"></textarea>
                </div>
                <div class="field">
                    <label for="editEstado">Estado</label>
                    <p-dropdown id="editEstado" [(ngModel)]="ticketEditando.estado" [options]="estadosEdicion" placeholder="Seleccionar estado"></p-dropdown>
                </div>
                <div class="field">
                    <label for="editPrioridad">Prioridad</label>
                    <p-dropdown id="editPrioridad" [(ngModel)]="ticketEditando.prioridad" [options]="prioridades" placeholder="Seleccionar prioridad"></p-dropdown>
                </div>
                <div class="field">
                    <label>Usuario Creador</label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-user"></i>
                        </span>
                        <input 
                            pInputText 
                            [value]="ticketEditando.usuarioCreador || ticket.usuarioCreador || usuarioActual?.nombreCompleto"
                            readonly
                            class="w-full surface-100 text-900 font-semibold" />
                    </div>
                </div>
                <div class="field">
                    <label for="editEquipo">Equipo</label>
                    <p-dropdown 
                        id="editEquipo"
                        [(ngModel)]="equipoSeleccionado" 
                        [options]="equipos" 
                        optionLabel="nombre"
                        placeholder="Seleccionar equipo"
                        [filter]="true"
                        filterBy="nombre,codigoInacif"
                        [showClear]="true"
                        class="w-full">
                        <ng-template pTemplate="selectedItem" let-selectedEquipo>
                            <div class="flex align-items-center" *ngIf="selectedEquipo">
                                <div>{{selectedEquipo.nombre}} ({{selectedEquipo.codigoInacif}})</div>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-equipo>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{equipo.nombre}}</div>
                                    <div class="text-sm text-gray-500">C칩digo: {{equipo.codigoInacif}}</div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small class="text-500">Equipo relacionado con el ticket</small>
                </div>
                <div class="field">
                    <label for="editUsuarioAsignado">Asignado a</label>
                    <p-dropdown 
                        id="editUsuarioAsignado"
                        [(ngModel)]="ticketEditando.usuarioAsignadoId" 
                        [options]="usuarios" 
                        optionLabel="nombreCompleto"
                        optionValue="id"
                        placeholder="Seleccionar responsable"
                        [filter]="true"
                        appendTo="body"
                        filterBy="nombreCompleto,correo"
                        [showClear]="true"
                        class="w-full">
                        <ng-template pTemplate="selectedItem" let-selectedUsuario>
                            <div class="flex align-items-center" *ngIf="selectedUsuario">
                                <div>{{selectedUsuario.nombreCompleto}}</div>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="item" let-usuario>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{usuario.nombreCompleto}}</div>
                                    <div class="text-sm text-gray-500">{{usuario.correo}}</div>
                                </div>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small class="text-500">Seleccione el t칠cnico responsable</small>
                </div>
            </ng-template>

            <ng-template pTemplate="footer">
                <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text" (click)="cancelarEdicion()"></button>
                <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text" (click)="guardarEdicionTicket()"></button>
            </ng-template>
        </p-dialog>

        <p-dialog [(visible)]="deleteTicketDialog" header="Confirmar" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span *ngIf="ticket">쮼st치 seguro que desea eliminar este ticket?</span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No" (click)="deleteTicketDialog = false"></button>
                <button pButton pRipple icon="pi pi-check" class="p-button-text" label="S칤" (click)="eliminarTicketConfirmado()"></button>
            </ng-template>
        </p-dialog>

        <p-dialog [(visible)]="deleteTicketsDialog" header="Confirmar" [modal]="true" [style]="{width:'450px'}">
            <div class="flex align-items-center justify-content-center">
                <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
                <span>쮼st치 seguro que desea eliminar los tickets seleccionados?</span>
            </div>
            <ng-template pTemplate="footer">
                <button pButton pRipple icon="pi pi-times" class="p-button-text" label="No" (click)="deleteTicketsDialog = false"></button>
                <button pButton pRipple icon="pi pi-check" class="p-button-text" label="S칤" (click)="eliminarTicketsSeleccionados()"></button>
            </ng-template>
        </p-dialog>

        <!-- Di치logo de Comentarios - VERSI칍N MEJORADA -->
        <p-dialog [(visible)]="dialogComentarios" [style]="{width: '85vw', height: '85vh'}" header="游눫 Gesti칩n de Comentarios y Estado" [modal]="true" [maximizable]="true" [draggable]="true" [resizable]="true">
            <ng-template pTemplate="content">
                <div class="comentarios-container">
                    <!-- HEADER DEL TICKET -->
                    <div class="ticket-header mb-4">
                        <div class="surface-100 border-round-lg p-4 shadow-1">
                            <div class="flex justify-content-between align-items-center">
                                <div class="flex align-items-center">
                                    <div class="bg-primary border-circle w-3rem h-3rem flex align-items-center justify-content-center mr-3">
                                        <i class="pi pi-ticket text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h5 class="m-0 text-primary">Ticket #{{ticketSeleccionado?.id}}</h5>
                                        <p class="text-600 mt-1 mb-0">{{ticketSeleccionado?.descripcion}}</p>
                                        <small class="text-500">
                                            <i class="pi pi-calendar mr-1"></i>
                                            {{ticketSeleccionado?.fechaCreacion | date:'medium'}}
                                        </small>
                                    </div>
                                </div>
                                <div class="flex flex-column align-items-end gap-2">
                                    <p-tag [value]="ticketSeleccionado?.estado" [severity]="getSeverity(ticketSeleccionado?.estado || '')" [rounded]="true" class="text-sm"></p-tag>
                                    <p-tag [value]="ticketSeleccionado?.prioridad" [severity]="getPrioridadSeverity(ticketSeleccionado?.prioridad || '')" [rounded]="true" class="text-sm"></p-tag>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid">
                        <!-- PANEL DE COMENTARIOS EXISTENTES -->
                        <div class="col-12 lg:col-7">
                            <div class="surface-card border-round-lg shadow-1 h-full">
                                <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                                    <div class="flex align-items-center">
                                        <i class="pi pi-comments text-primary mr-2"></i>
                                        <h6 class="m-0">Historial de Comentarios</h6>
                                        <p-badge [value]="comentarios.length" severity="info" class="ml-2"></p-badge>
                                    </div>
                                </div>
                                
                                <div class="p-3">
                                    <div class="comentarios-scroll" style="max-height: 450px; overflow-y: auto; padding-right: 8px;">
                                        <!-- ESTADO VAC칈O -->
                                        <div *ngIf="comentarios.length === 0" class="text-center py-6">
                                            <div class="surface-100 border-circle w-6rem h-6rem flex align-items-center justify-content-center mx-auto mb-3">
                                                <i class="pi pi-comment text-4xl text-400"></i>
                                            </div>
                                            <h6 class="text-600">No hay comentarios</h6>
                                            <p class="text-500 text-sm m-0">S칠 el primero en agregar un comentario a este ticket</p>
                                        </div>

                                        <!-- COMENTARIOS -->
                                        <div *ngFor="let comentario of comentarios; let i = index" class="comentario-card mb-3">
                                            <div class="surface-50 border-round-lg p-3 border-left-3 border-primary shadow-1 hover:shadow-2 transition-all transition-duration-200">
                                                <!-- Header del comentario -->
                                                <div class="flex justify-content-between align-items-start mb-3">
                                                    <div class="flex align-items-center">
                                                        <div class="bg-primary-reverse border-circle w-2rem h-2rem flex align-items-center justify-content-center mr-2">
                                                            <i class="pi pi-user text-primary text-sm"></i>
                                                        </div>
                                                        <div>
                                                            <div class="font-bold text-primary text-sm">{{comentario.usuario}}</div>
                                                            <small class="text-500">
                                                                <i class="pi pi-clock mr-1"></i>
                                                                {{comentario.fechaCreacion | date:'short'}}
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <p-tag 
                                                        [value]="comentario.tipoComentario" 
                                                        [severity]="getTipoComentarioSeverity(comentario.tipoComentario)"
                                                        [rounded]="true" 
                                                        class="text-xs">
                                                    </p-tag>
                                                </div>
                                                
                                                <!-- Contenido del comentario -->
                                                <div class="comment-content">
                                                    <p class="line-height-3 text-700 m-0">{{comentario.comentario}}</p>
                                                    
                                                    <!-- MOSTRAR CAMBIO DE ESTADO SI EXISTE -->
                                                    <div *ngIf="comentario.estadoAnterior && comentario.estadoNuevo" class="mt-3 p-2 surface-200 border-round">
                                                        <div class="flex align-items-center text-sm">
                                                            <i class="pi pi-arrow-right text-orange-500 mr-2"></i>
                                                            <span class="text-600">Estado cambi칩 de</span>
                                                            <p-tag [value]="comentario.estadoAnterior" [severity]="getSeverity(comentario.estadoAnterior)" [rounded]="true" class="mx-2 text-xs"></p-tag>
                                                            <span class="text-600">a</span>
                                                            <p-tag [value]="comentario.estadoNuevo" [severity]="getSeverity(comentario.estadoNuevo)" [rounded]="true" class="mx-2 text-xs"></p-tag>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PANEL DE AGREGAR COMENTARIO -->
                        <div class="col-12 lg:col-5">
                            <div class="surface-card border-round-lg shadow-1 h-full">
                                <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                                    <div class="flex align-items-center">
                                        <i class="pi pi-plus-circle text-green-500 mr-2"></i>
                                        <h6 class="m-0">Nuevo Comentario</h6>
                                    </div>
                                </div>
                                
                                <div class="p-4">
                                    <form class="formgrid grid">
                                        <!-- CAMBIO DE ESTADO -->
                                        <div class="field col-12">
                                            <label for="nuevoEstado" class="block text-900 font-medium mb-2">
                                                <i class="pi pi-refresh mr-1"></i>
                                                Cambiar Estado (Opcional)
                                            </label>
                                            <p-dropdown 
                                                id="nuevoEstado"
                                                name="nuevoEstado"
                                                [(ngModel)]="nuevoEstadoSeleccionado" 
                                                [options]="estadosEdicion" 
                                                placeholder="Mantener estado actual"
                                                [showClear]="true"
                                                styleClass="w-full"
                                                [filter]="true">
                                                <ng-template pTemplate="selectedItem" let-option>
                                                    <div class="flex align-items-center" *ngIf="option">
                                                        <p-tag [value]="option" [severity]="getSeverity(option)" [rounded]="true" class="mr-2"></p-tag>
                                                        <span>{{option}}</span>
                                                    </div>
                                                </ng-template>
                                                <ng-template pTemplate="item" let-option>
                                                    <div class="flex align-items-center">
                                                        <p-tag [value]="option" [severity]="getSeverity(option)" [rounded]="true" class="mr-2"></p-tag>
                                                        <span>{{option}}</span>
                                                    </div>
                                                </ng-template>
                                            </p-dropdown>
                                        </div>

                                        <!-- TIPO DE COMENTARIO -->
                                        <div class="field col-12">
                                            <label for="tipoComentario" class="block text-900 font-medium mb-2">
                                                <i class="pi pi-tag mr-1"></i>
                                                Tipo de Comentario *
                                            </label>
                                            <p-dropdown 
                                                id="tipoComentario"
                                                name="tipoComentario"
                                                [(ngModel)]="tipoComentarioSeleccionado" 
                                                [options]="tiposComentario" 
                                                placeholder="Seleccionar tipo"
                                                styleClass="w-full"
                                                required>
                                                <ng-template pTemplate="selectedItem" let-option>
                                                    <div class="flex align-items-center" *ngIf="option">
                                                        <p-tag [value]="option" [severity]="getTipoComentarioSeverity(option)" [rounded]="true" class="mr-2"></p-tag>
                                                        <span>{{option}}</span>
                                                    </div>
                                                </ng-template>
                                                <ng-template pTemplate="item" let-option>
                                                    <div class="flex align-items-center">
                                                        <p-tag [value]="option" [severity]="getTipoComentarioSeverity(option)" [rounded]="true" class="mr-2"></p-tag>
                                                        <span>{{option}}</span>
                                                    </div>
                                                </ng-template>
                                            </p-dropdown>
                                        </div>

                                        <!-- TEXTO DEL COMENTARIO -->
                                        <div class="field col-12">
                                            <label for="comentarioTexto" class="block text-900 font-medium mb-2">
                                                <i class="pi pi-pencil mr-1"></i>
                                                Comentario *
                                            </label>
                                            <textarea 
                                                pInputTextarea 
                                                id="comentarioTexto" 
                                                name="comentarioTexto"
                                                [(ngModel)]="nuevoComentario" 
                                                rows="5" 
                                                placeholder="Escribe tu comentario aqu칤..."
                                                class="w-full"
                                                [autoResize]="true"
                                                required></textarea>
                                            <small class="text-500">
                                                {{(nuevoComentario || '').length}} caracteres
                                            </small>
                                        </div>

                                        <!-- BOTONES DE ACCI칍N -->
                                        <div class="field col-12">
                                            <div class="flex justify-content-end">
                                                <button 
                                                    pButton 
                                                    pRipple 
                                                    label="Agregar Comentario" 
                                                    icon="pi pi-send" 
                                                    class="p-button-primary"
                                                    (click)="agregarComentario()"
                                                    [disabled]="!(nuevoComentario && nuevoComentario.trim().length > 0)">
                                                </button>
                                            </div>
                                        </div>

                                        <!-- INFORMACI칍N DE AYUDA -->
                                        <div class="field col-12">
                                            <div class="surface-100 border-round p-3">
                                                <div class="flex align-items-start">
                                                    <i class="pi pi-info-circle text-blue-500 mr-2 mt-1"></i>
                                                    <div>
                                                        <h6 class="m-0 mb-2 text-blue-700">Informaci칩n</h6>
                                                        <ul class="text-sm text-600 m-0 pl-3">
                                                            <li>El comentario se guardar치 con la fecha y hora actual</li>
                                                            <li>Si cambias el estado, se registrar치 en el historial</li>
                                                            <li>Los campos marcados con * son obligatorios</li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SECCI칍N DE EVIDENCIAS -->
                    <div class="mt-4">
                        <div class="surface-card border-round-lg shadow-1">
                            <div class="surface-50 border-round-top-lg p-3 border-bottom-1 surface-border">
                                <div class="flex align-items-center justify-content-between">
                                    <div class="flex align-items-center">
                                        <i class="pi pi-paperclip text-orange-500 mr-2"></i>
                                        <h6 class="m-0">Evidencias Adjuntas</h6>
                                        <p-badge [value]="evidencias.length" severity="warning" class="ml-2"></p-badge>
                                    </div>
                                    <button 
                                        pButton 
                                        pRipple 
                                        label="Subir Evidencia" 
                                        icon="pi pi-upload" 
                                        class="p-button-sm p-button-outlined p-button-warning"
                                        (click)="mostrarDialogEvidencia()">
                                    </button>
                                </div>
                            </div>
                            
                            <div class="p-3">
                                <!-- ESTADO VAC칈O -->
                                <div *ngIf="evidencias.length === 0" class="text-center py-4">
                                    <div class="surface-100 border-circle w-4rem h-4rem flex align-items-center justify-content-center mx-auto mb-2">
                                        <i class="pi pi-image text-3xl text-400"></i>
                                    </div>
                                    <p class="text-500 text-sm m-0">No hay evidencias adjuntas</p>
                                </div>

                                <!-- LISTA DE EVIDENCIAS -->
                                <div class="grid">
                                    <div *ngFor="let evidencia of evidencias" class="col-12 md:col-6 lg:col-4">
                                        <div class="surface-50 border-round-lg p-3 shadow-1 hover:shadow-3 transition-all transition-duration-200">
                                            <div class="flex justify-content-between align-items-start mb-2">
                                                <i class="pi pi-file text-2xl text-orange-500"></i>
                                                <button 
                                                    pButton 
                                                    pRipple 
                                                    icon="pi pi-trash" 
                                                    class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                                    (click)="eliminarEvidencia(evidencia)"
                                                    pTooltip="Eliminar evidencia">
                                                </button>
                                            </div>
                                            <div class="mb-2">
                                                <p class="text-sm font-medium text-900 m-0 mb-1">{{evidencia.descripcion || 'Sin descripci칩n'}}</p>
                                                <small class="text-500">
                                                    <i class="pi pi-calendar mr-1"></i>
                                                    {{evidencia.fechaCreacion | date:'short'}}
                                                </small>
                                            </div>
                                            <a 
                                                [href]="evidencia.archivoUrl" 
                                                target="_blank" 
                                                class="text-primary text-sm">
                                                <i class="pi pi-external-link mr-1"></i>
                                                Ver archivo
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </ng-template>

            <ng-template pTemplate="footer">
                <div class="flex justify-content-end">
                    <button 
                        pButton 
                        pRipple 
                        label="Cerrar" 
                        icon="pi pi-times" 
                        class="p-button-text p-button-lg"
                        (click)="cerrarModalComentarios()">
                    </button>
                </div>
            </ng-template>
        </p-dialog>

        <!-- DIALOG PARA SUBIR EVIDENCIA -->
        <p-dialog [(visible)]="dialogEvidencia" [style]="{width: '600px'}" header="游늹 Adjuntar Evidencias al Ticket" [modal]="true" class="p-fluid">
            <ng-template pTemplate="content">
                <div class="surface-card border-1 surface-border border-round p-3">
                    <div class="flex align-items-center justify-content-between mb-3">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-paperclip text-xl text-primary"></i>
                            <h6 class="m-0">Archivos a Subir</h6>
                        </div>
                        <p-tag [value]="archivosEvidenciaSeleccionados.length.toString()" 
                               [severity]="archivosEvidenciaSeleccionados.length > 0 ? 'success' : 'secondary'"
                               [rounded]="true"></p-tag>
                    </div>
                    
                    <p class="text-sm text-600 mb-3">
                        <i class="pi pi-info-circle mr-1"></i>
                        Adjunte archivos de evidencia (PDF, DOC, DOCX, XLS, XLSX, im치genes - m치x. 10MB cada uno)
                    </p>

                    <!-- Upload de archivos en modo b치sico -->
                    <p-fileUpload #fileUploadEvidencia
                                  name="files" 
                                  [multiple]="true" 
                                  accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.webp"
                                  [maxFileSize]="10485760" 
                                  (onSelect)="onArchivoSeleccionado($event)"
                                  (onRemove)="onArchivoEliminado($event)"
                                  [showUploadButton]="false" 
                                  [showCancelButton]="false"
                                  [auto]="false"
                                  mode="basic"
                                  chooseLabel="Seleccionar Archivos"
                                  chooseIcon="pi pi-plus">
                    </p-fileUpload>
                    
                    <!-- Lista de archivos seleccionados -->
                    <div *ngIf="archivosEvidenciaSeleccionados.length > 0" class="mt-3">
                        <div class="flex align-items-center justify-content-between mb-2">
                            <span class="font-semibold text-sm">Archivos seleccionados:</span>
                            <button pButton pRipple 
                                    label="Limpiar todo" 
                                    icon="pi pi-times" 
                                    class="p-button-text p-button-sm p-button-danger"
                                    (click)="limpiarArchivosEvidencia()"></button>
                        </div>
                        
                        <div *ngFor="let file of archivosEvidenciaSeleccionados; let i = index" 
                             class="flex align-items-center justify-content-between p-2 mb-2 surface-50 border-round">
                            <div class="flex align-items-center gap-2 flex-1">
                                <i [class]="obtenerIconoArchivo(file.name)" class="text-2xl"></i>
                                <div class="flex-1">
                                    <div class="font-medium text-sm">{{file.name}}</div>
                                    <div class="text-xs text-500">{{formatearTamano(file.size)}}</div>
                                </div>
                            </div>
                            <button pButton pRipple 
                                    icon="pi pi-times" 
                                    class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                    (click)="eliminarArchivoSeleccionado(i)"
                                    pTooltip="Eliminar"></button>
                        </div>
                    </div>
                </div>

                <div class="field mt-3">
                    <label for="descripcionEvidencia">Descripci칩n (opcional)</label>
                    <textarea 
                        pInputTextarea 
                        id="descripcionEvidencia" 
                        [(ngModel)]="descripcionEvidencia" 
                        rows="3" 
                        placeholder="A침ada una descripci칩n general para estos archivos"></textarea>
                </div>

                <p-progressBar *ngIf="subiendoEvidencias" mode="indeterminate" styleClass="mt-2"></p-progressBar>
            </ng-template>

            <ng-template pTemplate="footer">
                <button 
                    pButton 
                    pRipple 
                    label="Cancelar" 
                    icon="pi pi-times" 
                    class="p-button-text"
                    (click)="dialogEvidencia = false"
                    [disabled]="subiendoEvidencias">
                </button>
                <button 
                    pButton 
                    pRipple 
                    label="Subir Evidencias" 
                    icon="pi pi-upload" 
                    class="p-button-success"
                    (click)="subirEvidencia()"
                    [disabled]="subiendoEvidencias || archivosEvidenciaSeleccionados.length === 0">
                </button>
            </ng-template>
        </p-dialog>
    </div>
</div>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>
