<div class="grid">
    <div class="col-12">
        <div class="card">
            <p-toast></p-toast>
            <p-confirmDialog [style]="{width: '450px'}">
                <ng-template pTemplate="message" let-message>
                    <div [innerHTML]="message.message"></div>
                </ng-template>
            </p-confirmDialog>
            
            <!-- Header con titulo y controles -->
            <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4 gap-3">
                <div>
                    <h4 class="m-0 flex align-items-center gap-2">
                        <i class="pi pi-calendar text-primary"></i>
                        Calendario de Mantenimientos
                    </h4>
                    <p class="text-500 mt-1 mb-0">Visualiza cuándo corresponde cada mantenimiento programado</p>
                </div>
                
                <div class="flex flex-wrap gap-2 align-items-center">
                    <!-- Filtro por tipo de mantenimiento -->
                    <p-dropdown [options]="tiposFiltro" 
                                [(ngModel)]="filtroTipo"
                                (onChange)="onFilterChange()"
                                placeholder="Filtrar por tipo"
                                styleClass="w-14rem">
                    </p-dropdown>
                    
                    <!-- Boton refrescar -->
                    <button pButton pRipple 
                            icon="pi pi-refresh" 
                            class="p-button-outlined"
                            (click)="refreshCalendar()"
                            pTooltip="Actualizar calendario"></button>
                </div>
            </div>
            
            <!-- Leyenda de colores y rango de visualización -->
            <div class="flex flex-wrap justify-content-between gap-3 p-3 mb-4 surface-100 border-round align-items-center">
                <div class="flex flex-wrap gap-3 align-items-center">
                    <span class="text-sm font-medium text-700 mr-2">
                        <i class="pi pi-info-circle mr-1"></i>Tipos:
                    </span>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #22c55e"></span>
                        <span class="text-sm">Preventivo</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #ef4444"></span>
                        <span class="text-sm">Correctivo</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #3b82f6"></span>
                        <span class="text-sm">Calibración</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #6366f1"></span>
                        <span class="text-sm">Otros</span>
                    </div>
                </div>
                <div class="flex align-items-center gap-2 text-500">
                    <i class="pi pi-eye text-sm"></i>
                    <span class="text-sm">Mostrando: 3 meses atrás - 6 meses adelante</span>
                </div>
            </div>

            <!-- Mini Dashboard de Estadísticas -->
            <div class="grid mb-4">
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3">
                        <div class="flex justify-content-between align-items-center">
                            <div>
                                <span class="block text-500 font-medium mb-1">Programaciones Activas</span>
                                <div class="text-900 font-bold text-2xl">{{ stats.totalProgramados }}</div>
                            </div>
                            <div class="flex align-items-center justify-content-center bg-blue-100 border-round" 
                                 style="width: 2.5rem; height: 2.5rem">
                                <i class="pi pi-calendar text-blue-500 text-xl"></i>
                            </div>
                        </div>
                        <span class="text-500 text-sm">Equipos con mantenimiento programado</span>
                    </div>
                </div>
                
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3">
                        <div class="flex justify-content-between align-items-center">
                            <div>
                                <span class="block text-500 font-medium mb-1">Próximos 7 días</span>
                                <div class="text-900 font-bold text-2xl">{{ stats.proximos7Dias }}</div>
                            </div>
                            <div class="flex align-items-center justify-content-center bg-orange-100 border-round" 
                                 style="width: 2.5rem; height: 2.5rem">
                                <i class="pi pi-clock text-orange-500 text-xl"></i>
                            </div>
                        </div>
                        <span class="text-orange-500 text-sm font-medium">Requieren atención</span>
                    </div>
                </div>
                
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3">
                        <div class="flex justify-content-between align-items-center">
                            <div>
                                <span class="block text-500 font-medium mb-1">Este Mes</span>
                                <div class="text-900 font-bold text-2xl">{{ stats.esteMes }}</div>
                            </div>
                            <div class="flex align-items-center justify-content-center bg-cyan-100 border-round" 
                                 style="width: 2.5rem; height: 2.5rem">
                                <i class="pi pi-calendar-plus text-cyan-500 text-xl"></i>
                            </div>
                        </div>
                        <span class="text-500 text-sm">Mantenimientos del mes</span>
                    </div>
                </div>
                
                <div class="col-12 md:col-6 lg:col-3">
                    <div class="surface-card shadow-1 border-round p-3" 
                         [ngClass]="{'border-left-3 border-red-500': stats.vencidos > 0}">
                        <div class="flex justify-content-between align-items-center">
                            <div>
                                <span class="block text-500 font-medium mb-1">Vencidos</span>
                                <div class="font-bold text-2xl" 
                                     [ngClass]="stats.vencidos > 0 ? 'text-red-500' : 'text-900'">
                                    {{ stats.vencidos }}
                                </div>
                            </div>
                            <div class="flex align-items-center justify-content-center border-round" 
                                 [ngClass]="stats.vencidos > 0 ? 'bg-red-100' : 'bg-green-100'"
                                 style="width: 2.5rem; height: 2.5rem">
                                <i class="text-xl" 
                                   [ngClass]="stats.vencidos > 0 ? 'pi pi-exclamation-triangle text-red-500' : 'pi pi-check text-green-500'"></i>
                            </div>
                        </div>
                        <span class="text-sm" [ngClass]="stats.vencidos > 0 ? 'text-red-500 font-medium' : 'text-green-500'">
                            {{ stats.vencidos > 0 ? '¡Requieren atención!' : 'Todo al día' }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div class="calendar-container" *ngIf="!loading">
                <full-calendar [options]="calendarOptions"></full-calendar>
                
                <!-- Mensaje cuando no hay eventos -->
                <div *ngIf="events.length === 0" class="text-center p-5 mt-3 surface-100 border-round">
                    <i class="pi pi-calendar-times text-5xl text-400 mb-3"></i>
                    <h5 class="mt-0 mb-2">No hay mantenimientos programados</h5>
                    <p class="text-600 mt-0 mb-3">Crea programaciones para ver cuándo corresponde cada mantenimiento</p>
                    <div class="mt-4">
                        <button pButton pRipple label="Crear Programación" icon="pi pi-plus" 
                                class="p-button-sm"
                                routerLink="/administracion/programaciones"></button>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div *ngIf="loading" class="text-center p-6">
                <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                <p class="mt-3 text-500">Cargando calendario...</p>
            </div>

            <!-- Ayuda -->
            <div class="mt-4 p-3 surface-50 border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-primary"></i>
                    <span class="font-semibold">¿Cómo usar el calendario?</span>
                </div>
                <ul class="m-0 pl-4 text-sm text-600">
                    <li>El calendario muestra <strong>cuándo toca</strong> cada mantenimiento programado</li>
                    <li>Los <strong>colores</strong> indican el tipo: verde (preventivo), rojo (correctivo), azul (calibración), naranja (predictivo)</li>
                    <li>Haz clic en un <strong>evento</strong> para ver detalles y crear una ejecución</li>
                    <li>Usa el <strong>filtro</strong> para ver solo un tipo de mantenimiento</li>
                    <li>Las <strong>ejecuciones realizadas</strong> se consultan en el módulo de Ejecuciones</li>
                </ul>
                
                <div class="mt-3 flex gap-2">
                    <button pButton pRipple label="Gestionar Programaciones" icon="pi pi-calendar-plus" 
                            class="p-button-sm p-button-outlined"
                            routerLink="/administracion/programaciones"></button>
                    <button pButton pRipple label="Ver Ejecuciones Realizadas" icon="pi pi-list" 
                            class="p-button-sm p-button-outlined"
                            routerLink="/administracion/ejecuciones"></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialog de detalle del evento -->
<p-dialog [(visible)]="showDetailDialog" 
          [style]="{width: '500px'}" 
          header="Detalle de Mantenimiento Programado"
          [modal]="true">
    
    <ng-template pTemplate="content">
        <div *ngIf="selectedEvent" class="flex flex-column gap-3">
            
            <!-- Alerta de contrato vencido -->
            <div *ngIf="selectedEvent.extendedProps?.contratoVencido" 
                 class="p-3 border-round bg-orange-50 border-1 border-orange-300 flex align-items-center gap-3">
                <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
                <div>
                    <div class="font-semibold text-orange-700">⚠️ Contrato Vencido</div>
                    <div class="text-orange-600 text-sm">
                        El contrato asociado ya venció. Actualice el contrato para continuar con los servicios de mantenimiento.
                    </div>
                </div>
            </div>

            <!-- Fecha -->
            <div class="flex align-items-center gap-2 p-3 surface-100 border-round">
                <i class="pi pi-calendar text-2xl text-primary"></i>
                <div>
                    <div class="font-semibold">{{ formatDate(selectedEvent.start) }}</div>
                    <small class="text-500">Fecha programada</small>
                </div>
            </div>

            <!-- Equipo -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-cog text-xl text-500"></i>
                <div>
                    <div class="font-medium">{{ selectedEvent.extendedProps?.equipoNombre || 'Sin equipo' }}</div>
                    <small class="text-500">Equipo</small>
                </div>
            </div>

            <!-- Proveedor -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-building text-xl text-500"></i>
                <div>
                    <div class="font-medium">{{ selectedEvent.extendedProps?.proveedorNombre || 'Sin proveedor' }}</div>
                    <small class="text-500">Proveedor</small>
                </div>
            </div>

            <!-- Contrato -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-file text-xl" [class.text-orange-500]="selectedEvent.extendedProps?.contratoVencido" [class.text-500]="!selectedEvent.extendedProps?.contratoVencido"></i>
                <div>
                    <div class="font-medium" [class.text-orange-600]="selectedEvent.extendedProps?.contratoVencido">
                        {{ selectedEvent.extendedProps?.contratoDescripcion || 'Sin contrato' }}
                        <p-tag *ngIf="selectedEvent.extendedProps?.contratoVencido" value="VENCIDO" severity="warning" class="ml-2" [style]="{fontSize: '0.7rem'}"></p-tag>
                    </div>
                    <small class="text-500">Contrato</small>
                    <div *ngIf="selectedEvent.extendedProps?.contratoFechaFin" class="mt-1">
                        <small [class.text-orange-600]="selectedEvent.extendedProps?.contratoVencido" [class.text-600]="!selectedEvent.extendedProps?.contratoVencido">
                            <i class="pi pi-clock mr-1"></i>
                            {{ selectedEvent.extendedProps?.contratoVencido ? 'Venció el' : 'Vigente hasta' }}: {{ formatDateShort(selectedEvent.extendedProps.contratoFechaFin) }}
                        </small>
                    </div>
                </div>
            </div>

            <!-- Frecuencia -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-sync text-xl text-500"></i>
                <div>
                    <p-tag [value]="selectedEvent.extendedProps?.frecuencia || 'Sin frecuencia'" severity="info"></p-tag>
                    <small class="text-500 block mt-1">Frecuencia de mantenimiento</small>
                </div>
            </div>

            <!-- Tipo de Mantenimiento -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-wrench text-xl text-500"></i>
                <div>
                    <span class="inline-flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" 
                              [style.background-color]="selectedEvent.extendedProps?.contratoVencido ? '#6c757d' : getTipoMantenimientoColor(selectedEvent.extendedProps?.tipoMantenimiento)"></span>
                        <span class="font-medium">{{ selectedEvent.extendedProps?.tipoMantenimiento || 'Sin tipo' }}</span>
                    </span>
                    <small class="text-500 block mt-1">Tipo de mantenimiento</small>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <div class="flex justify-content-between w-full">
            <button pButton pRipple label="Cerrar" icon="pi pi-times" 
                    class="p-button-text" (click)="closeDetailDialog()"></button>
            
            <div class="flex gap-2">
                <!-- Botón para ver la programación -->
                <button pButton pRipple label="Ver Programación" icon="pi pi-external-link" 
                        class="p-button-outlined" 
                        (click)="verProgramacion()"
                        pTooltip="Ir al detalle de la programación"></button>
                
                <!-- Botón para crear ejecución desde programación -->
                <button pButton pRipple label="Registrar Ejecución" icon="pi pi-play" 
                        class="p-button-success" 
                        (click)="crearDesdeProgamacion()"
                        pTooltip="Crear ejecución de mantenimiento"></button>
            </div>
        </div>
    </ng-template>
</p-dialog>

<!-- Dialog para crear nueva ejecucion -->
<p-dialog [(visible)]="showCreateDialog" 
          [style]="{width: '500px'}" 
          header="Nueva Ejecucion de Mantenimiento"
          [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Fecha seleccionada -->
            <div class="p-3 surface-100 border-round">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-calendar text-primary"></i>
                    <span class="font-semibold">{{ formatDate(selectedDate) }}</span>
                </div>
            </div>

            <!-- Contrato -->
            <div class="field">
                <label for="contrato" class="font-medium">Contrato *</label>
                <p-dropdown id="contrato"
                            [(ngModel)]="nuevaEjecucion.idContrato"
                            [options]="contratos"
                            optionLabel="descripcion"
                            optionValue="id"
                            placeholder="Seleccione un contrato"
                            [filter]="true"
                            filterBy="descripcion"
                            (onChange)="onContratoChange()"
                            styleClass="w-full">
                    <ng-template let-contrato pTemplate="item">
                        <div>
                            <div>{{ contrato.descripcion }}</div>
                            <small class="text-500">{{ contrato.proveedor?.nombre }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Equipo -->
            <div class="field">
                <label for="equipo" class="font-medium">Equipo *</label>
                <p-dropdown id="equipo"
                            [(ngModel)]="nuevaEjecucion.idEquipo"
                            [options]="equiposContrato"
                            optionLabel="nombre"
                            optionValue="idEquipo"
                            placeholder="Seleccione un equipo"
                            [disabled]="!nuevaEjecucion.idContrato || equiposContrato.length === 0"
                            [filter]="true"
                            styleClass="w-full">
                    <ng-template let-equipo pTemplate="item">
                        <div>
                            <div>{{ equipo.nombre }}</div>
                            <small class="text-500">{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small *ngIf="!nuevaEjecucion.idContrato" class="text-500">
                    Primero seleccione un contrato
                </small>
                <small *ngIf="nuevaEjecucion.idContrato && equiposContrato.length === 0" class="text-orange-500">
                    Este contrato no tiene equipos asociados
                </small>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
                class="p-button-text" (click)="closeCreateDialog()"></button>
        <button pButton pRipple label="Crear Ejecucion" icon="pi pi-check" 
                class="p-button-success" 
                [disabled]="!nuevaEjecucion.idContrato || !nuevaEjecucion.idEquipo"
                (click)="crearEjecucion()"></button>
    </ng-template>
</p-dialog>
