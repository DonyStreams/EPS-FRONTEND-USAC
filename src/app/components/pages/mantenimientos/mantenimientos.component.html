<div class="grid">
    <div class="col-12">
        <div class="card">
            <p-toast></p-toast>
            
            <!-- Header con titulo y controles -->
            <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center mb-4 gap-3">
                <div>
                    <h4 class="m-0 flex align-items-center gap-2">
                        <i class="pi pi-calendar text-primary"></i>
                        Calendario de Mantenimientos
                    </h4>
                    <p class="text-500 mt-1 mb-0">Programaciones y ejecuciones de mantenimiento</p>
                </div>
                
                <div class="flex flex-wrap gap-2 align-items-center">
                    <!-- Filtro por tipo -->
                    <p-dropdown [options]="tiposFiltro" 
                                [(ngModel)]="filtroTipo"
                                (onChange)="onFilterChange()"
                                placeholder="Filtrar por tipo"
                                styleClass="w-12rem">
                    </p-dropdown>
                    
                    <!-- Boton refrescar -->
                    <button pButton pRipple 
                            icon="pi pi-refresh" 
                            class="p-button-outlined"
                            (click)="refreshCalendar()"
                            pTooltip="Actualizar calendario"></button>
                </div>
            </div>
            
            <!-- Leyenda de colores por Tipo de Mantenimiento (Programaciones) -->
            <div class="mb-4">
                <div class="font-medium text-sm text-700 mb-2">
                    <i class="pi pi-calendar-plus mr-2"></i>Programaciones por Tipo:
                </div>
                <div class="flex flex-wrap gap-3 p-3 surface-100 border-round">
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #22c55e"></span>
                        <span class="text-sm">Preventivo</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #ef4444"></span>
                        <span class="text-sm">Correctivo</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #3b82f6"></span>
                        <span class="text-sm">Calibración</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #f59e0b"></span>
                        <span class="text-sm">Predictivo</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #6366f1"></span>
                        <span class="text-sm">Otro</span>
                    </div>
                </div>
            </div>
            
            <!-- Leyenda de Estados (Ejecuciones) -->
            <div class="mb-4">
                <div class="font-medium text-sm text-700 mb-2">
                    <i class="pi pi-check-square mr-2"></i>Ejecuciones por Estado:
                </div>
                <div class="flex flex-wrap gap-3 p-3 surface-50 border-round">
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #f59e0b"></span>
                        <span class="text-sm">Programado</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #3b82f6"></span>
                        <span class="text-sm">En Proceso</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #22c55e"></span>
                        <span class="text-sm">Completado</span>
                    </div>
                    <div class="flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" style="background-color: #ef4444"></span>
                        <span class="text-sm">Cancelado</span>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div class="calendar-container" *ngIf="!loading">
                <full-calendar [options]="calendarOptions"></full-calendar>
                
                <!-- Mensaje cuando no hay eventos -->
                <div *ngIf="events.length === 0" class="text-center p-5 mt-3 surface-100 border-round">
                    <i class="pi pi-calendar-times text-5xl text-400 mb-3"></i>
                    <h5 class="mt-0 mb-2">No hay eventos en el calendario</h5>
                    <p class="text-600 mt-0 mb-3">Para ver eventos necesitas:</p>
                    <div class="text-left inline-block">
                        <p class="text-600 m-0 mb-2">
                            <i class="pi pi-check-circle text-green-500 mr-2"></i>
                            <strong>Programaciones activas</strong> con fecha próxima configurada
                        </p>
                        <p class="text-600 m-0">
                            <i class="pi pi-check-circle text-green-500 mr-2"></i>
                            <strong>Ejecuciones</strong> con fecha programada
                        </p>
                    </div>
                    <div class="mt-4 flex gap-2 justify-content-center">
                        <button pButton pRipple label="Crear Programación" icon="pi pi-plus" 
                                class="p-button-sm"
                                routerLink="/administracion/programaciones"></button>
                        <button pButton pRipple label="Crear Ejecución" icon="pi pi-plus" 
                                class="p-button-sm p-button-success"
                                (click)="crearEjecucionManual()"></button>
                    </div>
                </div>
            </div>
            
            <!-- Loading -->
            <div *ngIf="loading" class="text-center p-6">
                <i class="pi pi-spin pi-spinner text-4xl text-primary"></i>
                <p class="mt-3 text-500">Cargando calendario...</p>
            </div>

            <!-- Ayuda -->
            <div class="mt-4 p-3 surface-50 border-round">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-info-circle text-primary"></i>
                    <span class="font-semibold">¿Cómo usar el calendario?</span>
                </div>
                <ul class="m-0 pl-4 text-sm text-600">
                    <li>Los <strong>colores de programaciones</strong> indican el tipo: verde (preventivo), rojo (correctivo), azul (calibración), naranja (predictivo)</li>
                    <li>Haz clic en un <strong>evento de programación</strong> para crear una ejecución real</li>
                    <li>Los <strong>eventos de ejecución</strong> muestran su estado con colores diferentes</li>
                    <li>Haz clic en un <strong>día vacío</strong> para crear una nueva ejecución manual</li>
                    <li>Usa los botones de navegación para cambiar de mes o semana</li>
                    <li>Filtra por tipo: solo programaciones, solo ejecuciones, o ambos</li>
                </ul>
                
                <div class="mt-3 flex gap-2">
                    <button pButton pRipple label="Ir a Programaciones" icon="pi pi-calendar-plus" 
                            class="p-button-sm p-button-outlined"
                            routerLink="/administracion/programaciones"></button>
                    <button pButton pRipple label="Ir a Ejecuciones" icon="pi pi-list" 
                            class="p-button-sm p-button-outlined"
                            routerLink="/administracion/ejecuciones"></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dialog de detalle del evento -->
<p-dialog [(visible)]="showDetailDialog" 
          [style]="{width: '500px'}" 
          [header]="selectedEvent?.extendedProps?.tipo === 'programacion' ? 'Programacion de Mantenimiento' : 'Ejecucion de Mantenimiento'"
          [modal]="true">
    
    <ng-template pTemplate="content">
        <div *ngIf="selectedEvent" class="flex flex-column gap-3">
            <!-- Fecha -->
            <div class="flex align-items-center gap-2 p-3 surface-100 border-round">
                <i class="pi pi-calendar text-2xl text-primary"></i>
                <div>
                    <div class="font-semibold">{{ formatDate(selectedEvent.start) }}</div>
                    <small class="text-500">Fecha programada</small>
                </div>
            </div>

            <!-- Equipo -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-cog text-xl text-500"></i>
                <div>
                    <div class="font-medium">{{ selectedEvent.extendedProps?.equipoNombre || 'Sin equipo' }}</div>
                    <small class="text-500">Equipo</small>
                </div>
            </div>

            <!-- Proveedor -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-building text-xl text-500"></i>
                <div>
                    <div class="font-medium">{{ selectedEvent.extendedProps?.proveedorNombre || 'Sin proveedor' }}</div>
                    <small class="text-500">Proveedor</small>
                </div>
            </div>

            <!-- Contrato -->
            <div class="flex align-items-center gap-3">
                <i class="pi pi-file text-xl text-500"></i>
                <div>
                    <div class="font-medium">{{ selectedEvent.extendedProps?.contratoDescripcion || 'Sin contrato' }}</div>
                    <small class="text-500">Contrato</small>
                </div>
            </div>

            <!-- Estado (solo para ejecuciones) -->
            <div *ngIf="selectedEvent.extendedProps?.tipo === 'ejecucion'" class="flex align-items-center gap-3">
                <i class="pi pi-tag text-xl text-500"></i>
                <div>
                    <p-tag [value]="getEstadoLabel(selectedEvent.extendedProps?.estado)"
                           [severity]="getEstadoSeverity(selectedEvent.extendedProps?.estado)"></p-tag>
                    <small class="text-500 block mt-1">Estado actual</small>
                </div>
            </div>

            <!-- Frecuencia (solo para programaciones) -->
            <div *ngIf="selectedEvent.extendedProps?.tipo === 'programacion'" class="flex align-items-center gap-3">
                <i class="pi pi-sync text-xl text-500"></i>
                <div>
                    <p-tag [value]="selectedEvent.extendedProps?.frecuencia || 'Sin frecuencia'" severity="info"></p-tag>
                    <small class="text-500 block mt-1">Frecuencia de mantenimiento</small>
                </div>
            </div>

            <!-- Tipo de Mantenimiento (solo para programaciones) -->
            <div *ngIf="selectedEvent.extendedProps?.tipo === 'programacion'" class="flex align-items-center gap-3">
                <i class="pi pi-wrench text-xl text-500"></i>
                <div>
                    <span class="inline-flex align-items-center gap-2">
                        <span class="w-1rem h-1rem border-round" 
                              [style.background-color]="getTipoMantenimientoColor(selectedEvent.extendedProps?.tipoMantenimiento)"></span>
                        <span class="font-medium">{{ selectedEvent.extendedProps?.tipoMantenimiento || 'Sin tipo' }}</span>
                    </span>
                    <small class="text-500 block mt-1">Tipo de mantenimiento</small>
                </div>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
                class="p-button-text" (click)="closeDetailDialog()"></button>
        
        <!-- Bot\u00f3n para crear ejecuci\u00f3n desde programaci\u00f3n -->
        <button *ngIf="selectedEvent?.extendedProps?.tipo === 'programacion'"
                pButton pRipple label="Crear Ejecucion" icon="pi pi-plus" 
                class="p-button-success" (click)="crearDesdeProgamacion()"></button>
        
        <!-- Botón para ir a ejecución existente -->
        <button *ngIf="selectedEvent?.extendedProps?.tipo === 'ejecucion'"
                pButton pRipple label="Ver Ejecucion" icon="pi pi-eye" 
                class="p-button-primary" 
                routerLink="/administracion/ejecuciones"
                (click)="closeDetailDialog()"></button>
    </ng-template>
</p-dialog>

<!-- Dialog para crear nueva ejecucion -->
<p-dialog [(visible)]="showCreateDialog" 
          [style]="{width: '500px'}" 
          header="Nueva Ejecucion de Mantenimiento"
          [modal]="true">
    
    <ng-template pTemplate="content">
        <div class="flex flex-column gap-4">
            <!-- Fecha seleccionada -->
            <div class="p-3 surface-100 border-round">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-calendar text-primary"></i>
                    <span class="font-semibold">{{ formatDate(selectedDate) }}</span>
                </div>
            </div>

            <!-- Contrato -->
            <div class="field">
                <label for="contrato" class="font-medium">Contrato *</label>
                <p-dropdown id="contrato"
                            [(ngModel)]="nuevaEjecucion.idContrato"
                            [options]="contratos"
                            optionLabel="descripcion"
                            optionValue="id"
                            placeholder="Seleccione un contrato"
                            [filter]="true"
                            filterBy="descripcion"
                            (onChange)="onContratoChange()"
                            styleClass="w-full">
                    <ng-template let-contrato pTemplate="item">
                        <div>
                            <div>{{ contrato.descripcion }}</div>
                            <small class="text-500">{{ contrato.proveedor?.nombre }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Equipo -->
            <div class="field">
                <label for="equipo" class="font-medium">Equipo *</label>
                <p-dropdown id="equipo"
                            [(ngModel)]="nuevaEjecucion.idEquipo"
                            [options]="equiposContrato"
                            optionLabel="nombre"
                            optionValue="idEquipo"
                            placeholder="Seleccione un equipo"
                            [disabled]="!nuevaEjecucion.idContrato || equiposContrato.length === 0"
                            [filter]="true"
                            styleClass="w-full">
                    <ng-template let-equipo pTemplate="item">
                        <div>
                            <div>{{ equipo.nombre }}</div>
                            <small class="text-500">{{ equipo.codigoInacif }} - {{ equipo.ubicacion }}</small>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small *ngIf="!nuevaEjecucion.idContrato" class="text-500">
                    Primero seleccione un contrato
                </small>
                <small *ngIf="nuevaEjecucion.idContrato && equiposContrato.length === 0" class="text-orange-500">
                    Este contrato no tiene equipos asociados
                </small>
            </div>
        </div>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
                class="p-button-text" (click)="closeCreateDialog()"></button>
        <button pButton pRipple label="Crear Ejecucion" icon="pi pi-check" 
                class="p-button-success" 
                [disabled]="!nuevaEjecucion.idContrato || !nuevaEjecucion.idEquipo"
                (click)="crearEjecucion()"></button>
    </ng-template>
</p-dialog>
