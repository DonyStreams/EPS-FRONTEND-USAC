<!-- Main card with everything -->
<div class="card">
    <h5>Gestión de Contratos</h5>
    <p class="text-600 line-height-3 m-0 mb-3">Administre contratos con proveedores, archivos adjuntos y programación de mantenimientos.</p>
    
    <!-- Estadísticas modernas -->
    <div class="grid mb-3">
        <div class="col-12 md:col-3">
            <div class="card bg-blue-100 border-left-3 border-blue-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-blue-600 font-medium">Total Contratos</span>
                        <div class="text-2xl font-bold text-blue-900">{{stats.total}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-blue-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-file text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="card bg-green-100 border-left-3 border-green-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-green-600 font-medium">Vigentes</span>
                        <div class="text-2xl font-bold text-green-900">{{stats.vigentes}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-green-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-check-circle text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="card bg-orange-100 border-left-3 border-orange-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-orange-600 font-medium">Por Vencer</span>
                        <div class="text-2xl font-bold text-orange-900">{{stats.porVencer}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-orange-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-exclamation-triangle text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 md:col-3">
            <div class="card bg-red-100 border-left-3 border-red-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-red-600 font-medium">Vencidos</span>
                        <div class="text-2xl font-bold text-red-900">{{stats.vencidos}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-red-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-times-circle text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
        <!-- Nueva tarjeta para contratos inactivos -->
        <div class="col-12 md:col-3">
            <div class="card bg-gray-100 border-left-3 border-gray-500">
                <div class="flex justify-content-between">
                    <div>
                        <span class="text-gray-600 font-medium">Inactivos</span>
                        <div class="text-2xl font-bold text-gray-900">{{stats.inactivos}}</div>
                    </div>
                    <div class="flex align-items-center justify-content-center bg-gray-500 border-circle" style="width:3rem;height:3rem">
                        <i class="pi pi-ban text-white text-xl"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de herramientas -->
    <p-toolbar styleClass="mb-4">
        <ng-template pTemplate="left">
            <button pButton pRipple label="Nuevo Contrato" icon="pi pi-plus" 
                    class="p-button-success mr-2" (click)="openNew()"></button>
            <button pButton pRipple label="Actualizar" icon="pi pi-refresh" 
                    class="p-button-help mr-2" [loading]="loading" (click)="loadContratos()"></button>
        </ng-template>
        <ng-template pTemplate="right">
            <button pButton pRipple label="Exportar CSV" icon="pi pi-download" 
                    class="p-button-help" (click)="exportCSV()"></button>
        </ng-template>
    </p-toolbar>

            <p-table #dt [value]="contratos" [loading]="loading" [paginator]="true" [rows]="10" 
                     [showCurrentPageReport]="true" styleClass="p-datatable-striped"
                     currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} contratos"
                     [globalFilterFields]="['descripcion','proveedor','frecuencia']">
                
                <ng-template pTemplate="caption">
                    <div class="flex align-items-center justify-content-between">
                        <h5 class="m-0">Lista de Contratos</h5>
                        <span class="p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" placeholder="Buscar contratos..." 
                                   #searchInput (input)="dt.filterGlobal(searchInput.value, 'contains')" />
                        </span>
                    </div>
                </ng-template>
                
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="proveedor">Proveedor <p-sortIcon field="proveedor"></p-sortIcon></th>
                        <th pSortableColumn="descripcion">Descripción <p-sortIcon field="descripcion"></p-sortIcon></th>
                        <th pSortableColumn="fechaInicio">Fecha Inicio <p-sortIcon field="fechaInicio"></p-sortIcon></th>
                        <th pSortableColumn="fechaFin">Fecha Fin <p-sortIcon field="fechaFin"></p-sortIcon></th>
                        <th pSortableColumn="frecuencia">Frecuencia <p-sortIcon field="frecuencia"></p-sortIcon></th>
                        <th>Estado</th>
                        <th>Archivos</th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-contrato let-rowIndex="rowIndex">
                    <tr>
                        <td>
                            <strong>{{contrato.proveedor}}</strong>
                        </td>
                        <td>
                            <span [title]="contrato.descripcion || 'Sin descripción'">
                                {{(contrato.descripcion || 'Sin descripción').length > 50 ? ((contrato.descripcion || 'Sin descripción').substring(0, 50) + '...') : (contrato.descripcion || 'Sin descripción')}}
                            </span>
                        </td>
                        <td>{{formatDate(contrato.fechaInicio)}}</td>
                        <td>{{formatDate(contrato.fechaFin)}}</td>
                        <td>
                            <span class="text-capitalize">{{contrato.frecuencia || 'No definida'}}</span>
                        </td>
                        <td>
                            <p-tag [value]="contrato.estadoDescriptivo" 
                                   [severity]="getSeverity(contrato.estadoDescriptivo)">
                                </p-tag>
                        </td>
                        <td>
                            <span class="p-badge p-badge-info" *ngIf="contrato.totalArchivos && contrato.totalArchivos > 0">
                                {{contrato.totalArchivos}} archivo(s)
                            </span>
                            <span class="text-muted" *ngIf="!contrato.totalArchivos || contrato.totalArchivos === 0">
                                Sin archivos
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                <button pButton pRipple icon="pi pi-pencil" 
                                        class="p-button-rounded p-button-text p-button-success" 
                                        (click)="editContrato(contrato)"
                                        pTooltip="Editar contrato"></button>
                                <button pButton pRipple icon="pi pi-file" 
                                        class="p-button-rounded p-button-text p-button-info" 
                                        (click)="openFileDialog(contrato)"
                                        pTooltip="Subir archivos (modal)"></button>
                                <button pButton pRipple icon="pi pi-folder-open" 
                                        class="p-button-rounded p-button-text p-button-warning" 
                                        (click)="gestionarArchivos(contrato)"
                                        pTooltip="Gestionar archivos (página completa)"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="8" class="text-center p-4">
                            <i class="pi pi-file text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 m-0">No se encontraron contratos</p>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
</div>

<!-- Diálogo para crear/editar contrato -->
<p-dialog header="{{isEditing ? 'Editar' : 'Nuevo'}} Contrato" 
          [(visible)]="displayDialog" [modal]="true" [closable]="true" 
          [style]="{width: '600px'}" styleClass="p-fluid">
    
    <form [formGroup]="contratoForm" (ngSubmit)="saveContrato()">
        <div class="grid">
            <div class="col-12 md:col-6">
                <label for="fechaInicio" class="block text-900 font-medium mb-2">Fecha Inicio *</label>
                <p-calendar formControlName="fechaInicio" inputId="fechaInicio" 
                           dateFormat="dd/mm/yy" [showIcon]="true" [showButtonBar]="true">
                </p-calendar>
                <small class="p-error block" 
                       *ngIf="contratoForm.get('fechaInicio')?.invalid && contratoForm.get('fechaInicio')?.touched">
                    Fecha de inicio requerida
                </small>
            </div>
            
            <div class="col-12 md:col-6">
                <label for="fechaFin" class="block text-900 font-medium mb-2">Fecha Fin *</label>
                <p-calendar formControlName="fechaFin" inputId="fechaFin" 
                           dateFormat="dd/mm/yy" [showIcon]="true" [showButtonBar]="true">
                </p-calendar>
                <small class="p-error block" 
                       *ngIf="contratoForm.get('fechaFin')?.invalid && contratoForm.get('fechaFin')?.touched">
                    Fecha de fin requerida
                </small>
            </div>
            
            <div class="col-12">
                <label for="idProveedor" class="block text-900 font-medium mb-2">Proveedor *</label>
                <p-dropdown formControlName="idProveedor" inputId="idProveedor"
                           [options]="proveedores" optionLabel="nombre" optionValue="idProveedor"
                           placeholder="Seleccione un proveedor" [showClear]="true">
                </p-dropdown>
                <small class="p-error block" 
                       *ngIf="contratoForm.get('idProveedor')?.invalid && contratoForm.get('idProveedor')?.touched">
                    Proveedor requerido
                </small>
            </div>
            
            <div class="col-12">
                <label for="frecuencia" class="block text-900 font-medium mb-2">Frecuencia *</label>
                <p-dropdown formControlName="frecuencia" inputId="frecuencia"
                           [options]="frecuenciaOptions" optionLabel="label" optionValue="value"
                           placeholder="Seleccione la frecuencia" [showClear]="true">
                </p-dropdown>
                <small class="p-error block" 
                       *ngIf="contratoForm.get('frecuencia')?.invalid && contratoForm.get('frecuencia')?.touched">
                    Frecuencia requerida
                </small>
            </div>
            
            <div class="col-12">
                <label for="descripcion" class="block text-900 font-medium mb-2">Descripción *</label>
                <textarea pInputTextarea formControlName="descripcion" inputId="descripcion"
                          rows="3" placeholder="Describa el alcance del contrato..." [autoResize]="true">
                </textarea>
                <small class="p-error block" 
                       *ngIf="contratoForm.get('descripcion')?.invalid && contratoForm.get('descripcion')?.touched">
                    Descripción requerida (mínimo 10 caracteres)
                </small>
            </div>

            <!-- Checkbox de estado (solo visible al editar) -->
            <div class="col-12" *ngIf="isEditing">
                <div class="field-checkbox">
                    <p-checkbox formControlName="estado" binary="true" inputId="estado"></p-checkbox>
                    <label for="estado" class="ml-2 text-900 font-medium">
                        {{contratoForm.get('estado')?.value ? 'Activo' : 'Inactivo'}}
                    </label>
                </div>
                <small class="text-600 block">
                    Los contratos inactivos aparecerán en rojo en la tabla.
                </small>
            </div>
        </div>
    </form>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
                class="p-button-text" (click)="displayDialog=false"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" 
                class="p-button-primary" (click)="saveContrato()"
                [disabled]="contratoForm.invalid"></button>
    </ng-template>
</p-dialog>

<!-- Diálogo para gestión de archivos -->
<p-dialog header="Gestión de Archivos - {{selectedContrato?.proveedor}}" 
          [(visible)]="displayFileDialog" [modal]="true" [closable]="true" 
          [style]="{width: '700px'}" styleClass="p-fluid"
          (onHide)="closeFileDialog()">
    
    <div class="mb-4">
        <h6>Subir nuevos archivos</h6>
        <p class="text-sm text-gray-600 mb-2">Solo se permiten archivos PDF, DOC y DOCX (máximo 10MB cada uno)</p>
        <p-fileUpload #fileUpload name="files" [multiple]="true" accept=".pdf,.doc,.docx"
                      [maxFileSize]="maxFileSize" 
                      (onSelect)="onFileSelect($event)"
                      (onRemove)="onFileRemove($event)"
                      [showUploadButton]="false" 
                      [showCancelButton]="false"
                      [auto]="false"
                      mode="basic"
                      chooseLabel="Seleccionar Archivos">
        </p-fileUpload>
        
        <!-- Lista personalizada de archivos seleccionados -->
        <div *ngIf="uploadedFiles.length > 0" class="mt-3">
            <h6 class="mb-2">Archivos seleccionados:</h6>
            <div *ngFor="let file of uploadedFiles; let i = index" class="mb-2 p-2 border-1 border-gray-200 border-round">
                <div class="flex align-items-center justify-content-between">
                    <div class="flex align-items-center gap-2">
                        <i [class]="archivosService.getIconoArchivo(file.name)" class="text-xl"></i>
                        <div>
                            <div class="font-medium">{{file.name}}</div>
                            <div class="text-sm text-gray-500">{{archivosService.formatearTamano(file.size)}}</div>
                        </div>
                    </div>
                    <button pButton pRipple type="button" icon="pi pi-times" 
                            class="p-button-rounded p-button-text p-button-danger p-button-sm"
                            (click)="removeFile(i)"
                            pTooltip="Eliminar archivo"></button>
                </div>
            </div>
        </div>
        
        <div class="mt-3" *ngIf="uploadedFiles.length > 0">
            <button pButton pRipple label="Subir Archivos" icon="pi pi-upload" 
                    class="p-button-success" (click)="uploadFiles()"></button>
        </div>
    </div>
    
    <div *ngIf="selectedContrato?.archivos && selectedContrato.archivos.length > 0">
        <h6>Archivos existentes</h6>
        <div class="grid">
            <div class="col-12" *ngFor="let archivo of selectedContrato.archivos">
                <div class="border-1 border-gray-300 border-round p-3 mb-2">
                    <div class="flex align-items-center justify-content-between">
                        <div class="flex align-items-center gap-3">
                            <i [class]="archivo.iconoCss" class="text-2xl"></i>
                            <div>
                                <div class="font-medium">{{archivo.nombreOriginal}}</div>
                                <div class="text-sm text-gray-500">
                                    {{archivo.tamanoFormateado}} • Subido: {{formatDateTime(archivo.fechaSubida)}}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button pButton pRipple icon="pi pi-download" 
                                    class="p-button-rounded p-button-text p-button-info" 
                                    (click)="downloadFile(archivo)"
                                    pTooltip="Descargar"></button>
                            <button pButton pRipple icon="pi pi-trash" 
                                    class="p-button-rounded p-button-text p-button-danger" 
                                    (click)="deleteFile(archivo)"
                                    pTooltip="Eliminar"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div *ngIf="!selectedContrato?.archivos || selectedContrato.archivos.length === 0" 
         class="text-center p-4 text-gray-500">
        <i class="pi pi-file text-4xl mb-3"></i>
        <p class="m-0">No hay archivos adjuntos para este contrato</p>
    </div>
    
    <ng-template pTemplate="footer">
        <button pButton pRipple label="Limpiar Selección" icon="pi pi-refresh" 
                class="p-button-secondary p-button-text" 
                (click)="clearFilesManually()"
                [disabled]="uploadedFiles.length === 0"></button>
        <button pButton pRipple label="Cerrar" icon="pi pi-times" 
                class="p-button-text" (click)="closeFileDialog()"></button>
    </ng-template>
</p-dialog>

<!-- Toast para mensajes -->
<p-toast></p-toast>

<!-- Confirmación de acciones -->
<p-confirmDialog></p-confirmDialog>
