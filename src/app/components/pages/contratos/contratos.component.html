<div class="grid">
    <!-- Título y descripción -->
    <div class="col-12">
        <div class="card">
            <div class="flex align-items-center justify-content-between mb-3">
                <div>
                    <h4 class="m-0 flex align-items-center gap-2">
                        <i class="pi pi-file-edit text-primary"></i>
                        Gestión de Contratos
                    </h4>
                    <p class="text-500 mt-1 mb-0">Administre contratos con proveedores, archivos adjuntos y programación de mantenimientos.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas (solo 3 principales) -->
    <div class="col-12 md:col-4">
        <div class="surface-card shadow-1 border-round p-3">
            <div class="flex align-items-center">
                <div class="bg-blue-100 border-circle p-3 mr-3">
                    <i class="pi pi-file text-blue-500 text-2xl"></i>
                </div>
                <div>
                    <span class="text-600 text-sm">Total Contratos</span>
                    <div class="text-900 font-bold text-2xl">{{stats.total}}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 md:col-4">
        <div class="surface-card shadow-1 border-round p-3">
            <div class="flex align-items-center">
                <div class="bg-green-100 border-circle p-3 mr-3">
                    <i class="pi pi-check-circle text-green-500 text-2xl"></i>
                </div>
                <div>
                    <span class="text-600 text-sm">Vigentes</span>
                    <div class="text-900 font-bold text-2xl">{{stats.vigentes}}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-12 md:col-4">
        <div class="surface-card shadow-1 border-round p-3">
            <div class="flex align-items-center">
                <div class="bg-red-100 border-circle p-3 mr-3">
                    <i class="pi pi-times-circle text-red-500 text-2xl"></i>
                </div>
                <div>
                    <span class="text-600 text-sm">Vencidos</span>
                    <div class="text-900 font-bold text-2xl">{{stats.vencidos}}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla principal -->
    <div class="col-12">
        <div class="card">
            <!-- Barra de acciones moderna -->
            <div class="surface-ground border-round p-3 mb-4">
                <div class="flex flex-column md:flex-row md:align-items-center md:justify-content-between gap-3">
                    <div class="flex gap-2">
                        <button pButton pRipple label="Nuevo Contrato" icon="pi pi-plus" 
                                class="p-button-success"
                                (click)="openNew()"></button>
                    </div>
                    
                    <span class="p-input-icon-left w-full md:w-auto">
                        <i class="pi pi-search"></i>
                        <input pInputText type="text" 
                               #searchInput 
                               (input)="dt.filterGlobal(searchInput.value, 'contains')" 
                               placeholder="Buscar contrato..." 
                               class="w-full md:w-20rem" />
                    </span>
                </div>
            </div>

            <!-- Tabla mejorada -->
            <p-table #dt [value]="contratos" 
                     [loading]="loading" 
                     [paginator]="true" 
                     [rows]="10" 
                     [rowsPerPageOptions]="[10,20,30]"
                     [showCurrentPageReport]="true"
                     currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} contratos"
                     [globalFilterFields]="['descripcion','proveedor']"
                     [rowHover]="true"
                     styleClass="p-datatable-sm">
                
                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="proveedor">
                            Proveedor <p-sortIcon field="proveedor"></p-sortIcon>
                        </th>
                        <th pSortableColumn="descripcion">
                            Descripción <p-sortIcon field="descripcion"></p-sortIcon>
                        </th>
                        <th pSortableColumn="fechaInicio" style="width: 12%">
                            Fecha Inicio <p-sortIcon field="fechaInicio"></p-sortIcon>
                        </th>
                        <th pSortableColumn="fechaFin" style="width: 12%">
                            Fecha Fin <p-sortIcon field="fechaFin"></p-sortIcon>
                        </th>
                        <th style="width: 8%">Estado</th>
                        <th style="width: 12%">Vigencia</th>
                        <th style="width: 10%">Archivos</th>
                        <th style="width: 10rem">Acciones</th>
                    </tr>
                </ng-template>
                
                <ng-template pTemplate="body" let-contrato>
                    <tr>
                        <td>
                            <div class="flex align-items-center">
                                <i class="pi pi-building mr-2 text-500"></i>
                                <strong>{{contrato.proveedor}}</strong>
                            </div>
                        </td>
                        <td>
                            <span [title]="contrato.descripcion || 'Sin descripción'">
                                {{(contrato.descripcion || 'Sin descripción').length > 50 ? ((contrato.descripcion || 'Sin descripción').substring(0, 50) + '...') : (contrato.descripcion || 'Sin descripción')}}
                            </span>
                        </td>
                        <td>
                            <div class="text-sm">
                                <i class="pi pi-calendar text-xs mr-1 text-500"></i>
                                {{formatDate(contrato.fechaInicio)}}
                            </div>
                        </td>
                        <td>
                            <div class="text-sm">
                                <i class="pi pi-calendar text-xs mr-1 text-500"></i>
                                {{formatDate(contrato.fechaFin)}}
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="getEstadoLabel(contrato)"
                                   [severity]="getEstadoSeverity(contrato.estado)"
                                   [rounded]="true">
                            </p-tag>
                        </td>
                        <td>
                            <p-tag [value]="getVigenciaLabel(contrato)"
                                   [severity]="getVigenciaSeverity(getVigenciaLabel(contrato))"
                                   [rounded]="true">
                            </p-tag>
                        </td>
                        <td>
                            <p-tag [value]="(contrato.totalArchivos || 0) + ' archivo' + ((contrato.totalArchivos || 0) === 1 ? '' : 's')" 
                                   [severity]="contrato.totalArchivos > 0 ? 'success' : 'secondary'"
                                   [rounded]="true">
                            </p-tag>
                        </td>
                        <td>
                            <div class="flex gap-1 align-items-center">
                            <button *ngIf="tieneAccionesContrato()" pButton pRipple 
                                    icon="pi pi-ellipsis-v" 
                                    class="p-button-rounded p-button-text p-button-secondary" 
                                    (click)="openAccionesMenu($event, contrato)"
                                    pTooltip="Acciones"
                                    tooltipPosition="top"></button>
                                <p-menu #menuAcciones [popup]="true" [model]="accionesMenuItems" appendTo="body"></p-menu>
                                </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="9" class="text-center p-5">
                            <div class="flex flex-column align-items-center">
                                <i class="pi pi-file-excel text-5xl text-400 mb-3"></i>
                                <span class="text-900 font-semibold text-xl mb-2">No hay contratos disponibles</span>
                                <span class="text-600 text-base mb-1">No se encontraron contratos activos y vigentes en el sistema.</span>
                                <span class="text-500 text-sm mb-3">Puede crear un nuevo contrato para comenzar a gestionar sus proveedores.</span>
                                <button pButton pRipple label="Crear Nuevo Contrato" icon="pi pi-plus" 
                                        class="p-button-success p-button-sm mt-2"
                                        (click)="openNew()"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<p-dialog header="{{isEditing ? 'Editar' : 'Nuevo'}} Contrato" 
          [(visible)]="displayDialog" [modal]="true" [closable]="true" 
          [style]="{width: '600px'}" styleClass="p-fluid">
    
    <ng-template pTemplate="content">
        <!-- Banner informativo -->
        <div class="surface-section px-3 py-2 mb-4 border-round">
            <div class="flex align-items-center mb-2">
                <i class="pi pi-info-circle text-primary mr-2"></i>
                <span class="font-semibold text-900">Información del Contrato</span>
            </div>
            <p class="text-600 text-sm m-0">
                Complete los datos del contrato con el proveedor. La fecha de inicio debe ser anterior a la fecha de fin.
            </p>
        </div>

        <form [formGroup]="contratoForm">
            <div class="grid">
                <div class="col-12 md:col-6">
                    <label for="fechaInicio" class="block font-medium mb-2">
                        Fecha Inicio <span class="text-red-500">*</span>
                    </label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-calendar"></i>
                        </span>
                        <p-calendar formControlName="fechaInicio" inputId="fechaInicio" 
                                   dateFormat="dd/mm/yy" [showIcon]="false" [showButtonBar]="true" 
                                   appendTo="body" placeholder="Seleccione fecha"
                                   [class.ng-invalid]="(contratoForm.get('fechaInicio')?.invalid && contratoForm.get('fechaInicio')?.touched) || getFechasError()">
                        </p-calendar>
                    </div>
                    <small class="block p-error mt-1" *ngIf="getFormError('fechaInicio')">
                        <i class="pi pi-times-circle mr-1"></i>
                        {{ getFormError('fechaInicio') }}
                    </small>
                </div>
                
                <div class="col-12 md:col-6">
                    <label for="fechaFin" class="block font-medium mb-2">
                        Fecha Fin <span class="text-red-500">*</span>
                    </label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-calendar"></i>
                        </span>
                        <p-calendar formControlName="fechaFin" inputId="fechaFin" 
                                   dateFormat="dd/mm/yy" [showIcon]="false" [showButtonBar]="true" 
                                   appendTo="body" placeholder="Seleccione fecha"
                                   [class.ng-invalid]="(contratoForm.get('fechaFin')?.invalid && contratoForm.get('fechaFin')?.touched) || getFechasError()">
                        </p-calendar>
                    </div>
                    <small class="block p-error mt-1" *ngIf="getFormError('fechaFin')">
                        <i class="pi pi-times-circle mr-1"></i>
                        {{ getFormError('fechaFin') }}
                    </small>
                </div>

                <!-- Mensaje de error para validación de fechas -->
                <div class="col-12" *ngIf="getFechasError()">
                    <div class="p-3 border-round" style="background-color: #fee; border: 1px solid #f88;">
                        <div class="flex align-items-center gap-2">
                            <i class="pi pi-exclamation-triangle text-red-500 text-xl"></i>
                            <div>
                                <div class="font-semibold text-red-700 mb-1">Error en las fechas</div>
                                <div class="text-red-600 text-sm">{{ getFechasError() }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-12">
                    <label for="idProveedor" class="block font-medium mb-2">
                        Proveedor <span class="text-red-500">*</span>
                    </label>
                    <p-dropdown formControlName="idProveedor" inputId="idProveedor"
                               [options]="proveedores" optionLabel="nombre" optionValue="idProveedor"
                               placeholder="Seleccione un proveedor" [showClear]="true" appendTo="body"
                               styleClass="w-full"
                               [class.ng-invalid]="contratoForm.get('idProveedor')?.invalid && contratoForm.get('idProveedor')?.touched">
                        <ng-template let-proveedor pTemplate="item">
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-building text-500"></i>
                                <span>{{ proveedor.nombre }}</span>
                            </div>
                        </ng-template>
                        <ng-template let-proveedor pTemplate="selectedItem">
                            <div class="flex align-items-center gap-2" *ngIf="proveedor">
                                <i class="pi pi-building text-500"></i>
                                <span>{{ proveedor.nombre }}</span>
                            </div>
                        </ng-template>
                    </p-dropdown>
                    <small class="block mt-1 text-500">
                        <i class="pi pi-info-circle text-xs mr-1"></i>
                        Empresa o persona que realizará el servicio
                    </small>
                    <small class="block p-error mt-1" *ngIf="getFormError('idProveedor')">
                        <i class="pi pi-times-circle mr-1"></i>
                        {{ getFormError('idProveedor') }}
                    </small>
                </div>
                
                <div class="col-12">
                    <label for="descripcion" class="block font-medium mb-2">
                        Descripción <span class="text-red-500">*</span>
                    </label>
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon">
                            <i class="pi pi-align-left"></i>
                        </span>
                        <textarea pInputTextarea formControlName="descripcion" inputId="descripcion"
                                  rows="3" placeholder="Describa el alcance del contrato..." [autoResize]="true"
                                  maxlength="500"
                                  [class.ng-invalid]="contratoForm.get('descripcion')?.invalid && contratoForm.get('descripcion')?.touched">
                        </textarea>
                    </div>
                    <small class="block mt-1 text-500">
                        <i class="pi pi-info-circle text-xs mr-1"></i>
                        Mínimo 10 caracteres, máximo 500 ({{ contratoForm.get('descripcion')?.value?.length || 0 }}/500)
                    </small>
                    <small class="block p-error mt-1" *ngIf="getFormError('descripcion')">
                        <i class="pi pi-times-circle mr-1"></i>
                        {{ getFormError('descripcion') }}
                    </small>
                </div>

                <!-- Estado del contrato -->
                <div class="col-12">
                    <div class="surface-50 border-round p-3">
                        <div class="flex align-items-center">
                            <p-checkbox formControlName="estado" 
                                       binary="true" 
                                       inputId="estado"
                                       styleClass="mr-2"></p-checkbox>
                            <label for="estado" class="cursor-pointer flex-1">
                                <div class="flex align-items-center">
                                    <i class="pi pi-check-circle text-green-500 mr-2" *ngIf="contratoForm.get('estado')?.value"></i>
                                    <i class="pi pi-times-circle text-red-500 mr-2" *ngIf="!contratoForm.get('estado')?.value"></i>
                                    <div>
                                        <div class="font-semibold" [class.text-green-700]="contratoForm.get('estado')?.value" [class.text-500]="!contratoForm.get('estado')?.value">
                                            {{ contratoForm.get('estado')?.value ? 'Contrato Activo' : 'Contrato Inactivo' }}
                                        </div>
                                        <div class="text-sm text-600">
                                            {{ contratoForm.get('estado')?.value ? 'El contrato está vigente y disponible' : 'El contrato está deshabilitado' }}
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Sección de Archivos -->
                <div class="col-12">
                    <div class="surface-card border-1 surface-border border-round p-3">
                        <div class="flex align-items-center justify-content-between mb-3">
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-paperclip text-xl text-primary"></i>
                                <h6 class="m-0">Archivos del Contrato</h6>
                            </div>
                            <p-tag [value]="uploadedFiles.length.toString()" 
                                   [severity]="uploadedFiles.length > 0 ? 'success' : 'secondary'"
                                   [rounded]="true"></p-tag>
                        </div>
                        
                        <p class="text-sm text-600 mb-3">
                            <i class="pi pi-info-circle mr-1"></i>
                            Adjunte documentos del contrato (PDF, DOC, DOCX - máx. 10MB cada uno)
                        </p>

                        <!-- Upload de archivos en modo básico (sin preview) -->
                        <p-fileUpload #fileUpload
                                      name="files" 
                                      [multiple]="true" 
                                      accept=".pdf,.doc,.docx"
                                      [maxFileSize]="maxFileSize" 
                                      (onSelect)="onFileSelect($event)"
                                      (onRemove)="onFileRemove($event)"
                                      [showUploadButton]="false" 
                                      [showCancelButton]="false"
                                      [auto]="false"
                                      mode="basic"
                                      chooseLabel="Seleccionar Archivos"
                                      chooseIcon="pi pi-plus">
                        </p-fileUpload>
                        
                        <!-- Lista de archivos seleccionados -->
                        <div *ngIf="uploadedFiles.length > 0" class="mt-3">
                            <div class="flex align-items-center justify-content-between mb-2">
                                <span class="font-semibold text-sm">Archivos seleccionados:</span>
                                <button pButton pRipple 
                                        label="Limpiar todo" 
                                        icon="pi pi-times" 
                                        class="p-button-text p-button-sm p-button-danger"
                                        (click)="clearFilesManually()"></button>
                            </div>
                            
                            <div *ngFor="let file of uploadedFiles; let i = index" 
                                 class="flex align-items-center justify-content-between p-2 mb-2 surface-50 border-round">
                                <div class="flex align-items-center gap-2 flex-1">
                                    <i [class]="archivosService.getIconoArchivo(file.name)" class="text-2xl"></i>
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">{{file.name}}</div>
                                        <div class="text-xs text-500">{{archivosService.formatearTamano(file.size)}}</div>
                                    </div>
                                </div>
                                <button pButton pRipple 
                                    *tienePermiso="{ modulo: 'contratos', accion: 'eliminar' }"
                                    icon="pi pi-times" 
                                    class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                    (click)="removeFile(i)"
                                    pTooltip="Eliminar"></button>
                            </div>
                        </div>

                        <!-- Archivos existentes (solo al editar) -->
                        <div *ngIf="isEditing && selectedContrato?.archivos && selectedContrato.archivos.length > 0" class="mt-3">
                            <div class="flex align-items-center justify-content-between mb-2">
                                <span class="font-semibold text-sm">Archivos actuales:</span>
                                <p-tag [value]="selectedContrato.archivos.length.toString()" 
                                       severity="info"
                                       [rounded]="true"></p-tag>
                            </div>
                            
                            <div *ngFor="let archivo of selectedContrato.archivos" 
                                 class="flex align-items-center justify-content-between p-2 mb-2 surface-100 border-round">
                                <div class="flex align-items-center gap-2 flex-1">
                                    <i [class]="archivo.iconoCss" class="text-2xl"></i>
                                    <div class="flex-1">
                                        <div class="font-medium text-sm">{{archivo.nombreOriginal}}</div>
                                        <div class="text-xs text-500">{{archivo.tamanoFormateado}}</div>
                                    </div>
                                </div>
                                <div class="flex gap-1">
                                    <button pButton pRipple 
                                            icon="pi pi-download" 
                                            class="p-button-rounded p-button-text p-button-info p-button-sm"
                                            (click)="downloadFile(archivo)"
                                            pTooltip="Descargar"></button>
                                        <button pButton pRipple 
                                            *tienePermiso="{ modulo: 'contratos', accion: 'eliminar' }"
                                            icon="pi pi-trash" 
                                            class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                            (click)="deleteFile(archivo)"
                                            pTooltip="Eliminar"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </ng-template>
    
    <ng-template pTemplate="footer">
        <div class="flex justify-content-between align-items-center w-full">
            <small class="text-500">
                <i class="pi pi-info-circle mr-1"></i>
                Los campos con * son obligatorios
            </small>
            <div class="flex gap-2">
                <button pButton 
                        type="button" 
                        label="Cancelar" 
                        icon="pi pi-times" 
                        class="p-button-text p-button-secondary" 
                        (click)="displayDialog=false"></button>
                <button pButton 
                        type="submit" 
                        [label]="isEditing ? 'Actualizar' : 'Crear'" 
                        [icon]="isEditing ? 'pi pi-check' : 'pi pi-plus'" 
                        [disabled]="contratoForm.invalid" 
                        (click)="saveContrato()"></button>
            </div>
        </div>
    </ng-template>
</p-dialog>

<!-- Toast para mensajes -->
<p-toast></p-toast>

<!-- Confirmación de acciones -->
<p-confirmDialog></p-confirmDialog>
