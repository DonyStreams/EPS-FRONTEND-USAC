<div class="card">
  <div class="flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Listado de Equipos</h4>
    <button pButton type="button" icon="pi pi-plus" label="Registrar nuevo equipo"
      class="p-button-success" style="min-width: 220px"
      (click)="abrirModalNuevoEquipo()"></button>
  </div>

  <!-- Filtros externos eliminados, solo se usan los nativos de PrimeNG en la tabla -->
  <div class="flex justify-content-between align-items-center mb-2">
    <div class="w-50">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Filtrar equipos..." class="w-full" />
      </span>
    </div>
    <button pButton type="button" label="Eliminar seleccionados" icon="pi pi-trash" class="p-button-danger" [disabled]="!equiposSeleccionados?.length" (click)="eliminarSeleccionados()"></button>
  </div>
  <p-table #dt
    [value]="equipos"
    [(selection)]="equiposSeleccionados"
    dataKey="idEquipo"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5,10,20]"
    [responsiveLayout]="'scroll'"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} equipos"
    [globalFilterFields]="['nombre','codigoInacif','marca','modelo','numeroSerie']"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="nombre">Nombre <p-sortIcon field="nombre"></p-sortIcon></th>
        <th pSortableColumn="codigoInacif">Código INACIF <p-sortIcon field="codigoInacif"></p-sortIcon></th>
        <th pSortableColumn="marca">Marca <p-sortIcon field="marca"></p-sortIcon></th>
        <th pSortableColumn="modelo">Modelo <p-sortIcon field="modelo"></p-sortIcon></th>
        <th pSortableColumn="numeroSerie">N° Serie <p-sortIcon field="numeroSerie"></p-sortIcon></th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-equipo let-selected="selected">
      <tr>
        <td>
          <p-tableCheckbox [value]="equipo"></p-tableCheckbox>
        </td>
        <td>{{ equipo.nombre }}</td>
        <td>{{ equipo.codigoInacif }}</td>
        <td>{{ equipo.marca }}</td>
        <td>{{ equipo.modelo }}</td>
        <td>{{ equipo.numeroSerie }}</td>
        <td>
          <button pButton icon="pi pi-pencil" class="p-button-text p-button-info" pTooltip="Editar" (click)="editarEquipo(equipo)"></button>
          <button pButton icon="pi pi-history" class="p-button-text" pTooltip="Ver historial"></button>
          <button pButton icon="pi pi-wrench" class="p-button-text" pTooltip="Ver mantenimientos"></button>
          <button pButton icon="pi pi-download" class="p-button-text" pTooltip="Descargar ficha" (click)="descargarFicha(equipo)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal para registrar nuevo equipo -->
  <p-dialog header="Registrar Nuevo Equipo" [(visible)]="mostrarModalNuevoEquipo" [modal]="true" [style]="{width: '700px'}" [closable]="false">
    <form #formEquipo="ngForm" (ngSubmit)="registrarEquipo()" autocomplete="off">
      <div *ngIf="mensaje" class="p-message p-message-success mb-3">
        <div class="p-message-wrapper">
          <span class="p-message-icon pi pi-check"></span>
          <span class="p-message-text">{{ mensaje }}</span>
        </div>
      </div>
      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="field mb-2">
            <label for="nombre">Nombre del equipo</label>
            <input pInputText id="nombre" name="nombre" [(ngModel)]="nuevoEquipo.nombre" required maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="codigoInacif">Código del INACIF</label>
            <input pInputText id="codigoInacif" name="codigoInacif" [(ngModel)]="nuevoEquipo.codigoInacif" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="marca">Marca</label>
            <input pInputText id="marca" name="marca" [(ngModel)]="nuevoEquipo.marca" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="modelo">Modelo</label>
            <input pInputText id="modelo" name="modelo" [(ngModel)]="nuevoEquipo.modelo" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="serie">No. de serie</label>
            <input pInputText id="serie" name="serie" [(ngModel)]="nuevoEquipo.numeroSerie" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="ubicacion">Ubicación</label>
            <input pInputText id="ubicacion" name="ubicacion" [(ngModel)]="nuevoEquipo.ubicacion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="magnitud">Magnitud de medición</label>
            <input pInputText id="magnitud" name="magnitud" [(ngModel)]="nuevoEquipo.magnitudMedicion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="rango">Rango o capacidad</label>
            <input pInputText id="rango" name="rango" [(ngModel)]="nuevoEquipo.rangoCapacidad" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="manual">Código y nombre del manual del fabricante</label>
            <input pInputText id="manual" name="manual" [(ngModel)]="nuevoEquipo.manualFabricante" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="software">Software/Firmware</label>
            <input pInputText id="software" name="software" [(ngModel)]="nuevoEquipo.softwareFirmware" maxlength="100" class="w-full" />
          </div>
        </div>
        <div class="col-12 md:col-6">
          <div class="field mb-3">
            <label for="fotografia">Fotografía</label>
            <p-fileUpload #fileUpload
                          mode="basic"
                          name="fotografia"
                          accept="image/*"
                          maxFileSize="2000000"
                          chooseLabel="Seleccionar imagen"
                          (onSelect)="onFileSelected($event)"
                          (onUpload)="onFileSelected($event)"
                          [auto]="true"
                          [customUpload]="true"
                          [showUploadButton]="false"
                          [showCancelButton]="false"
                          class="w-full" />
            <div *ngIf="previewUrl" class="mt-2">
              <img [src]="previewUrl" alt="Previsualización" class="border-round" style="max-width: 100%; max-height: 180px;">
            </div>
            <div *ngIf="errorImagen" class="p-message p-message-error mt-2">
              <div class="p-message-wrapper">
                <span class="p-message-icon pi pi-times"></span>
                <span class="p-message-text">{{ errorImagen }}</span>
              </div>
            </div>
          </div>
          <div class="field mb-2">
            <label for="condiciones">Condiciones de operación</label>
            <textarea pInputTextarea id="condiciones" name="condiciones" [(ngModel)]="nuevoEquipo.condicionesOperacion" rows="3" class="w-full"></textarea>
          </div>
          <div class="field mb-2"> 
            <label for="descripcion">Descripción del equipo</label>
            <textarea pInputTextarea id="descripcion" name="descripcion" [(ngModel)]="nuevoEquipo.descripcion" rows="3" class="w-full"></textarea>
          </div>
        </div>
      </div>
      <div class="flex justify-content-end gap-2 mt-4">
        <button pButton type="button" label="Cancelar" class="p-button-secondary" (click)="cerrarModalNuevoEquipo()"></button>
        <button pButton type="submit" label="Registrar" class="p-button-success" [disabled]="formEquipo.invalid"></button>
      </div>
    </form>
  </p-dialog>

  <!-- Modal para editar equipo -->
  <p-dialog header="Editar Equipo" [(visible)]="mostrarModalEditarEquipo" [modal]="true" [style]="{width: '700px'}" [closable]="false">
    <form #formEditarEquipo="ngForm" (ngSubmit)="actualizarEquipo()" autocomplete="off" *ngIf="equipoEditando">
      <div *ngIf="mensaje" class="p-message p-message-success mb-3">
        <div class="p-message-wrapper">
          <span class="p-message-icon pi pi-check"></span>
          <span class="p-message-text">{{ mensaje }}</span>
        </div>
      </div>
      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="field mb-2">
            <label for="editNombre">Nombre del equipo</label>
            <input pInputText id="editNombre" name="editNombre" [(ngModel)]="equipoEditando.nombre" required maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editCodigoInacif">Código del INACIF</label>
            <input pInputText id="editCodigoInacif" name="editCodigoInacif" [(ngModel)]="equipoEditando.codigoInacif" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editMarca">Marca</label>
            <input pInputText id="editMarca" name="editMarca" [(ngModel)]="equipoEditando.marca" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editModelo">Modelo</label>
            <input pInputText id="editModelo" name="editModelo" [(ngModel)]="equipoEditando.modelo" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editSerie">No. de serie</label>
            <input pInputText id="editSerie" name="editSerie" [(ngModel)]="equipoEditando.numeroSerie" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editUbicacion">Ubicación</label>
            <input pInputText id="editUbicacion" name="editUbicacion" [(ngModel)]="equipoEditando.ubicacion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editMagnitud">Magnitud de medición</label>
            <input pInputText id="editMagnitud" name="editMagnitud" [(ngModel)]="equipoEditando.magnitudMedicion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editRango">Rango o capacidad</label>
            <input pInputText id="editRango" name="editRango" [(ngModel)]="equipoEditando.rangoCapacidad" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editManual">Código y nombre del manual del fabricante</label>
            <input pInputText id="editManual" name="editManual" [(ngModel)]="equipoEditando.manualFabricante" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="editSoftware">Software/Firmware</label>
            <input pInputText id="editSoftware" name="editSoftware" [(ngModel)]="equipoEditando.softwareFirmware" maxlength="100" class="w-full" />
          </div>
        </div>
        <div class="col-12 md:col-6">
          <div class="field mb-3">
            <label for="editFotografia">Fotografía</label>
            <p-fileUpload #fileUploadEdit
                          mode="basic"
                          name="editFotografia"
                          accept="image/*"
                          maxFileSize="2000000"
                          chooseLabel="Cambiar imagen"
                          (onSelect)="onFileSelectedEdit($event)"
                          (onUpload)="onFileSelectedEdit($event)"
                          [auto]="true"
                          [customUpload]="true"
                          [showUploadButton]="false"
                          [showCancelButton]="false"
                          class="w-full" />
            <div *ngIf="previewUrlEdit" class="mt-2">
              <img [src]="previewUrlEdit" alt="Previsualización" class="border-round" style="max-width: 100%; max-height: 180px;">
            </div>
            <div *ngIf="errorImagenEdit" class="p-message p-message-error mt-2">
              <div class="p-message-wrapper">
                <span class="p-message-icon pi pi-times"></span>
                <span class="p-message-text">{{ errorImagenEdit }}</span>
              </div>
            </div>
          </div>
          <div class="field mb-2">
            <label for="editCondiciones">Condiciones de operación</label>
            <textarea pInputTextarea id="editCondiciones" name="editCondiciones" [(ngModel)]="equipoEditando.condicionesOperacion" rows="3" class="w-full"></textarea>
          </div>
          <div class="field mb-2"> 
            <label for="editDescripcion">Descripción del equipo</label>
            <textarea pInputTextarea id="editDescripcion" name="editDescripcion" [(ngModel)]="equipoEditando.descripcion" rows="3" class="w-full"></textarea>
          </div>
        </div>
      </div>
      <div class="flex justify-content-end gap-2 mt-4">
        <button pButton type="button" label="Cancelar" class="p-button-secondary" (click)="cerrarModalEditarEquipo()"></button>
        <button pButton type="submit" label="Actualizar" class="p-button-success" [disabled]="formEditarEquipo.invalid"></button>
      </div>
    </form>
  </p-dialog>
</div>