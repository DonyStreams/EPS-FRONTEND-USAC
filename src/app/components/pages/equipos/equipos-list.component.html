<div class="card">
  <div class="flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Listado de Equipos</h4>
    <button pButton type="button" icon="pi pi-plus" label="Registrar nuevo equipo"
      class="p-button-success" style="min-width: 220px"
      (click)="mostrarModalNuevoEquipo = true"></button>
  </div>

  <!-- Filtros externos eliminados, solo se usan los nativos de PrimeNG en la tabla -->
  <div class="flex justify-content-between align-items-center mb-2">
    <div class="w-50">
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input pInputText type="text" (input)="dt.filterGlobal($event.target.value, 'contains')" placeholder="Filtrar equipos..." class="w-full" />
      </span>
    </div>
    <button pButton type="button" label="Eliminar seleccionados" icon="pi pi-trash" class="p-button-danger" [disabled]="!equiposSeleccionados?.length" (click)="eliminarSeleccionados()"></button>
  </div>
  <p-table #dt
    [value]="equipos"
    [(selection)]="equiposSeleccionados"
    dataKey="idEquipo"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5,10,20]"
    [responsiveLayout]="'scroll'"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} equipos"
    [globalFilterFields]="['nombre','numeroSerie','marca','modelo','ubicacion','estado']"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="nombre">Nombre <p-sortIcon field="nombre"></p-sortIcon></th>
        <th pSortableColumn="numeroSerie">N° Serie <p-sortIcon field="numeroSerie"></p-sortIcon></th>
        <th pSortableColumn="marca">Marca <p-sortIcon field="marca"></p-sortIcon></th>
        <th pSortableColumn="modelo">Modelo <p-sortIcon field="modelo"></p-sortIcon></th>
        <th pSortableColumn="ubicacion">Ubicación <p-sortIcon field="ubicacion"></p-sortIcon></th>
        <th pSortableColumn="estado">Estado <p-sortIcon field="estado"></p-sortIcon></th>
        <th>Fotografía</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-equipo let-selected="selected">
      <tr>
        <td>
          <p-tableCheckbox [value]="equipo"></p-tableCheckbox>
        </td>
        <td>{{ equipo.nombre }}</td>
        <td>{{ equipo.numeroSerie }}</td>
        <td>{{ equipo.marca }}</td>
        <td>{{ equipo.modelo }}</td>
        <td>{{ equipo.ubicacion }}</td>
        <td>
          <span [ngClass]="{'text-green-600': equipo.estado === true || equipo.estado === 'Activo', 'text-red-500': equipo.estado === false || equipo.estado === 'Inactivo'}">
            {{ equipo.estado === true || equipo.estado === 'Activo' ? 'Activo' : 'Inactivo' }}
          </span>
        </td>
        <td>
          <img *ngIf="equipo.fotografia" [src]="equipo.fotografia" alt="Foto" style="max-width: 60px; max-height: 40px; border-radius: 4px;" />
        </td>
        <td>
          <button pButton icon="pi pi-history" class="p-button-text" pTooltip="Ver historial"></button>
          <button pButton icon="pi pi-wrench" class="p-button-text" pTooltip="Ver mantenimientos"></button>
          <button pButton icon="pi pi-pencil" class="p-button-text" pTooltip="Editar"></button>
          <button pButton icon="pi pi-download" class="p-button-text" pTooltip="Descargar ficha" (click)="descargarFicha(equipo)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal para registrar nuevo equipo -->
  <p-dialog header="Registrar Nuevo Equipo" [(visible)]="mostrarModalNuevoEquipo" [modal]="true" [style]="{width: '700px'}" [closable]="false">
    <form #formEquipo="ngForm" (ngSubmit)="registrarEquipo()" autocomplete="off">
      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="field mb-2">
            <label for="nombre">Nombre del equipo</label>
            <input pInputText id="nombre" name="nombre" [(ngModel)]="nuevoEquipo.nombre" required maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="codigoInacif">Código del INACIF</label>
            <input pInputText id="codigoInacif" name="codigoInacif" [(ngModel)]="nuevoEquipo.codigoInacif" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="marca">Marca</label>
            <input pInputText id="marca" name="marca" [(ngModel)]="nuevoEquipo.marca" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="modelo">Modelo</label>
            <input pInputText id="modelo" name="modelo" [(ngModel)]="nuevoEquipo.modelo" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="serie">No. de serie</label>
            <input pInputText id="serie" name="serie" [(ngModel)]="nuevoEquipo.numeroSerie" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="ubicacion">Ubicación</label>
            <input pInputText id="ubicacion" name="ubicacion" [(ngModel)]="nuevoEquipo.ubicacion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="magnitud">Magnitud de medición</label>
            <input pInputText id="magnitud" name="magnitud" [(ngModel)]="nuevoEquipo.magnitudMedicion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="rango">Rango o capacidad</label>
            <input pInputText id="rango" name="rango" [(ngModel)]="nuevoEquipo.rangoCapacidad" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="manual">Código y nombre del manual del fabricante</label>
            <input pInputText id="manual" name="manual" [(ngModel)]="nuevoEquipo.manualFabricante" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="software">Software/Firmware</label>
            <input pInputText id="software" name="software" [(ngModel)]="nuevoEquipo.softwareFirmware" maxlength="100" class="w-full" />
          </div>
        </div>
        <div class="col-12 md:col-6">
          <div class="field mb-3">
            <label for="fotografia">Fotografía</label>
            <p-fileUpload mode="basic"
                          name="fotografia"
                          accept="image/*"
                          maxFileSize="2000000"
                          chooseLabel="Seleccionar imagen"
                          (onSelect)="onFileSelected($event)"
                          [auto]="true"
                          [customUpload]="true"
                          [showUploadButton]="false"
                          [showCancelButton]="false"
                          class="w-full" />
            <div *ngIf="previewUrl" class="mt-2">
              <img [src]="previewUrl" alt="Previsualización" class="border-round" style="max-width: 100%; max-height: 180px;">
            </div>
          </div>
          <div class="field mb-2">
            <label for="condiciones">Condiciones de operación</label>
            <textarea pInputTextarea id="condiciones" name="condiciones" [(ngModel)]="nuevoEquipo.condicionesOperacion" rows="3" class="w-full"></textarea>
          </div>
          <div class="field mb-2"> 
            <label for="descripcion">Descripción del equipo</label>
            <textarea pInputTextarea id="descripcion" name="descripcion" [(ngModel)]="nuevoEquipo.descripcion" rows="3" class="w-full"></textarea>
          </div>
        </div>
      </div>
      <div class="flex justify-content-end gap-2 mt-4">
        <button pButton type="button" label="Cancelar" class="p-button-secondary" (click)="mostrarModalNuevoEquipo = false"></button>
        <button pButton type="submit" label="Registrar" class="p-button-success" [disabled]="formEquipo.invalid"></button>
      </div>
    </form>
  </p-dialog>
</div>