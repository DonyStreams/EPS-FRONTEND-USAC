<div class="card">
  <div class="flex justify-content-between align-items-center mb-3">
    <h4 class="m-0">Listado de Equipos</h4>
    <button pButton type="button" icon="pi pi-plus" label="Registrar nuevo equipo"
      class="p-button-success" style="min-width: 220px"
      (click)="mostrarModalNuevoEquipo = true"></button>
  </div>

  <div class="surface-100 p-3 border-round mb-3">
    <div class="grid formgrid">
      <div class="field col-12 md:col-3">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-hashtag"></i>
          <input pInputText [(ngModel)]="filtro.inventario" placeholder="N° Inventario" (input)="cargarEquipos()" class="w-full">
        </span>
      </div>
      <div class="field col-12 md:col-3">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-barcode"></i>
          <input pInputText [(ngModel)]="filtro.serie" placeholder="N° Serie" (input)="cargarEquipos()" class="w-full">
        </span>
      </div>
      <div class="field col-12 md:col-3">
        <span class="p-input-icon-left w-full">
          <i class="pi pi-sitemap"></i>
          <input pInputText [(ngModel)]="filtro.area" placeholder="Área" (input)="cargarEquipos()" class="w-full">
        </span>
      </div>
      <div class="field col-12 md:col-3">
        <p-dropdown 
          [options]="estados" 
          [(ngModel)]="filtro.estado" 
          placeholder="Estado" 
          (onChange)="cargarEquipos()"
          optionLabel="label"
          optionValue="value"
          class="w-full">
        </p-dropdown>
      </div>
      <div class="field col-12 md:col-12 flex gap-2 justify-content-end mt-2">
        <button pButton type="button" label="Buscar" icon="pi pi-search" class="p-button-primary" (click)="cargarEquipos()"></button>
        <button pButton type="button" label="Limpiar" icon="pi pi-filter-slash" class="p-button-secondary" (click)="limpiarFiltros()"></button>
      </div>
    </div>
  </div>
  <div class="flex justify-content-end mb-2">
    <button pButton type="button" label="Eliminar seleccionados" icon="pi pi-trash" class="p-button-danger" [disabled]="!equiposSeleccionados?.length" (click)="eliminarSeleccionados()"></button>
  </div>
  <p-table 
    [value]="equipos"
    [(selection)]="equiposSeleccionados"
    dataKey="numeroInventario"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[5,10,20]"
    [responsiveLayout]="'scroll'"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} equipos"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th>N° Inventario</th>
        <th>N° Serie</th>
        <th>Descripción</th>
        <th>Estado</th>
        <th>Área</th>
        <th>Acciones</th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-equipo let-selected="selected">
      <tr>
        <td>
          <p-tableCheckbox [value]="equipo"></p-tableCheckbox>
        </td>
        <td>{{ equipo.numeroInventario }}</td>
        <td>{{ equipo.numeroSerie }}</td>
        <td>{{ equipo.descripcion }}</td>
        <td>
          <span [ngClass]="{'text-green-600': equipo.estado === true || equipo.estado === 'Activo', 'text-red-500': equipo.estado === false || equipo.estado === 'Inactivo'}">
            {{ equipo.estado === true || equipo.estado === 'Activo' ? 'Activo' : 'Inactivo' }}
          </span>
        </td>
        <td>{{ equipo.area }}</td>
        <td>
          <button pButton icon="pi pi-history" class="p-button-text" pTooltip="Ver historial"></button>
          <button pButton icon="pi pi-wrench" class="p-button-text" pTooltip="Ver mantenimientos"></button>
          <button pButton icon="pi pi-pencil" class="p-button-text" pTooltip="Editar"></button>
          <button pButton icon="pi pi-download" class="p-button-text" pTooltip="Descargar ficha" (click)="descargarFicha(equipo)"></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Modal para registrar nuevo equipo -->
  <p-dialog header="Registrar Nuevo Equipo" [(visible)]="mostrarModalNuevoEquipo" [modal]="true" [style]="{width: '700px'}" [closable]="false">
    <form #formEquipo="ngForm" (ngSubmit)="registrarEquipo()" autocomplete="off">
      <div class="grid">
        <div class="col-12 md:col-6">
          <div class="field mb-2">
            <label for="nombre">Nombre del equipo</label>
            <input pInputText id="nombre" name="nombre" [(ngModel)]="nuevoEquipo.nombre" required maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="codigoInacif">Código del INACIF</label>
            <input pInputText id="codigoInacif" name="codigoInacif" [(ngModel)]="nuevoEquipo.codigoInacif" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="marca">Marca</label>
            <input pInputText id="marca" name="marca" [(ngModel)]="nuevoEquipo.marca" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="modelo">Modelo</label>
            <input pInputText id="modelo" name="modelo" [(ngModel)]="nuevoEquipo.modelo" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="serie">No. de serie</label>
            <input pInputText id="serie" name="serie" [(ngModel)]="nuevoEquipo.numeroSerie" maxlength="50" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="ubicacion">Ubicación</label>
            <input pInputText id="ubicacion" name="ubicacion" [(ngModel)]="nuevoEquipo.ubicacion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="magnitud">Magnitud de medición</label>
            <input pInputText id="magnitud" name="magnitud" [(ngModel)]="nuevoEquipo.magnitudMedicion" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="rango">Rango o capacidad</label>
            <input pInputText id="rango" name="rango" [(ngModel)]="nuevoEquipo.rangoCapacidad" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="manual">Código y nombre del manual del fabricante</label>
            <input pInputText id="manual" name="manual" [(ngModel)]="nuevoEquipo.manualFabricante" maxlength="100" class="w-full" />
          </div>
          <div class="field mb-2">
            <label for="software">Software/Firmware</label>
            <input pInputText id="software" name="software" [(ngModel)]="nuevoEquipo.softwareFirmware" maxlength="100" class="w-full" />
          </div>
        </div>
        <div class="col-12 md:col-6">
          <div class="field mb-3">
            <label for="fotografia">Fotografía</label>
            <p-fileUpload mode="basic"
                          name="fotografia"
                          accept="image/*"
                          maxFileSize="2000000"
                          chooseLabel="Seleccionar imagen"
                          (onSelect)="onFileSelected($event)"
                          [auto]="true"
                          [customUpload]="true"
                          [showUploadButton]="false"
                          [showCancelButton]="false"
                          class="w-full" />
            <div *ngIf="previewUrl" class="mt-2">
              <img [src]="previewUrl" alt="Previsualización" class="border-round" style="max-width: 100%; max-height: 180px;">
            </div>
          </div>
          <div class="field mb-2">
            <label for="condiciones">Condiciones de operación</label>
            <textarea pInputTextarea id="condiciones" name="condiciones" [(ngModel)]="nuevoEquipo.condicionesOperacion" rows="3" class="w-full"></textarea>
          </div>
          <div class="field mb-2"> 
            <label for="descripcion">Descripción del equipo</label>
            <textarea pInputTextarea id="descripcion" name="descripcion" [(ngModel)]="nuevoEquipo.descripcion" rows="3" class="w-full"></textarea>
          </div>
        </div>
      </div>
      <div class="flex justify-content-end gap-2 mt-4">
        <button pButton type="button" label="Cancelar" class="p-button-secondary" (click)="mostrarModalNuevoEquipo = false"></button>
        <button pButton type="submit" label="Registrar" class="p-button-success" [disabled]="formEquipo.invalid"></button>
      </div>
    </form>
  </p-dialog>
</div>