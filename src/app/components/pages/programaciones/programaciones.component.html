<div class="grid">
    <!-- Título y descripción -->
    <div class="col-12">
        <div class="card">
            <h5>Programaciones de Mantenimiento</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Gestione las programaciones automáticas de mantenimientos
                preventivos, correctivos y calibraciones.</p>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="col-12 md:col-6 lg:col-3 xl:col-2">
        <div class="card bg-blue-100 border-left-3 border-blue-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-blue-600 font-medium text-sm">Total</span>
                    <div class="text-2xl font-bold text-blue-900">{{stats.total}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-500 border-circle"
                    style="width:2.5rem;height:2.5rem">
                    <i class="pi pi-calendar text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 xl:col-2">
        <div class="card bg-green-100 border-left-3 border-green-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-green-600 font-medium text-sm">Activas</span>
                    <div class="text-2xl font-bold text-green-900">{{stats.activas}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-green-500 border-circle"
                    style="width:2.5rem;height:2.5rem">
                    <i class="pi pi-check-circle text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 xl:col-2">
        <div class="card bg-cyan-100 border-left-3 border-cyan-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-cyan-600 font-medium text-sm">Próximas (7d)</span>
                    <div class="text-2xl font-bold text-cyan-900">{{stats.proximas}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-cyan-500 border-circle"
                    style="width:2.5rem;height:2.5rem">
                    <i class="pi pi-clock text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 xl:col-3">
        <div class="card bg-red-100 border-left-3 border-red-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-red-600 font-medium text-sm">Fecha Vencida</span>
                    <div class="text-2xl font-bold text-red-900">{{stats.vencidasFecha}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-red-500 border-circle"
                    style="width:2.5rem;height:2.5rem">
                    <i class="pi pi-calendar-times text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-6 lg:col-3 xl:col-3">
        <div class="card bg-orange-100 border-left-3 border-orange-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-orange-600 font-medium text-sm">Contrato Vencido</span>
                    <div class="text-2xl font-bold text-orange-900">{{stats.contratosVencidos}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-500 border-circle"
                    style="width:2.5rem;height:2.5rem">
                    <i class="pi pi-file-excel text-white"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de programaciones -->
    <div class="col-12">
        <div class="card">
            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <button pButton pRipple label="Nueva Programación" icon="pi pi-plus" class="p-button-success mr-2"
                        (click)="openNew()"></button>
                    <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" class="p-button-outlined mr-2"
                        routerLink="/administracion/mantenimientos"
                        pTooltip="Ver programaciones y ejecuciones en calendario"></button>
                </ng-template>                
            </p-toolbar>

            <!-- Banner de filtro activo -->
            <div *ngIf="filtroProgramacionId || filtroEquipoId || filtroTipoMantenimientoId" 
                 class="surface-100 border-round p-3 mb-3">
                <div class="flex align-items-center justify-content-between">
                    <div class="flex align-items-center gap-2">
                        <i class="pi pi-filter text-primary text-xl"></i>
                        <div>
                            <div class="font-semibold text-900">
                                <span *ngIf="filtroProgramacionId">Filtrado por programación:</span>
                                <span *ngIf="!filtroProgramacionId && filtroEquipoId">Filtrado por equipo:</span>
                                <span *ngIf="!filtroProgramacionId && !filtroEquipoId && filtroTipoMantenimientoId">Filtrado por tipo:</span>
                            </div>
                            <div class="text-600">
                                <span *ngIf="filtroProgramacionId">
                                    {{filtroEquipoNombre || 'Equipo desconocido'}} (ID: {{filtroProgramacionId}})
                                </span>
                                <span *ngIf="!filtroProgramacionId && filtroEquipoId">
                                    {{filtroEquipoNombre || 'ID: ' + filtroEquipoId}}
                                    <span *ngIf="filtroTipoMantenimientoId"> - Tipo: {{filtroTipoMantenimientoNombre}}</span>
                                </span>
                                <span *ngIf="!filtroProgramacionId && !filtroEquipoId && filtroTipoMantenimientoId">
                                    {{filtroTipoMantenimientoNombre}}
                                </span>
                            </div>
                        </div>
                    </div>
                    <button pButton label="Ver Todo" icon="pi pi-times" class="p-button-text" (click)="limpiarFiltroEquipo()"></button>
                </div>
            </div>

            <p-table #dt [value]="programacionesFiltradas" [loading]="loading" [paginator]="true" [rows]="10"
                [rowsPerPageOptions]="[10,20,30]" [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} programaciones"
                [globalFilterFields]="['equipo.nombre','tipoMantenimiento.nombre','contrato.descripcion']"
                [rowHover]="true" dataKey="idProgramacion">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Gestión de Programaciones</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..."
                                class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="equipo.nombre">Equipo <p-sortIcon field="equipo.nombre"></p-sortIcon></th>
                        <th pSortableColumn="tipoMantenimiento.nombre">Tipo <p-sortIcon
                                field="tipoMantenimiento.nombre"></p-sortIcon></th>
                        <th pSortableColumn="frecuenciaDias">Frecuencia <p-sortIcon field="frecuenciaDias"></p-sortIcon></th>
                        <th pSortableColumn="fechaProximoMantenimiento">Próximo Mantenimiento <p-sortIcon
                                field="fechaProximoMantenimiento"></p-sortIcon></th>
                        <th pSortableColumn="activa">Estado <p-sortIcon field="activa"></p-sortIcon></th>
                        <th style="width: 100px"></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-programacion>
                    <tr>
                        <td>
                            <div class="flex align-items-center gap-2">
                                <i class="pi pi-desktop text-primary"></i>
                                <div>
                                    <div class="font-semibold text-900">{{programacion.equipo?.nombre}}</div>
                                    <div class="text-xs text-500">{{programacion.equipo?.codigoInacif}}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="programacion.tipoMantenimiento?.nombre"
                                [severity]="getTipoSeverity(programacion.tipoMantenimiento?.nombre)"
                                [rounded]="true"></p-tag>
                        </td>
                        <td>
                            <span *ngIf="programacion.frecuenciaDias === 0" class="flex align-items-center gap-1">
                                <i class="pi pi-calendar-times text-purple-500"></i>
                                <span class="text-purple-700 font-medium">Único</span>
                            </span>
                            <span *ngIf="programacion.frecuenciaDias > 0" class="font-medium text-700">
                                Cada {{programacion.frecuenciaDias}} días
                            </span>
                        </td>
                        <td>
                            <div class="flex flex-column gap-1">
                                <div class="flex align-items-center gap-2">
                                    <span class="font-semibold" [class]="getDateClass(programacion.fechaProximoMantenimiento)">
                                        {{programacion.fechaProximoMantenimiento | date:'dd/MM/yyyy'}}
                                    </span>
                                </div>
                                <!-- Tags de estado -->
                                <div class="flex flex-wrap gap-1">
                                    <!-- Solo fecha vencida -->
                                    <p-tag *ngIf="isVencida(programacion.fechaProximoMantenimiento) && !isContratoVencido(programacion)" 
                                        value="VENCIDA"
                                        severity="danger" [style]="{fontSize: '0.7rem'}"></p-tag>
                                    <!-- Solo contrato vencido -->
                                    <p-tag *ngIf="!isVencida(programacion.fechaProximoMantenimiento) && isContratoVencido(programacion)" 
                                        value="CONTRATO VENCIDO"
                                        severity="warning" [style]="{fontSize: '0.7rem'}"
                                        [pTooltip]="'El contrato venció el ' + (programacion.contrato?.fechaFin | date:'dd/MM/yyyy')"></p-tag>
                                    <!-- Ambos vencidos -->
                                    <ng-container *ngIf="isVencida(programacion.fechaProximoMantenimiento) && isContratoVencido(programacion)">
                                        <p-tag value="VENCIDA" severity="danger" [style]="{fontSize: '0.7rem'}"></p-tag>
                                        <p-tag value="CONTRATO" severity="warning" [style]="{fontSize: '0.7rem'}"
                                            pTooltip="El contrato también está vencido"></p-tag>
                                    </ng-container>
                                    <!-- Próxima (solo si no hay vencimientos) -->
                                    <p-tag *ngIf="isProxima(programacion.fechaProximoMantenimiento) && !isVencida(programacion.fechaProximoMantenimiento) && !isContratoVencido(programacion)"
                                        value="PRÓXIMA" severity="warning" [style]="{fontSize: '0.7rem'}"></p-tag>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="programacion.activa ? 'Activa' : 'Inactiva'"
                                [severity]="programacion.activa ? 'success' : 'secondary'" [rounded]="true"></p-tag>
                        </td>
                        <td>
                            <div class="flex flex-nowrap align-items-center justify-content-center">
                                <!-- Botón único de detalle -->
                                <button pButton pRipple icon="pi pi-eye"
                                    class="p-button-rounded p-button-text p-button-info"
                                    (click)="verDetalle(programacion)" pTooltip="Ver detalle"></button>
                                
                                <!-- Menú con todas las acciones -->
                                <button pButton pRipple icon="pi pi-ellipsis-v"
                                    class="p-button-rounded p-button-text p-button-secondary"
                                    (click)="openAccionesMenu($event, programacion)"
                                    pTooltip="Acciones"></button>
                                <p-menu #menuAcciones [popup]="true" [model]="accionesMenuItems" appendTo="body"></p-menu>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="6" class="text-center p-5">
                            <div class="flex flex-column align-items-center">
                                <i class="pi pi-calendar-times text-5xl text-400 mb-3"></i>
                                <span class="text-900 font-semibold text-xl mb-2">No hay programaciones registradas</span>
                                <span class="text-600 text-base mb-1">No se encontraron programaciones de mantenimiento en el sistema.</span>
                                <span class="text-500 text-sm mb-3">Cree una nueva programación para automatizar sus mantenimientos preventivos.</span>
                                <button pButton pRipple label="Nueva Programación" icon="pi pi-plus" 
                                        class="p-button-success p-button-sm mt-2"
                                        (click)="openNew()"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>


<!-- Diálogo para crear/editar programación -->
<p-dialog [header]="isEditing ? 'Editar Programación' : 'Nueva Programación'" [(visible)]="displayDialog" [modal]="true"
    [style]="{width: '700px'}" [maximizable]="true" class="p-fluid">

    <ng-template pTemplate="content">
        <!-- Sección: Datos Generales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-box mr-2"></i>Datos Generales
        </div>

        <div class="formgrid grid">
            <!-- Equipo -->
            <div class="field col-12 md:col-6">
                <label for="equipo" class="font-medium">Equipo <span class="text-red-500">*</span></label>
                <p-dropdown id="equipo" [(ngModel)]="programacion.equipoId" [options]="equipos" optionLabel="nombre"
                    optionValue="idEquipo" placeholder="Seleccionar equipo" [filter]="true"
                    filterBy="nombre,codigoInacif" [showClear]="true" required styleClass="w-full"
                    (onChange)="onEquipoChange()">
                    <ng-template pTemplate="selectedItem" let-selectedEquipo>
                        <div class="flex align-items-center" *ngIf="selectedEquipo">
                            <i class="pi pi-cog mr-2 text-primary"></i>
                            <div>{{selectedEquipo.nombre}} <span
                                    class="text-500">({{selectedEquipo.codigoInacif}})</span></div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-equipo>
                        <div class="flex align-items-center">
                            <div>
                                <div class="font-bold">{{equipo.nombre}}</div>
                                <div class="text-sm text-gray-500">Código: {{equipo.codigoInacif}}</div>
                            </div>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Tipo de Mantenimiento -->
            <div class="field col-12 md:col-6">
                <label for="tipoMantenimiento" class="font-medium">Tipo de Mantenimiento <span
                        class="text-red-500">*</span></label>
                <p-dropdown id="tipoMantenimiento" [(ngModel)]="programacion.tipoMantenimientoId"
                    [options]="tiposMantenimiento" optionLabel="nombre" optionValue="idTipo"
                    placeholder="Seleccionar tipo" [showClear]="true" required styleClass="w-full"
                    (onChange)="onTipoChange()">
                    <ng-template pTemplate="selectedItem" let-selected>
                        <div class="flex align-items-center" *ngIf="selected">
                            <i class="pi pi-wrench mr-2 text-orange-500"></i>
                            <div>{{selected.nombre}}</div>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Contrato -->
            <div class="field col-12">
                <label for="contrato" class="font-medium">
                    Contrato <span class="text-red-500">*</span>
                    <span *ngIf="isEditing && contratosDisponibles.length > 0 && contratosDisponibles[0].noVigente" 
                          class="ml-2 text-orange-500 text-sm">
                        <i class="pi pi-exclamation-triangle"></i> El contrato actual ya no está vigente
                    </span>
                </label>
                <p-dropdown id="contrato" [(ngModel)]="programacion.contratoId" [options]="contratosDisponibles"
                    optionLabel="descripcionCompleta" optionValue="idContrato" placeholder="Seleccionar contrato"
                    [filter]="true" filterBy="descripcion,proveedorNombre" [showClear]="true" required
                    styleClass="w-full"
                    emptyMessage="No hay contratos activos y vigentes disponibles"
                    emptyFilterMessage="No se encontraron contratos con ese criterio">
                    <ng-template pTemplate="selectedItem" let-selectedContrato>
                        <div class="flex align-items-center" *ngIf="selectedContrato">
                            <i class="pi mr-2" [ngClass]="selectedContrato.noVigente ? 'pi-exclamation-triangle text-orange-500' : 'pi-file-o text-blue-500'"></i>
                            <div>
                                <span class="font-bold" [ngClass]="{'text-orange-600': selectedContrato.noVigente}">
                                    {{selectedContrato.descripcion}}
                                </span>
                                <span class="text-500 mx-2">|</span>
                                <span class="text-sm">{{selectedContrato.proveedorNombre}}</span>
                                <p-tag *ngIf="selectedContrato.noVigente" value="NO VIGENTE" severity="warning" class="ml-2"></p-tag>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-contrato>
                        <div class="flex align-items-center border-bottom-1 surface-border pb-2" 
                             [ngClass]="{'surface-200': contrato.noVigente}">
                            <div class="flex-1">
                                <div class="flex align-items-center gap-2">
                                    <span class="font-bold" [ngClass]="contrato.noVigente ? 'text-orange-600' : 'text-900'">
                                        {{contrato.descripcion}}
                                    </span>
                                    <p-tag *ngIf="contrato.noVigente" value="NO VIGENTE" severity="warning" [style]="{fontSize: '0.7rem'}"></p-tag>
                                    <p-tag *ngIf="contrato.esContratoActual && !contrato.noVigente" value="ACTUAL" severity="success" [style]="{fontSize: '0.7rem'}"></p-tag>
                                </div>
                                <div class="text-sm text-600 mb-1"><i class="pi pi-building mr-1"></i>{{contrato.proveedorNombre}}</div>
                                <div class="text-xs text-500">
                                    <i class="pi pi-calendar mr-1"></i>
                                    {{contrato.fechaInicio | date:'dd/MM/yyyy'}} - {{contrato.fechaFin | date:'dd/MM/yyyy'}}
                                </div>
                            </div>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small class="text-500"
                    *ngIf="contratosDisponibles.length === 0 && programacion.equipoId && programacion.tipoMantenimientoId">
                    No hay contratos vigentes que cubran este equipo y tipo de mantenimiento
                </small>
                <small class="text-orange-500" *ngIf="isEditing && contratosDisponibles.length > 0 && contratosDisponibles[0].noVigente">
                    <i class="pi pi-info-circle mr-1"></i>
                    Se recomienda seleccionar un contrato vigente para continuar recibiendo servicios de mantenimiento.
                </small>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Sección: Planificación -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-calendar-plus mr-2"></i>Planificación
        </div>

        <div class="formgrid grid">
            <!-- Frecuencia -->
            <div class="field col-12 md:col-6">
                <label for="frecuencia" class="font-medium">Frecuencia <span class="text-red-500">*</span></label>
                <p-dropdown id="frecuencia" [options]="frecuenciaOpciones" 
                    [(ngModel)]="programacion.frecuenciaDias" 
                    optionLabel="label" optionValue="value"
                    placeholder="Seleccionar frecuencia" 
                    styleClass="w-full"
                    (onChange)="onFrecuenciaChange($event)">
                    <ng-template pTemplate="selectedItem" let-selected>
                        <div class="flex align-items-center" *ngIf="selected">
                            <i class="pi pi-sync mr-2 text-primary"></i>
                            <span>{{selected.label}}</span>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-opcion>
                        <div class="flex align-items-center">
                            <i class="pi mr-2" 
                               [ngClass]="{
                                   'pi-calendar-times text-purple-500': opcion.value === 0,
                                   'pi-clock text-orange-500': opcion.value === -1,
                                   'pi-sync': opcion.value > 0
                               }"></i>
                            <span [ngClass]="{'font-italic': opcion.value === -1, 'text-purple-700 font-bold': opcion.value === 0}">{{opcion.label}}</span>
                        </div>
                    </ng-template>
                </p-dropdown>
                <!-- Nota informativa para programación única -->
                <small *ngIf="esUnico" class="text-purple-600 flex align-items-center mt-2">
                    <i class="pi pi-info-circle mr-1"></i>
                    Esta programación se ejecutará una sola vez. Después de ejecutarse, quedará inactiva automáticamente.
                </small>
                <!-- Campo personalizado (aparece solo si selecciona Personalizado) -->
                <div *ngIf="frecuenciaPersonalizada" class="mt-2">
                    <div class="p-inputgroup">
                        <span class="p-inputgroup-addon"><i class="pi pi-pencil"></i></span>
                        <p-inputNumber [(ngModel)]="programacion.frecuenciaDias" 
                            mode="decimal" [min]="1" [max]="730" 
                            placeholder="Ingrese días" 
                            (onInput)="calcularProximaFecha()"
                            styleClass="w-full">
                        </p-inputNumber>
                        <span class="p-inputgroup-addon">días</span>
                    </div>
                    <small class="text-500">Ingrese el número de días entre mantenimientos</small>
                </div>
            </div>

            <!-- Días de alerta previa -->
            <div class="field col-12 md:col-6">
                <label for="diasAlerta" class="font-medium">Alerta Previa <span class="text-red-500">*</span></label>
                <div class="p-inputgroup">
                    <span class="p-inputgroup-addon"><i class="pi pi-bell text-orange-500"></i></span>
                    <p-inputNumber id="diasAlerta" [(ngModel)]="programacion.diasAlertaPrevia" mode="decimal" [min]="1"
                        [max]="30" placeholder="7" required class="w-full">
                    </p-inputNumber>
                    <span class="p-inputgroup-addon">días</span>
                </div>
            </div>

            <!-- Fecha del último mantenimiento -->
            <div class="field col-12 md:col-6">
                <label for="fechaUltimo" class="font-medium">Último Mantenimiento</label>
                <p-calendar id="fechaUltimo" [(ngModel)]="programacion.fechaUltimoMantenimiento" dateFormat="dd/mm/yy"
                    [showIcon]="true" appendTo="body" placeholder="Seleccionar fecha" (onSelect)="calcularProximaFecha()"
                    styleClass="w-full">
                </p-calendar>
                <small class="text-500 flex align-items-center mt-1">
                    <i class="pi pi-info-circle mr-1 text-xs"></i> 
                    Si no ingresa fecha, se usará HOY como referencia
                </small>
            </div>

            <!-- Fecha próximo mantenimiento (editable) -->
            <div class="field col-12 md:col-6">
                <label for="fechaProximo" class="font-medium">Próximo Mantenimiento <span class="text-red-500">*</span></label>
                <p-calendar id="fechaProximo" [(ngModel)]="programacion.fechaProximoMantenimiento" dateFormat="dd/mm/yy"
                    [showIcon]="true" placeholder="Seleccionar fecha" styleClass="w-full" appendTo="body">
                </p-calendar>
                <small class="text-500 flex align-items-center mt-1">
                    <i class="pi pi-info-circle mr-1 text-xs"></i> 
                    Puede editarse manualmente o calcularse con el botón de frecuencia
                </small>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Sección: Detalles Finales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-list mr-2"></i>Detalles Finales
        </div>

        <div class="field">
            <label for="observaciones" class="font-medium">Observaciones</label>
            <textarea pInputTextarea id="observaciones" [(ngModel)]="programacion.observaciones" rows="3"
                placeholder="Ingrese cualquier observación o nota adicional..." [autoResize]="true" class="w-full">
            </textarea>
        </div>

        <div class="field flex align-items-center mt-3">
            <p-checkbox [(ngModel)]="programacion.activa" binary="true" inputId="activa"></p-checkbox>
            <label for="activa" class="ml-2 font-medium cursor-pointer select-none"
                [class.text-green-600]="programacion.activa" [class.text-500]="!programacion.activa">
                {{ programacion.activa ? 'Programación Activa' : 'Programación Inactiva' }}
            </label>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text" (click)="saveProgramacion()"
            [disabled]="!isFormValid()"></button>
    </ng-template>
</p-dialog>

<!-- Diálogo de detalle -->
<p-dialog [(visible)]="displayDetailDialog" [modal]="true" [style]="{width: '750px'}" [closable]="true"
    [showHeader]="false" class="p-fluid" [contentStyle]="{padding: '0'}">

    <ng-template pTemplate="content">
        <div *ngIf="selectedProgramacion">
            <!-- Header limpio -->
            <div class="p-4 surface-50 border-bottom-1 surface-border">
                <div class="flex justify-content-between align-items-start">
                    <div>
                        <div class="text-900 text-xl font-bold mb-2 flex align-items-center gap-2">
                            <i class="pi pi-desktop text-primary"></i>
                            {{selectedProgramacion.equipo?.nombre || 'Equipo'}}
                        </div>
                        <div class="text-600 text-sm">
                            <span class="mr-3"><i class="pi pi-hashtag mr-1"></i>{{selectedProgramacion.equipo?.codigoInacif}}</span>
                            <span><i class="pi pi-map-marker mr-1"></i>{{selectedProgramacion.equipo?.ubicacion || 'Sin ubicación'}}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <p-tag [value]="selectedProgramacion.tipoMantenimiento?.nombre" 
                               [severity]="getTipoSeverity(selectedProgramacion.tipoMantenimiento?.nombre)"
                               [style]="{fontSize: '0.85rem'}"></p-tag>
                        <p-tag [value]="selectedProgramacion.activa ? 'ACTIVA' : 'INACTIVA'" 
                               [severity]="selectedProgramacion.activa ? 'success' : 'danger'"
                               [style]="{fontSize: '0.85rem'}"></p-tag>
                    </div>
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="p-4">
                <!-- Fechas destacadas -->
                <div class="grid mb-4">
                    <div class="col-6">
                        <div class="surface-100 border-round p-3 text-center h-full">
                            <div class="text-500 text-sm mb-1">Último Mantenimiento</div>
                            <div class="text-xl font-semibold" 
                                 [ngClass]="selectedProgramacion.fechaUltimoMantenimiento ? 'text-700' : 'text-400'">
                                <i class="pi pi-history mr-2"></i>
                                {{selectedProgramacion.fechaUltimoMantenimiento ? (selectedProgramacion.fechaUltimoMantenimiento | date:'dd/MM/yyyy') : 'Sin registro'}}
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border-round p-3 text-center h-full"
                             [ngClass]="{
                                 'bg-red-100': isVencida(selectedProgramacion.fechaProximoMantenimiento),
                                 'bg-orange-100': isProxima(selectedProgramacion.fechaProximoMantenimiento) && !isVencida(selectedProgramacion.fechaProximoMantenimiento),
                                 'bg-green-100': !isProxima(selectedProgramacion.fechaProximoMantenimiento) && !isVencida(selectedProgramacion.fechaProximoMantenimiento)
                             }">
                            <div class="text-500 text-sm mb-1">Próximo Mantenimiento</div>
                            <div class="text-xl font-semibold"
                                 [ngClass]="{
                                     'text-red-700': isVencida(selectedProgramacion.fechaProximoMantenimiento),
                                     'text-orange-700': isProxima(selectedProgramacion.fechaProximoMantenimiento) && !isVencida(selectedProgramacion.fechaProximoMantenimiento),
                                     'text-green-700': !isProxima(selectedProgramacion.fechaProximoMantenimiento) && !isVencida(selectedProgramacion.fechaProximoMantenimiento)
                                 }">
                                <i class="pi pi-calendar mr-2"></i>
                                {{selectedProgramacion.fechaProximoMantenimiento ? (selectedProgramacion.fechaProximoMantenimiento | date:'dd/MM/yyyy') : 'No programado'}}
                            </div>
                            <!-- Alertas diferenciadas -->
                            <div class="flex flex-wrap justify-content-center gap-1 mt-2" *ngIf="getTipoVencimiento(selectedProgramacion)">
                                <p-tag *ngIf="isVencida(selectedProgramacion.fechaProximoMantenimiento)" 
                                       value="VENCIDA" severity="danger"></p-tag>
                            </div>
                            <p-tag *ngIf="isProxima(selectedProgramacion.fechaProximoMantenimiento) && !isVencida(selectedProgramacion.fechaProximoMantenimiento) && !isContratoVencido(selectedProgramacion)" 
                                   value="PRÓXIMA" severity="warning" class="mt-2"></p-tag>
                        </div>
                    </div>
                </div>

                <!-- Alerta de contrato vencido -->
                <div *ngIf="isContratoVencido(selectedProgramacion)" 
                     class="mt-3 p-3 border-round bg-orange-50 border-1 border-orange-300 flex align-items-center gap-3">
                    <i class="pi pi-exclamation-triangle text-orange-500 text-2xl"></i>
                    <div>
                        <div class="font-semibold text-orange-700">Contrato Vencido</div>
                        <div class="text-orange-600 text-sm">
                            El contrato asociado venció el {{selectedProgramacion.contrato?.fechaFin | date:'dd/MM/yyyy'}}. 
                            Esta programación no aparecerá en el calendario hasta que se actualice el contrato.
                        </div>
                    </div>
                </div>

                <!-- Info en dos columnas -->
                <div class="grid">
                    <!-- Columna izquierda: Programación -->
                    <div class="col-12 md:col-6">
                        <div class="text-600 font-medium mb-3 flex align-items-center">
                            <i class="pi pi-clock mr-2 text-primary"></i>Configuración
                        </div>
                        <div class="flex flex-column gap-3">
                            <div class="flex justify-content-between">
                                <span class="text-500">Frecuencia:</span>
                                <span class="font-medium" *ngIf="selectedProgramacion.frecuenciaDias === 0">
                                    <span class="text-purple-600"><i class="pi pi-calendar-times mr-1"></i>Único</span>
                                </span>
                                <span class="font-medium" *ngIf="selectedProgramacion.frecuenciaDias > 0">
                                    {{getFrecuenciaTexto(selectedProgramacion.frecuenciaDias)}}
                                </span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Alerta previa:</span>
                                <span class="font-medium">{{selectedProgramacion.diasAlertaPrevia}} días</span>
                            </div>
                        </div>
                    </div>

                    <!-- Columna derecha: Contrato -->
                    <div class="col-12 md:col-6">
                        <div class="text-600 font-medium mb-3 flex align-items-center">
                            <i class="pi pi-file mr-2 text-primary"></i>Contrato
                        </div>
                        <div class="flex flex-column gap-3">
                            <div class="flex justify-content-between">
                                <span class="text-500">Descripción:</span>
                                <span class="font-medium text-right" style="max-width: 60%">{{selectedProgramacion.contrato?.descripcion || 'N/A'}}</span>
                            </div>
                            <div class="flex justify-content-between">
                                <span class="text-500">Proveedor:</span>
                                <span class="font-medium">{{selectedProgramacion.contrato?.proveedor?.nombre || 'N/A'}}</span>
                            </div>
                            <div class="flex justify-content-between" *ngIf="selectedProgramacion.contrato?.fechaInicio">
                                <span class="text-500">Vigencia:</span>
                                <div class="text-right">
                                    <span class="font-medium text-sm" 
                                          [ngClass]="isContratoVencido(selectedProgramacion) ? 'text-orange-600' : 'text-700'">
                                        {{selectedProgramacion.contrato?.fechaInicio | date:'dd/MM/yy'}} - {{selectedProgramacion.contrato?.fechaFin | date:'dd/MM/yy'}}
                                    </span>
                                    <p-tag *ngIf="isContratoVencido(selectedProgramacion)" 
                                           value="VENCIDO" severity="warning" 
                                           [style]="{fontSize: '0.65rem'}" class="ml-1"></p-tag>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div *ngIf="selectedProgramacion.observaciones" class="mt-4 pt-3 border-top-1 surface-border">
                    <div class="text-600 font-medium mb-2 flex align-items-center">
                        <i class="pi pi-comment mr-2 text-primary"></i>Observaciones
                    </div>
                    <p class="text-700 m-0 line-height-3">{{selectedProgramacion.observaciones}}</p>
                </div>
            </div>

            <!-- Footer con acciones -->
            <div class="p-3 surface-100 border-round-bottom flex justify-content-between align-items-center">
                <button pButton pRipple label="Cerrar" icon="pi pi-times" 
                    class="p-button-text p-button-secondary"
                    (click)="displayDetailDialog = false"></button>
                <button pButton pRipple label="Ejecutar Mantenimiento" icon="pi pi-play" 
                    class="p-button-success"
                    *ngIf="selectedProgramacion.activa"
                    (click)="displayDetailDialog = false; crearMantenimiento(selectedProgramacion)"></button>
            </div>
        </div>
        <div *ngIf="!selectedProgramacion" class="text-center p-5">
            <i class="pi pi-info-circle text-4xl text-500 mb-3"></i>
            <p class="text-500">No hay información disponible</p>
        </div>
    </ng-template>
</p-dialog>

<!-- Diálogo para Reprogramar -->
<p-dialog header="Reprogramar Mantenimiento" [(visible)]="displayReprogramarDialog" [modal]="true"
    [style]="{width: '500px'}" class="p-fluid">
    
    <ng-template pTemplate="content">
        <div *ngIf="reprogramarData.programacion">
            <!-- Info del equipo -->
            <div class="surface-100 border-round p-3 mb-4">
                <div class="flex align-items-center gap-2 mb-2">
                    <i class="pi pi-desktop text-primary"></i>
                    <span class="font-semibold">{{reprogramarData.programacion.equipo?.nombre}}</span>
                </div>
                <div class="text-500 text-sm">
                    Tipo: {{reprogramarData.programacion.tipoMantenimiento?.nombre}} | 
                    Frecuencia: {{getFrecuenciaTexto(reprogramarData.programacion.frecuenciaDias)}}
                </div>
            </div>

            <!-- Fecha actual -->
            <div class="mb-4">
                <label class="block text-500 mb-2">Fecha programada actual:</label>
                <div class="font-semibold text-lg">
                    {{reprogramarData.programacion.fechaProximoMantenimiento | date:'dd/MM/yyyy'}}
                </div>
            </div>

            <!-- Nueva fecha -->
            <div class="field mb-4">
                <label for="nuevaFecha" class="block font-medium mb-2">
                    <i class="pi pi-calendar mr-1"></i>Nueva fecha *
                </label>
                <p-calendar 
                    id="nuevaFecha"
                    [(ngModel)]="reprogramarData.nuevaFecha" 
                    [inline]="true"
                    dateFormat="dd/mm/yy"
                    [style]="{width: '100%'}"
                    [monthNavigator]="true"
                    [yearNavigator]="true"
                    [yearRange]="'2020:2030'">
                </p-calendar>
                <div *ngIf="reprogramarData.nuevaFecha" class="mt-2 text-primary font-medium">
                    <i class="pi pi-check-circle mr-1"></i>
                    Fecha seleccionada: {{reprogramarData.nuevaFecha | date:'dd/MM/yyyy'}}
                </div>
            </div>

            <!-- Motivo -->
            <div class="field">
                <label for="motivoReprogramacion" class="block font-medium mb-2">
                    <i class="pi pi-comment mr-1"></i>Motivo de la reprogramación *
                </label>
                <textarea 
                    pInputTextarea 
                    id="motivoReprogramacion"
                    [(ngModel)]="reprogramarData.motivo" 
                    rows="3"
                    placeholder="Ej: Proveedor no disponible en fecha original, equipo en uso, etc."
                    [style]="{width: '100%'}">
                </textarea>
                <small class="text-500">Mínimo 5 caracteres. Este registro quedará en el historial.</small>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" 
            class="p-button-text" (click)="cancelarReprogramacion()"></button>
        <button pButton pRipple label="Reprogramar" icon="pi pi-calendar-plus" 
            class="p-button-help" (click)="confirmarReprogramacion()"
            [loading]="loading"></button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>