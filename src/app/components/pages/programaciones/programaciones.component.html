<div class="grid">
    <!-- Título y descripción -->
    <div class="col-12">
        <div class="card">
            <h5>Programaciones de Mantenimiento</h5>
            <p class="text-600 line-height-3 m-0 mb-3">Gestione las programaciones automáticas de mantenimientos
                preventivos, correctivos y calibraciones.</p>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="col-12 md:col-3">
        <div class="card bg-blue-100 border-left-3 border-blue-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-blue-600 font-medium">Total Programaciones</span>
                    <div class="text-2xl font-bold text-blue-900">{{stats.total}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-blue-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-calendar text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-green-100 border-left-3 border-green-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-green-600 font-medium">Activas</span>
                    <div class="text-2xl font-bold text-green-900">{{stats.activas}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-green-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-check-circle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-orange-100 border-left-3 border-orange-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-orange-600 font-medium">Próximas (7 días)</span>
                    <div class="text-2xl font-bold text-orange-900">{{stats.proximas}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-orange-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-clock text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 md:col-3">
        <div class="card bg-red-100 border-left-3 border-red-500">
            <div class="flex justify-content-between">
                <div>
                    <span class="text-red-600 font-medium">Vencidas</span>
                    <div class="text-2xl font-bold text-red-900">{{stats.vencidas}}</div>
                </div>
                <div class="flex align-items-center justify-content-center bg-red-500 border-circle"
                    style="width:3rem;height:3rem">
                    <i class="pi pi-exclamation-triangle text-white text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de programaciones -->
    <div class="col-12">
        <div class="card">
            <!-- Barra de herramientas -->
            <p-toolbar styleClass="mb-4">
                <ng-template pTemplate="left">
                    <button pButton pRipple label="Nueva Programación" icon="pi pi-plus" class="p-button-success mr-2"
                        (click)="openNew()"></button>
                    <button pButton pRipple label="Ver Calendario" icon="pi pi-calendar" class="p-button-outlined mr-2"
                        routerLink="/administracion/mantenimientos"
                        pTooltip="Ver programaciones y ejecuciones en calendario"></button>
                </ng-template>
                <ng-template pTemplate="right">
                    <button pButton pRipple label="Exportar CSV" icon="pi pi-download" class="p-button-help"
                        (click)="exportCSV()"></button>
                </ng-template>
            </p-toolbar>

            <p-table #dt [value]="programaciones" [loading]="loading" [paginator]="true" [rows]="10"
                [rowsPerPageOptions]="[10,20,30]" [showCurrentPageReport]="true"
                currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} programaciones"
                [globalFilterFields]="['equipo.nombre','tipoMantenimiento.nombre','contrato.descripcion']"
                [rowHover]="true" dataKey="idProgramacion">

                <ng-template pTemplate="caption">
                    <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center">
                        <h5 class="m-0">Gestión de Programaciones</h5>
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..."
                                class="w-full sm:w-auto" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th pSortableColumn="equipo.nombre">Equipo <p-sortIcon field="equipo.nombre"></p-sortIcon></th>
                        <th pSortableColumn="tipoMantenimiento.nombre">Tipo <p-sortIcon
                                field="tipoMantenimiento.nombre"></p-sortIcon></th>
                        <th pSortableColumn="contrato.descripcion">Contrato <p-sortIcon
                                field="contrato.descripcion"></p-sortIcon></th>
                        <th pSortableColumn="frecuenciaDias">Frecuencia <p-sortIcon field="frecuenciaDias"></p-sortIcon>
                        </th>
                        <th pSortableColumn="fechaProximoMantenimiento">Próximo <p-sortIcon
                                field="fechaProximoMantenimiento"></p-sortIcon></th>
                        <th pSortableColumn="activa">Estado <p-sortIcon field="activa"></p-sortIcon></th>
                        <th></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-programacion>
                    <tr>
                        <td>
                            <div class="flex align-items-center">
                                <div>
                                    <div class="font-bold">{{programacion.equipo?.nombre}}</div>
                                    <div class="text-sm text-gray-500">{{programacion.equipo?.codigoInacif}}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="programacion.tipoMantenimiento?.nombre"
                                [severity]="getTipoSeverity(programacion.tipoMantenimiento?.nombre)"
                                [rounded]="true"></p-tag>
                        </td>
                        <td>
                            <div>
                                <div class="font-medium">{{programacion.contrato?.descripcion}}</div>
                                <div class="text-sm text-gray-500">{{programacion.contrato?.proveedor?.nombre}}</div>
                            </div>
                        </td>
                        <td>
                            <span class="font-medium">{{programacion.frecuenciaDias}}</span> días
                        </td>
                        <td>
                            <div class="flex align-items-center">
                                <span [class]="getDateClass(programacion.fechaProximoMantenimiento)">
                                    {{programacion.fechaProximoMantenimiento | date:'dd/MM/yyyy'}}
                                </span>
                                <p-tag *ngIf="isVencida(programacion.fechaProximoMantenimiento)" value="VENCIDA"
                                    severity="danger" class="ml-2"></p-tag>
                                <p-tag
                                    *ngIf="isProxima(programacion.fechaProximoMantenimiento) && !isVencida(programacion.fechaProximoMantenimiento)"
                                    value="PRÓXIMA" severity="warning" class="ml-2"></p-tag>
                            </div>
                        </td>
                        <td>
                            <p-tag [value]="programacion.activa ? 'Activa' : 'Inactiva'"
                                [severity]="programacion.activa ? 'success' : 'secondary'" [rounded]="true"></p-tag>
                        </td>
                        <td>
                            <div class="flex flex-nowrap gap-0">
                                <button pButton pRipple icon="pi pi-eye"
                                    class="p-button-text p-button-info p-button-sm"
                                    (click)="verDetalle(programacion)" pTooltip="Ver detalle"></button>
                                <button pButton pRipple icon="pi pi-pencil"
                                    class="p-button-text p-button-warning p-button-sm"
                                    (click)="editProgramacion(programacion)" pTooltip="Editar"></button>
                                <button pButton pRipple icon="pi pi-calendar-plus"
                                    class="p-button-text p-button-success p-button-sm"
                                    (click)="crearMantenimiento(programacion)" pTooltip="Crear ejecución"
                                    [disabled]="!programacion.activa"></button>
                                <button pButton pRipple [icon]="programacion.activa ? 'pi pi-pause' : 'pi pi-play'"
                                    [class]="programacion.activa ? 'p-button-text p-button-secondary p-button-sm' : 'p-button-text p-button-success p-button-sm'"
                                    (click)="toggleActiva(programacion)"
                                    [pTooltip]="programacion.activa ? 'Pausar (ocultar del calendario)' : 'Activar (mostrar en calendario)'"></button>
                                <button pButton pRipple icon="pi pi-trash"
                                    class="p-button-text p-button-danger p-button-sm"
                                    (click)="deleteProgramacion(programacion)" pTooltip="Eliminar"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>


<!-- Diálogo para crear/editar programación -->
<p-dialog [header]="isEditing ? 'Editar Programación' : 'Nueva Programación'" [(visible)]="displayDialog" [modal]="true"
    [style]="{width: '700px'}" [maximizable]="true" class="p-fluid">

    <ng-template pTemplate="content">
        <!-- Sección: Datos Generales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-box mr-2"></i>Datos Generales
        </div>

        <div class="formgrid grid">
            <!-- Equipo -->
            <div class="field col-12 md:col-6">
                <label for="equipo" class="font-medium">Equipo <span class="text-red-500">*</span></label>
                <p-dropdown id="equipo" [(ngModel)]="programacion.equipoId" [options]="equipos" optionLabel="nombre"
                    optionValue="idEquipo" placeholder="Seleccionar equipo" [filter]="true"
                    filterBy="nombre,codigoInacif" [showClear]="true" required styleClass="w-full"
                    (onChange)="onEquipoChange()">
                    <ng-template pTemplate="selectedItem" let-selectedEquipo>
                        <div class="flex align-items-center" *ngIf="selectedEquipo">
                            <i class="pi pi-cog mr-2 text-primary"></i>
                            <div>{{selectedEquipo.nombre}} <span
                                    class="text-500">({{selectedEquipo.codigoInacif}})</span></div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-equipo>
                        <div class="flex align-items-center">
                            <div>
                                <div class="font-bold">{{equipo.nombre}}</div>
                                <div class="text-sm text-gray-500">Código: {{equipo.codigoInacif}}</div>
                            </div>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Tipo de Mantenimiento -->
            <div class="field col-12 md:col-6">
                <label for="tipoMantenimiento" class="font-medium">Tipo de Mantenimiento <span
                        class="text-red-500">*</span></label>
                <p-dropdown id="tipoMantenimiento" [(ngModel)]="programacion.tipoMantenimientoId"
                    [options]="tiposMantenimiento" optionLabel="nombre" optionValue="idTipo"
                    placeholder="Seleccionar tipo" [showClear]="true" required styleClass="w-full"
                    (onChange)="onTipoChange()">
                    <ng-template pTemplate="selectedItem" let-selected>
                        <div class="flex align-items-center" *ngIf="selected">
                            <i class="pi pi-wrench mr-2 text-orange-500"></i>
                            <div>{{selected.nombre}}</div>
                        </div>
                    </ng-template>
                </p-dropdown>
            </div>

            <!-- Contrato -->
            <div class="field col-12">
                <label for="contrato" class="font-medium">
                    Contrato <span class="text-red-500">*</span>
                    <span *ngIf="isEditing && contratosDisponibles.length > 0 && contratosDisponibles[0].noVigente" 
                          class="ml-2 text-orange-500 text-sm">
                        <i class="pi pi-exclamation-triangle"></i> El contrato actual ya no está vigente
                    </span>
                </label>
                <p-dropdown id="contrato" [(ngModel)]="programacion.contratoId" [options]="contratosDisponibles"
                    optionLabel="descripcionCompleta" optionValue="idContrato" placeholder="Seleccionar contrato"
                    [filter]="true" filterBy="descripcion,proveedorNombre" [showClear]="true" required
                    styleClass="w-full">
                    <ng-template pTemplate="selectedItem" let-selectedContrato>
                        <div class="flex align-items-center" *ngIf="selectedContrato">
                            <i class="pi mr-2" [ngClass]="selectedContrato.noVigente ? 'pi-exclamation-triangle text-orange-500' : 'pi-file-o text-blue-500'"></i>
                            <div>
                                <span class="font-bold" [ngClass]="{'text-orange-600': selectedContrato.noVigente}">
                                    {{selectedContrato.descripcion}}
                                </span>
                                <span class="text-500 mx-2">|</span>
                                <span class="text-sm">{{selectedContrato.proveedorNombre}}</span>
                                <p-tag *ngIf="selectedContrato.noVigente" value="NO VIGENTE" severity="warning" class="ml-2"></p-tag>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="item" let-contrato>
                        <div class="flex align-items-center border-bottom-1 surface-border pb-2" 
                             [ngClass]="{'surface-200': contrato.noVigente}">
                            <div class="flex-1">
                                <div class="flex align-items-center gap-2">
                                    <span class="font-bold" [ngClass]="contrato.noVigente ? 'text-orange-600' : 'text-900'">
                                        {{contrato.descripcion}}
                                    </span>
                                    <p-tag *ngIf="contrato.noVigente" value="NO VIGENTE" severity="warning" [style]="{fontSize: '0.7rem'}"></p-tag>
                                    <p-tag *ngIf="contrato.esContratoActual && !contrato.noVigente" value="ACTUAL" severity="success" [style]="{fontSize: '0.7rem'}"></p-tag>
                                </div>
                                <div class="text-sm text-600 mb-1"><i class="pi pi-building mr-1"></i>{{contrato.proveedorNombre}}</div>
                                <div class="text-xs text-500">
                                    <i class="pi pi-calendar mr-1"></i>
                                    {{contrato.fechaInicio | date:'dd/MM/yyyy'}} - {{contrato.fechaFin | date:'dd/MM/yyyy'}}
                                </div>
                            </div>
                        </div>
                    </ng-template>
                </p-dropdown>
                <small class="text-500"
                    *ngIf="contratosDisponibles.length === 0 && programacion.equipoId && programacion.tipoMantenimientoId">
                    No hay contratos vigentes que cubran este equipo y tipo de mantenimiento
                </small>
                <small class="text-orange-500" *ngIf="isEditing && contratosDisponibles.length > 0 && contratosDisponibles[0].noVigente">
                    <i class="pi pi-info-circle mr-1"></i>
                    Se recomienda seleccionar un contrato vigente para continuar recibiendo servicios de mantenimiento.
                </small>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Sección: Planificación -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-calendar-plus mr-2"></i>Planificación
        </div>

        <div class="formgrid grid">
            <!-- Frecuencia -->
            <div class="field col-12 md:col-6">
                <label for="frecuencia" class="font-medium">Frecuencia <span class="text-red-500">*</span></label>
                <div class="p-inputgroup mb-2">
                    <p-inputNumber id="frecuencia" [(ngModel)]="programacion.frecuenciaDias" mode="decimal" [min]="1"
                        [max]="365" placeholder="30" required class="w-full" (onInput)="calcularProximaFecha()">
                    </p-inputNumber>
                    <span class="p-inputgroup-addon">días</span>
                </div>
                <!-- Botones rápidos para frecuencias comunes -->
                <div class="flex flex-wrap gap-2">
                    <button pButton type="button" label="Mensual" class="p-button-sm p-button-outlined"
                        (click)="setFrecuencia(30)" pTooltip="30 días"></button>
                    <button pButton type="button" label="Bimestral" class="p-button-sm p-button-outlined"
                        (click)="setFrecuencia(60)" pTooltip="60 días"></button>
                    <button pButton type="button" label="Trimestral" class="p-button-sm p-button-outlined"
                        (click)="setFrecuencia(90)" pTooltip="90 días"></button>
                    <button pButton type="button" label="Semestral" class="p-button-sm p-button-outlined"
                        (click)="setFrecuencia(180)" pTooltip="180 días"></button>
                    <button pButton type="button" label="Anual" class="p-button-sm p-button-outlined"
                        (click)="setFrecuencia(365)" pTooltip="365 días"></button>
                </div>
            </div>

            <!-- Días de alerta previa -->
            <div class="field col-12 md:col-6">
                <label for="diasAlerta" class="font-medium">Alerta Previa <span class="text-red-500">*</span></label>
                <div class="p-inputgroup">
                    <span class="p-inputgroup-addon"><i class="pi pi-bell text-orange-500"></i></span>
                    <p-inputNumber id="diasAlerta" [(ngModel)]="programacion.diasAlertaPrevia" mode="decimal" [min]="1"
                        [max]="30" placeholder="7" required class="w-full">
                    </p-inputNumber>
                    <span class="p-inputgroup-addon">días</span>
                </div>
            </div>

            <!-- Fecha del último mantenimiento -->
            <div class="field col-12 md:col-6">
                <label for="fechaUltimo" class="font-medium">Último Mantenimiento</label>
                <p-calendar id="fechaUltimo" [(ngModel)]="programacion.fechaUltimoMantenimiento" dateFormat="dd/mm/yy"
                    [showIcon]="true" placeholder="Seleccionar fecha" (onSelect)="calcularProximaFecha()"
                    styleClass="w-full">
                </p-calendar>
                <small class="text-500 flex align-items-center mt-1">
                    <i class="pi pi-info-circle mr-1 text-xs"></i> 
                    Si no ingresa fecha, se usará HOY como referencia
                </small>
            </div>

            <!-- Fecha próximo mantenimiento (calculada) -->
            <div class="field col-12 md:col-6">
                <label for="fechaProximo" class="font-medium">Próximo Mantenimiento</label>
                <p-calendar id="fechaProximo" [(ngModel)]="programacion.fechaProximoMantenimiento" dateFormat="dd/mm/yy"
                    [showIcon]="true" placeholder="Calculado automáticamente" [readonly]="true"
                    [inputStyle]="{'background-color': '#f8f9fa', 'cursor': 'default'}" styleClass="w-full">
                </p-calendar>
                <small class="text-500 flex align-items-center mt-1">
                    <i class="pi pi-info-circle mr-1 text-xs"></i> Se calcula según la frecuencia
                </small>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Sección: Detalles Finales -->
        <div class="text-primary font-bold text-lg mb-3 flex align-items-center">
            <i class="pi pi-list mr-2"></i>Detalles Finales
        </div>

        <div class="field">
            <label for="observaciones" class="font-medium">Observaciones</label>
            <textarea pInputTextarea id="observaciones" [(ngModel)]="programacion.observaciones" rows="3"
                placeholder="Ingrese cualquier observación o nota adicional..." [autoResize]="true" class="w-full">
            </textarea>
        </div>

        <div class="field flex align-items-center mt-3">
            <p-checkbox [(ngModel)]="programacion.activa" binary="true" inputId="activa"></p-checkbox>
            <label for="activa" class="ml-2 font-medium cursor-pointer select-none"
                [class.text-green-600]="programacion.activa" [class.text-500]="!programacion.activa">
                {{ programacion.activa ? 'Programación Activa' : 'Programación Inactiva' }}
            </label>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cancelar" icon="pi pi-times" class="p-button-text"
            (click)="hideDialog()"></button>
        <button pButton pRipple label="Guardar" icon="pi pi-check" class="p-button-text" (click)="saveProgramacion()"
            [disabled]="!isFormValid()"></button>
    </ng-template>
</p-dialog>

<!-- Diálogo de detalle -->
<p-dialog header="Detalle de Programación" [(visible)]="displayDetailDialog" [modal]="true" [style]="{width: '650px'}"
    class="p-fluid">

    <ng-template pTemplate="content">
        <div class="grid" *ngIf="selectedProgramacion">
            <div class="col-12 md:col-6">
                <div class="surface-card p-3 border-round shadow-1 mb-3">
                    <h6 class="text-primary flex align-items-center mb-3">
                        <i class="pi pi-cog mr-2"></i>Información del Equipo
                    </h6>
                    <p class="mb-2"><strong>Nombre:</strong> {{selectedProgramacion.equipo?.nombre || 'N/A'}}</p>
                    <p class="mb-2"><strong>Código:</strong> {{selectedProgramacion.equipo?.codigoInacif || 'N/A'}}</p>
                    <p class="mb-0"><strong>Ubicación:</strong> {{selectedProgramacion.equipo?.ubicacion || 'N/A'}}</p>
                </div>
            </div>
            <div class="col-12 md:col-6">
                <div class="surface-card p-3 border-round shadow-1 mb-3">
                    <h6 class="text-primary flex align-items-center mb-3">
                        <i class="pi pi-file mr-2"></i>Información del Contrato
                    </h6>
                    <p class="mb-2"><strong>Descripción:</strong> {{selectedProgramacion.contrato?.descripcion || 'N/A'}}</p>
                    <p class="mb-2"><strong>Proveedor:</strong> {{selectedProgramacion.contrato?.proveedor?.nombre || 'N/A'}}</p>
                    <p class="mb-0"><strong>Vigencia:</strong> 
                        <span *ngIf="selectedProgramacion.contrato?.fechaInicio">
                            {{selectedProgramacion.contrato?.fechaInicio | date:'dd/MM/yyyy'}} - {{selectedProgramacion.contrato?.fechaFin | date:'dd/MM/yyyy'}}
                        </span>
                        <span *ngIf="!selectedProgramacion.contrato?.fechaInicio">N/A</span>
                    </p>
                </div>
            </div>
            <div class="col-12">
                <div class="surface-card p-3 border-round shadow-1">
                    <h6 class="text-primary flex align-items-center mb-3">
                        <i class="pi pi-calendar mr-2"></i>Datos de Programación
                    </h6>
                    <div class="grid">
                        <div class="col-12 md:col-6">
                            <p class="mb-2"><strong>Tipo:</strong> {{selectedProgramacion.tipoMantenimiento?.nombre || 'N/A'}}</p>
                            <p class="mb-2"><strong>Frecuencia:</strong> {{selectedProgramacion.frecuenciaDias}} días</p>
                            <p class="mb-2"><strong>Días de alerta:</strong> {{selectedProgramacion.diasAlertaPrevia}} días</p>
                        </div>
                        <div class="col-12 md:col-6">
                            <p class="mb-2"><strong>Último mantenimiento:</strong> 
                                <span *ngIf="selectedProgramacion.fechaUltimoMantenimiento">{{selectedProgramacion.fechaUltimoMantenimiento | date:'dd/MM/yyyy'}}</span>
                                <span *ngIf="!selectedProgramacion.fechaUltimoMantenimiento">No registrado</span>
                            </p>
                            <p class="mb-2"><strong>Próximo mantenimiento:</strong> 
                                <span *ngIf="selectedProgramacion.fechaProximoMantenimiento">{{selectedProgramacion.fechaProximoMantenimiento | date:'dd/MM/yyyy'}}</span>
                                <span *ngIf="!selectedProgramacion.fechaProximoMantenimiento">No programado</span>
                            </p>
                            <p class="mb-2"><strong>Estado:</strong> 
                                <p-tag [value]="selectedProgramacion.activa ? 'Activa' : 'Inactiva'" 
                                       [severity]="selectedProgramacion.activa ? 'success' : 'danger'"></p-tag>
                            </p>
                        </div>
                        <div class="col-12" *ngIf="selectedProgramacion.observaciones">
                            <p class="mb-0"><strong>Observaciones:</strong> {{selectedProgramacion.observaciones}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div *ngIf="!selectedProgramacion" class="text-center p-4">
            <i class="pi pi-info-circle text-4xl text-500 mb-3"></i>
            <p class="text-500">No hay información disponible</p>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Cerrar" icon="pi pi-times" class="p-button-text"
            (click)="displayDetailDialog = false"></button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>